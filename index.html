<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุชุทุจูู ูุฒุนุฉ - ููุชูุตูู ุงูุณุฑูุน</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap');
        body { font-family: 'Tajawal', sans-serif; background-color: #f3f4f6; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes pulse-red { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239,68,68,0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(239,68,68,0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239,68,68,0); } }
        .blinking-alert { animation: pulse-red 2s infinite; }
        
        .toggle-checkbox:checked { right: 0; border-color: #10B981; }
        .toggle-checkbox:checked + .toggle-label { background-color: #10B981; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #f97316; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .chat-me { background-color: #e0e7ff; color: #1e40af; border-radius: 1rem 1rem 0 1rem; align-self: flex-end; }
        .chat-other { background-color: #f3f4f6; color: #374151; border-radius: 1rem 1rem 1rem 0; align-self: flex-start; }
        
        .nav-active { color: #4f46e5 !important; font-weight: 900; }
        .nav-active i { transform: translateY(-3px) scale(1.1); transition: all 0.2s; color: #4f46e5; }
        .star-rating i { cursor: pointer; color: #d1d5db; transition: color 0.2s; }
        .star-rating i.active { color: #fbbf24; }
        
        .file-upload-btn { position: relative; overflow: hidden; display: inline-block; }
        .file-upload-btn input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; }
        
        /* Flash Sale Animation */
        @keyframes flashText { 0% { color: #ef4444; } 50% { color: #f97316; } 100% { color: #ef4444; } }
        .flash-text { animation: flashText 1.5s infinite; }
    </style>
</head>
<body class="text-gray-800 antialiased flex justify-center h-screen overflow-hidden">

    <!-- ุดุงุดุฉ ุงูุชุญููู ุงูุงุจุชุฏุงุฆูุฉ ูููุน ุงูุฃุฎุทุงุก -->
    <div id="initial-loader" class="fixed inset-0 bg-indigo-900 z-[9999] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center text-4xl mb-4 shadow-2xl relative">
            <i class="fa-solid fa-rocket text-orange-500 animate-bounce mt-2"></i>
            <div class="absolute inset-0 border-4 border-indigo-200 border-t-orange-500 rounded-full animate-spin"></div>
        </div>
        <h1 class="text-2xl font-black text-white mb-2 tracking-wide">ูุฒุนููุฉ</h1>
        <p class="text-indigo-200 text-sm font-medium" id="loader-text">ุฌุงุฑู ุชููุฆุฉ ุงููุธุงู...</p>
    </div>

    <div class="w-full max-w-md h-full bg-gray-50 flex flex-col relative shadow-2xl overflow-hidden border-x border-gray-200">
        
        <!-- Toast -->
        <div id="toast" class="absolute top-4 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-5 py-3 rounded-2xl shadow-2xl transition-all duration-300 opacity-0 z-[100] pointer-events-none flex flex-col items-center gap-2 text-sm font-bold min-w-[250px] text-center">
            <div class="flex items-center gap-3"><span id="toast-icon" class="text-xl"></span><span id="toast-msg"></span></div>
            <img id="toast-img" class="w-full h-24 object-cover rounded-lg hidden mt-1" src="" alt="Notification Image">
        </div>

        <!-- ==================== Login ==================== -->
        <div id="view-login" class="flex flex-col h-full bg-white relative overflow-y-auto hide-scrollbar hidden">
            <div class="absolute top-0 w-full h-1/2 bg-gradient-to-br from-indigo-900 to-blue-800 rounded-b-[4rem] shadow-inner"></div>
            
            <div class="flex-1 flex flex-col items-center pt-16 px-8 relative z-10">
                <div id="app-logo-container" class="w-28 h-28 bg-white text-indigo-900 rounded-full flex items-center justify-center text-5xl mb-4 shadow-2xl border-4 border-indigo-100 overflow-hidden">
                    <i class="fa-solid fa-rocket text-orange-500"></i>
                </div>
                <h1 id="app-name-display-1" class="text-3xl font-black text-white mb-1 tracking-wide">ูุฒุนููุฉ</h1>
                <p class="text-indigo-200 mb-10 text-center text-sm font-medium">ุงูุฃุณุฑุน ูู ุงูููุฑู ูุจูุนูุง</p>
                
                <div class="w-full bg-white rounded-3xl shadow-xl p-6 border border-gray-100">
                    <div class="flex w-full bg-gray-100 rounded-xl p-1 mb-6">
                        <button id="tab-customer" onclick="window.switchLoginTab('customer')" class="flex-1 py-2 text-sm font-bold bg-white shadow rounded-lg text-indigo-700 transition-all">ุงูุฒุจุงุฆู</button>
                        <button id="tab-staff" onclick="window.switchLoginTab('staff')" class="flex-1 py-2 text-sm font-bold text-gray-500 rounded-lg transition-all">ูุฑูู ุงูุนูู</button>
                    </div>

                    <div id="form-customer" class="w-full space-y-4">
                        <div class="relative"><i class="fa-solid fa-phone absolute right-4 top-3.5 text-gray-400"></i><input type="tel" id="login-phone" class="w-full pr-10 pl-4 py-3 rounded-xl border border-gray-200 focus:border-indigo-500 outline-none" placeholder="ุฑูู ุงููุงุชู"></div>
                        <div class="relative"><i class="fa-solid fa-lock absolute right-4 top-3.5 text-gray-400"></i><input type="password" id="login-password" class="w-full pr-10 pl-4 py-3 rounded-xl border border-gray-200 focus:border-indigo-500 outline-none" placeholder="ูููุฉ ุงููุฑูุฑ"></div>
                        <button onclick="window.loginCustomer()" class="w-full bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 text-white font-bold py-3.5 rounded-xl shadow-lg mt-2 flex justify-center"><span id="login-btn-text">ุฏุฎูู</span></button>
                        <p class="text-center text-sm mt-4 text-gray-500 font-medium">ุฌุฏูุฏ ูุนูุงุ <button onclick="window.showView('signup')" class="text-indigo-600 font-bold hover:underline">ุฅูุดุงุก ุญุณุงุจ</button></p>
                    </div>

                    <div id="form-staff" class="w-full space-y-4 hidden">
                        <select id="login-staff-role" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-indigo-500 outline-none text-sm">
                            <option value="admin">ุฅุฏุงุฑุฉ ุงูุชุทุจูู ๐ก๏ธ</option>
                            <option value="merchant">ูุชุฌุฑ / ูุทุนู ๐ช</option>
                            <option value="captain">ูุงุจุชู ุชูุตูู ๐ต</option>
                            <option value="support">ุฏุนู ููู ๐ง</option>
                        </select>
                        <input type="text" id="login-staff-worknum" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-indigo-500 outline-none text-sm" placeholder="ุงููุนุฑู (ID)">
                        <input type="password" id="login-staff-password" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-indigo-500 outline-none text-sm" placeholder="ูููุฉ ุงููุฑูุฑ">
                        <button onclick="window.loginStaff()" class="w-full bg-gray-900 hover:bg-black text-white font-bold py-3.5 rounded-xl shadow-lg mt-2 flex justify-center"><span id="login-staff-btn-text">ุฏุฎูู ูููุธุงู</span></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== Signup ==================== -->
        <div id="view-signup" class="hidden flex-col h-full bg-white relative overflow-y-auto hide-scrollbar">
            <div class="p-6 pb-2 flex items-center"><button onclick="window.showView('login')" class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-gray-600 hover:bg-gray-200 transition-colors"><i class="fa-solid fa-arrow-right"></i></button></div>
            <div class="px-8 pb-8 flex-1">
                <h2 class="text-3xl font-black text-indigo-900 mb-1">ูุฑุญุจุงู ุจู!</h2>
                <p class="text-gray-500 mb-8 text-sm font-medium">ุณุฌู ุจูุงูุงุชู ููุจุฏุก ุจุงูุทูุจ ููุณุจ ุงูููุงุท</p>
                <div class="space-y-4">
                    <input type="text" id="reg-name" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-orange-500 outline-none text-sm" placeholder="ุงูุงุณู ุงููุงูู">
                    <input type="tel" id="reg-phone" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-orange-500 outline-none text-sm" placeholder="ุฑูู ุงููุงุชู (07XXXXXXXX)">
                    <div class="flex gap-2">
                        <input type="text" id="reg-location" class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-gray-50 outline-none text-xs text-gray-500" placeholder="ุงููููุน (GPS)..." readonly>
                        <button onclick="window.getLocation()" class="bg-indigo-600 text-white px-5 rounded-xl shadow-md hover:bg-indigo-700 transition-colors"><i class="fa-solid fa-location-crosshairs"></i></button>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="password" id="reg-password" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-orange-500 outline-none text-sm" placeholder="ูููุฉ ุงููุฑูุฑ">
                        <input type="password" id="reg-confirm" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-orange-500 outline-none text-sm" placeholder="ุชุฃููุฏ ุงููููุฉ">
                    </div>
                    <button onclick="window.registerCustomer()" class="w-full bg-gradient-to-r from-orange-500 to-orange-600 text-white font-bold py-3.5 rounded-xl shadow-lg mt-6 flex justify-center"><span id="reg-btn-text">ุฅูุดุงุก ุงูุญุณุงุจ</span></button>
                </div>
            </div>
        </div>

        <!-- ==================== ูุงุฌูุฉ ุงูุฒุจูู (Customer) ==================== -->
        <div id="view-customer" class="hidden flex-col h-full bg-gray-50 pb-[70px] relative">
            <div class="bg-indigo-900 text-white p-6 rounded-b-[2rem] shadow-lg z-10 relative overflow-hidden shrink-0">
                <div class="absolute -right-10 -top-10 w-32 h-32 bg-white/5 rounded-full blur-2xl"></div>
                <div class="flex justify-between items-center mb-4 relative z-10">
                    <div>
                        <p class="text-xs text-indigo-300 mb-1">ูุฑุญุจุงู ุจู ูู <span id="app-name-display-2">ูุฒุนููุฉ</span>ุ</p>
                        <h2 id="cust-name-display" class="text-xl font-black tracking-wide">ุงูุฒุจูู</h2>
                    </div>
                    <button onclick="window.openNotificationsModal()" class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center relative hover:bg-white/20 transition-colors">
                        <i class="fa-solid fa-bell text-sm"></i>
                        <span id="cust-notif-badge" class="hidden absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full"></span>
                    </button>
                </div>
                <div class="bg-indigo-800/50 p-2.5 rounded-xl text-xs font-medium flex items-center justify-between border border-indigo-700/50 relative z-10">
                    <div class="flex items-center gap-2 truncate"><i class="fa-solid fa-location-dot text-orange-400"></i><span id="cust-loc-display" class="truncate">ุฌุงุฑู ุงูุชุญุฏูุฏ...</span></div>
                    <div class="bg-yellow-400 text-yellow-900 px-2 py-1 rounded font-bold whitespace-nowrap"><i class="fa-solid fa-star text-[10px]"></i> <span id="cust-points-display">0</span> ููุทุฉ</div>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-5 hide-scrollbar">
                
                <div id="cust-tab-home" class="space-y-6 block">
                    <!-- ุงููุณุงุนุฏ ุงูุฐูู -->
                    <div class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-2xl p-4 text-white shadow-lg relative overflow-hidden mb-2">
                        <div class="absolute -left-4 -top-4 text-white/10 text-6xl"><i class="fa-solid fa-brain"></i></div>
                        <h3 class="font-black text-lg mb-2 relative z-10">โจ ูุญุชุงุฑ ุดู ุชุทูุจุ</h3>
                        <p class="text-xs text-purple-100 mb-3 relative z-10">ุงุณุฃู ุงููุณุงุนุฏ ุงูุฐูู ูููุชุฑุญ ูู ูุฌุจุฉ!</p>
                        <div class="flex gap-2 relative z-10">
                            <input type="text" id="ai-food-query" class="flex-1 px-3 py-2 rounded-xl text-gray-800 text-sm outline-none" placeholder="ูุซุงู: ุนุจุงูู ุฅุดู ุฏุณู ูุฑุฎูุต...">
                            <button onclick="window.askAIFood()" id="ai-food-btn" class="bg-white text-purple-600 px-4 py-2 rounded-xl text-sm font-bold shadow hover:bg-gray-50 transition-colors">ุงุณุฃู</button>
                        </div>
                        <div id="ai-food-result" class="mt-3 text-sm font-bold bg-white/20 p-3 rounded-xl hidden relative z-10 leading-relaxed"></div>
                    </div>

                    <!-- ุงูุจุญุซ ูุงูููุชุฑุฉ -->
                    <div class="flex gap-2 mb-2">
                        <div class="relative flex-1">
                            <i class="fa-solid fa-magnifying-glass absolute right-3 top-3 text-gray-400"></i>
                            <input type="text" id="cust-search" onkeyup="window.renderCustomer()" class="w-full pr-9 pl-3 py-2.5 rounded-xl border border-gray-200 text-sm outline-none focus:border-indigo-500 shadow-sm" placeholder="ุงุจุญุซ ุนู ูุชุฌุฑุ ูุฌุจุฉ...">
                        </div>
                        <select id="cust-sort" onchange="window.renderCustomer()" class="w-1/3 px-2 py-2.5 rounded-xl border border-gray-200 text-[10px] outline-none bg-white shadow-sm font-bold text-gray-600">
                            <option value="none">ุงูุชุฑุชูุจ</option>
                            <option value="asc">ุงูุฃูู ุณุนุฑุงู</option>
                            <option value="desc">ุงูุฃุนูู ุณุนุฑุงู</option>
                        </select>
                    </div>

                    <div onclick="window.openCustomOrderModal()" class="bg-gradient-to-r from-orange-500 to-amber-500 rounded-2xl p-4 text-white shadow-lg relative overflow-hidden cursor-pointer hover:shadow-xl transition-shadow mb-4">
                        <div class="absolute -right-4 -bottom-4 text-white/20 text-6xl"><i class="fa-solid fa-motorcycle"></i></div>
                        <h3 class="font-black text-lg mb-1 relative z-10">ุชูุตูู ูู ุฃู ููุงู!</h3>
                        <p class="text-[11px] font-medium text-orange-100 relative z-10">ุฃุฏุฎู ุงุณู ุงููุชุฌุฑุ ููุงุจุชู ูุฒุนุฉ ุจูุฌูุจูู ุฅูุงู ููุจุงุจ.</p>
                    </div>

                    <!-- ุงูุฃูุซุฑ ูุจูุนุงู (Best Sellers) -->
                    <div id="best-sellers-container" class="mb-6">
                        <h3 class="font-black text-gray-800 text-sm mb-3"><i class="fa-solid fa-fire text-orange-500"></i> ุงูุฃูุซุฑ ูุจูุนุงู ุงูููู ๐ฅ</h3>
                        <div class="flex gap-3 overflow-x-auto hide-scrollbar pb-2" id="best-sellers-list">
                            <!-- ุณูุชู ุญููู ุชููุงุฆูุงู ูู ุงููุจูุนุงุช ุฅุฐุง ุชููุฑุช ุจูุงูุงุช -->
                            <p class="text-xs text-gray-400 w-full text-center">ุชุฑูุจูุง ุฃูุถู ุงูููุชุฌุงุช</p>
                        </div>
                    </div>

                    <div id="cust-stores-view" class="block">
                        <div class="flex justify-between items-center mb-3"><h3 class="font-bold text-gray-800 text-lg">ุงูุฃูุณุงู ูุงููุชุงุฌุฑ</h3></div>
                        <div class="flex gap-2 overflow-x-auto hide-scrollbar mb-4 pb-1">
                            <button onclick="window.setCustCategory('all')" id="btn-cat-all" class="cat-btn px-4 py-2 rounded-xl text-xs font-bold bg-indigo-600 text-white shadow-md whitespace-nowrap transition-colors">ุงููู</button>
                            <button onclick="window.setCustCategory('restaurant')" id="btn-cat-restaurant" class="cat-btn px-4 py-2 rounded-xl text-xs font-bold bg-white text-gray-600 border shadow-sm whitespace-nowrap transition-colors">๐ ูุทุงุนู</button>
                            <button onclick="window.setCustCategory('market')" id="btn-cat-market" class="cat-btn px-4 py-2 rounded-xl text-xs font-bold bg-white text-gray-600 border shadow-sm whitespace-nowrap transition-colors">๐ ูุงุฑูุช ูููุงุถู</button>
                            <button onclick="window.setCustCategory('pharmacy')" id="btn-cat-pharmacy" class="cat-btn px-4 py-2 rounded-xl text-xs font-bold bg-white text-gray-600 border shadow-sm whitespace-nowrap transition-colors">๐ ุตูุฏููุงุช</button>
                            <button onclick="window.setCustCategory('school')" id="btn-cat-school" class="cat-btn px-4 py-2 rounded-xl text-xs font-bold bg-white text-gray-600 border shadow-sm whitespace-nowrap transition-colors">๐ ูุฏุงุฑุณ/ุฌุงูุนุงุช</button>
                            <button onclick="window.setCustCategory('productive')" id="btn-cat-productive" class="cat-btn px-4 py-2 rounded-xl text-xs font-bold bg-white text-gray-600 border shadow-sm whitespace-nowrap transition-colors">๐ก ุฃุณุฑ ููุชุฌุฉ</button>
                            <button onclick="window.setCustCategory('gas')" id="btn-cat-gas" class="cat-btn px-4 py-2 rounded-xl text-xs font-bold bg-white text-gray-600 border shadow-sm whitespace-nowrap transition-colors">๐ฅ ูุฒุนุฉ ุบุงุฒ</button>
                        </div>
                        
                        <!-- ุนุฑูุถ ุงูููุงุด -->
                        <div id="flash-sales-container" class="mb-6 hidden">
                            <h3 class="font-black text-red-500 text-sm mb-3 flash-text"><i class="fa-solid fa-bolt"></i> ุนุฑูุถ ุงูููุงุด (ุชุฎููุถุงุช ุณุฑูุนุฉ)</h3>
                            <div class="flex gap-3 overflow-x-auto hide-scrollbar pb-2" id="flash-sales-list"></div>
                        </div>

                        <!-- ูุงุฆูุฉ ุงููุชุงุฌุฑ -->
                        <div id="customer-stores-list" class="grid grid-cols-2 gap-4"></div>
                    </div>
                    
                    <div id="cust-menu-view" class="hidden">
                        <button onclick="window.closeStoreMenu()" class="mb-4 bg-white text-gray-600 border border-gray-200 px-4 py-2 rounded-xl text-xs font-bold shadow-sm hover:bg-gray-50"><i class="fa-solid fa-arrow-right ml-1"></i> ุงูุนูุฏุฉ ูููุชุงุฌุฑ</button>
                        <h3 class="font-black text-xl text-gray-800 mb-4" id="store-menu-title">ูุงุฆูุฉ ุงููุชุฌุฑ</h3>
                        <div id="customer-menu-items-list" class="space-y-6"></div>
                    </div>
                </div>

                <div id="cust-tab-cart" class="hidden space-y-6">
                    <div>
                        <h3 class="font-bold text-gray-800 mb-3 text-lg border-b border-gray-200 pb-2 flex items-center gap-2"><i class="fa-solid fa-cart-shopping text-indigo-500"></i> ุณูุฉ ุงููุดุชุฑูุงุช</h3>
                        <div id="real-cart-list" class="space-y-3 mb-4"></div>
                        <button id="btn-go-checkout" onclick="window.openCheckout()" class="w-full bg-indigo-600 text-white font-black py-3 rounded-xl shadow-lg hidden">ูุชุงุจุนุฉ ุงูุฏูุน <i class="fa-solid fa-arrow-left mr-1"></i></button>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-800 mb-3 text-lg border-b border-gray-200 pb-2 flex items-center gap-2 mt-6"><i class="fa-solid fa-clock-rotate-left text-indigo-500"></i> ุทูุจุงุชู ูุชุชุจุน ุงููุงุจุชู</h3>
                        <div id="customer-orders-list" class="space-y-4"></div>
                    </div>
                </div>

                <div id="cust-tab-profile" class="hidden space-y-4">
                    <h3 class="font-bold text-gray-800 mb-3 text-lg border-b border-gray-200 pb-2">ุญุณุงุจู</h3>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 space-y-3 relative overflow-hidden">
                        <div class="absolute -left-6 -top-6 w-24 h-24 bg-indigo-50 rounded-full z-0"></div>
                        <div class="flex items-center gap-3 relative z-10"><div class="w-12 h-12 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center text-xl"><i class="fa-solid fa-user"></i></div><div><p class="font-bold text-gray-800" id="prof-name">ุงูุงุณู</p><p class="text-xs text-gray-500" id="prof-phone">ุงููุงุชู</p></div></div>
                        <div class="bg-gray-50 p-3 rounded-xl flex items-center gap-2 text-sm text-gray-600 border border-gray-100 relative z-10"><i class="fa-solid fa-location-dot text-red-500"></i> <span id="prof-loc" class="truncate">ุงููููุน</span></div>
                        
                        <div class="grid grid-cols-2 gap-2 relative z-10">
                            <div class="bg-green-50 p-3 rounded-xl border border-green-100 flex flex-col justify-center">
                                <p class="text-[10px] font-bold text-green-800 mb-1">ุฑุตูุฏ ุงููุญูุธุฉ</p>
                                <span class="font-black text-green-600 text-lg"><span id="prof-wallet">0.00</span> <span class="text-[10px]">JOD</span></span>
                            </div>
                            <div class="bg-yellow-50 p-3 rounded-xl border border-yellow-100 flex flex-col justify-center">
                                <p class="text-[10px] font-bold text-yellow-800 mb-1">ููุงุท ุงูููุงุก</p>
                                <span class="font-black text-yellow-600 text-lg" id="prof-points">0</span>
                            </div>
                        </div>
                        
                        <div id="convert-points-section" class="hidden relative z-10">
                            <button onclick="window.requestPointsConversion()" class="w-full bg-gradient-to-r from-yellow-400 to-yellow-500 text-yellow-900 font-bold py-2.5 rounded-xl shadow-sm text-xs hover:from-yellow-500 hover:to-yellow-600 transition-colors">
                                <i class="fa-solid fa-money-bill-transfer"></i> ุชุญููู 1000 ููุทุฉ ุฅูู 1 ุฏููุงุฑ
                            </button>
                        </div>
                    </div>

                    <!-- ุณุฌู ุงูุทูุจุงุช ุงูุณุงุจูุฉ ูู ุงูููู ุงูุดุฎุตู -->
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 relative z-10 mt-3">
                        <h4 class="font-bold text-gray-800 text-sm mb-3 border-b pb-2"><i class="fa-solid fa-clock-rotate-left text-indigo-500 ml-1"></i> ุณุฌู ุทูุจุงุชู ุงูุณุงุจูุฉ</h4>
                        <div id="profile-order-history" class="space-y-2 max-h-48 overflow-y-auto hide-scrollbar">
                            <!-- ุณูุชู ููุคู ุจุงูู JS -->
                        </div>
                    </div>

                    <button onclick="window.logout()" class="w-full bg-red-50 text-red-600 font-bold py-3 rounded-xl mt-2 hover:bg-red-100 transition-colors relative z-10">ุชุณุฌูู ุงูุฎุฑูุฌ</button>
                </div>
            </div>

            <!-- Bottom Nav -->
            <div class="absolute bottom-0 w-full bg-white border-t border-gray-200 flex justify-around items-center pt-3 pb-4 px-2 z-50 rounded-t-2xl shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
                <button onclick="window.switchCustTab('home')" id="nav-btn-home" class="flex flex-col items-center gap-1 text-gray-400 nav-active w-1/3"><i class="fa-solid fa-house text-xl mb-0.5"></i><span class="text-[10px] font-bold">ุงูุฑุฆูุณูุฉ</span></button>
                <button onclick="window.switchCustTab('cart')" id="nav-btn-cart" class="flex flex-col items-center gap-1 text-gray-400 w-1/3 relative"><i class="fa-solid fa-bag-shopping text-xl mb-0.5"></i><span class="text-[10px] font-bold">ุงูุทูุจุงุช</span><span id="cart-badge" class="hidden absolute top-0 right-6 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white"></span></button>
                <button onclick="window.switchCustTab('profile')" id="nav-btn-profile" class="flex flex-col items-center gap-1 text-gray-400 w-1/3"><i class="fa-solid fa-user text-xl mb-0.5"></i><span class="text-[10px] font-bold">ุญุณุงุจู</span></button>
            </div>
        </div>

        <!-- ==================== ูุงุฌูุฉ ุงูุชุงุฌุฑ / ุงููุทุนู ==================== -->
        <div id="view-merchant" class="hidden flex-col h-full bg-gray-50">
            <div class="bg-gradient-to-r from-pink-600 to-rose-600 text-white p-6 rounded-b-[2rem] shadow-lg z-10 shrink-0">
                <div class="flex justify-between items-center mb-4">
                    <div><p class="text-xs text-pink-200 mb-1">ุจูุงุจุฉ ุงูุดุฑูุงุก</p><h2 class="text-2xl font-black"><i class="fa-solid fa-store ml-1 text-pink-300"></i> <span id="merchant-name-display">ุงููุชุฌุฑ</span></h2></div>
                    <div class="flex gap-2">
                        <button onclick="window.openNotificationsModal()" class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center relative"><i class="fa-solid fa-bell"></i><span id="merch-notif-badge" class="hidden absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full"></span></button>
                        <button onclick="window.logout()" class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center hover:bg-red-500"><i class="fa-solid fa-power-off"></i></button>
                    </div>
                </div>
                <div class="bg-white/10 rounded-xl p-3 flex justify-between items-center border border-white/20">
                    <span class="font-bold text-sm">ุญุงูุฉ ุงููุชุฌุฑ (ููุชูุญ/ูุบูู)</span>
                    <label class="flex items-center cursor-pointer">
                        <div class="relative">
                            <input type="checkbox" id="merchant-status-toggle" class="sr-only" onchange="window.toggleMerchantStatus(this)" checked>
                            <div class="block bg-gray-400 w-12 h-7 rounded-full transition-colors toggle-bg"></div>
                            <div class="dot absolute left-1 top-1 bg-white w-5 h-5 rounded-full transition-transform transform"></div>
                        </div>
                    </label>
                </div>
            </div>
            
            <div class="p-4 flex-1 overflow-y-auto hide-scrollbar flex flex-col">
                <div class="flex w-full bg-gray-200/70 rounded-xl p-1 mb-5">
                    <button id="tab-merchant-orders" onclick="window.switchMerchantTab('orders')" class="flex-1 py-2 text-sm font-bold bg-white shadow rounded-lg text-pink-600 transition-all">ุงูุทูุจุงุช ุงูุญูุฉ</button>
                    <button id="tab-merchant-menu" onclick="window.switchMerchantTab('menu')" class="flex-1 py-2 text-sm font-bold text-gray-500 rounded-lg transition-all">ุงููููู ูุงูุฅุถุงูุงุช</button>
                    <button id="tab-merchant-dash" onclick="window.switchMerchantTab('dash')" class="flex-1 py-2 text-sm font-bold text-gray-500 rounded-lg transition-all">ุงูุชูุงุฑูุฑ</button>
                </div>

                <div id="merchant-orders-content" class="block space-y-4"><div id="merchant-orders-list" class="space-y-4"></div></div>

                <div id="merchant-menu-content" class="hidden space-y-5">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-gray-800 mb-4 text-sm">ุฅุถุงูุฉ ุตูู ุฌุฏูุฏ</h3>
                        <div class="space-y-3">
                            <div class="flex gap-2">
                                <div class="file-upload-btn w-12 h-12 bg-gray-100 text-gray-500 rounded-xl flex items-center justify-center border border-dashed border-gray-300 hover:bg-gray-200 shrink-0">
                                    <i class="fa-solid fa-camera"></i><input type="file" id="new-item-image" accept="image/*" onchange="window.previewImageName(this)">
                                </div>
                                <div class="flex-1 space-y-2">
                                    <div class="flex gap-2">
                                        <input type="text" id="new-item-name" class="flex-1 px-4 py-2.5 rounded-xl border border-gray-200 text-sm focus:border-pink-500 outline-none" placeholder="ุงุณู ุงูุตูู">
                                        <button onclick="window.generateAIItemName()" id="ai-name-btn" class="bg-purple-100 text-purple-600 px-3 rounded-xl hover:bg-purple-200 transition-colors shrink-0" title="โจ ุชุญุณูู ุงูุงุณู ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู"><i class="fa-solid fa-wand-magic-sparkles"></i></button>
                                    </div>
                                    <input type="text" id="new-item-category" class="w-full px-4 py-2.5 rounded-xl border border-gray-200 text-sm focus:border-pink-500 outline-none" placeholder="ุงุณู ุงููุณู (ูุซุงู: ูุฌุจุงุชุ ูุดุฑูุจุงุช)">
                                </div>
                            </div>
                            <p id="image-preview-name" class="text-[9px] text-green-600 hidden font-bold ml-1"></p>
                            
                            <!-- ุงูุฅุถุงูุงุช (Addons) -->
                            <div><input type="text" id="new-item-addons" class="w-full px-4 py-2.5 rounded-xl border border-gray-200 text-xs focus:border-pink-500 outline-none" placeholder="ุงูุฅุถุงูุงุช (ูุซุงู: ุฌุจูุฉ +0.50ุ ุฏุจู +1.00) ุงุฎุชูุงุฑู"></div>
                            
                            <div class="flex gap-2">
                                <input type="number" id="new-item-price" class="flex-1 px-4 py-3 rounded-xl border border-gray-200 text-sm focus:border-pink-500 outline-none" placeholder="ุงูุณุนุฑ (JOD)">
                                <label class="flex items-center gap-2 text-xs font-bold text-red-500 bg-red-50 px-3 rounded-xl border border-red-100 cursor-pointer">
                                    <input type="checkbox" id="new-item-flash" class="w-4 h-4 text-red-500 focus:ring-red-500 border-gray-300 rounded"> ุนุฑุถ ููุงุด
                                </label>
                            </div>
                            <button onclick="window.addMenuItem()" class="w-full bg-pink-600 text-white font-bold py-3 rounded-xl text-sm" id="btn-add-menu">ุฅุถุงูุฉ ูููููู</button>
                        </div>
                    </div>
                    <div><h3 class="font-bold text-gray-800 mb-3 px-1 text-sm">ุงูุฃุตูุงู ุงูุญุงููุฉ</h3><div id="merchant-menu-list" class="space-y-3"></div></div>
                </div>

                <div id="merchant-dash-content" class="hidden space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 text-center"><p class="text-xs text-gray-500 font-bold mb-1">ูุจูุนุงุช ุงูููู</p><p class="text-xl font-black text-pink-600" id="merch-sales-today">0.00 JOD</p></div>
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 text-center"><p class="text-xs text-gray-500 font-bold mb-1">ูุจูุนุงุช ุงูุดูุฑ</p><p class="text-xl font-black text-gray-800" id="merch-sales-month">0.00 JOD</p></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== ูุงุฌูุฉ ุงููุงุจุชู (Captain) ==================== -->
        <div id="view-captain" class="hidden flex-col h-full bg-gray-50">
            <div class="bg-gray-900 text-white p-6 rounded-b-[2rem] shadow-xl z-10 relative overflow-hidden shrink-0">
                <div class="absolute -right-10 -top-10 w-32 h-32 bg-orange-500/20 rounded-full blur-2xl"></div>
                <div class="flex justify-between items-center mb-5 relative z-10">
                    <div>
                        <p class="text-xs text-gray-400 mb-1">ุงููุงุจุชู ุงูุจุทูุ</p>
                        <h2 class="text-xl font-black text-white"><span id="captain-name-display">ุงูุงุณู</span> <i class="fa-solid fa-motorcycle text-orange-500 ml-1"></i></h2>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="window.openNotificationsModal()" class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center relative"><i class="fa-solid fa-bell"></i><span id="capt-notif-badge" class="hidden absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full"></span></button>
                        <button onclick="window.logout()" class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center hover:bg-red-500 transition-colors"><i class="fa-solid fa-power-off"></i></button>
                    </div>
                </div>
                
                <div class="bg-gray-800 rounded-xl p-4 flex justify-between items-center border border-gray-700 relative z-10">
                    <div>
                        <p class="text-[10px] text-gray-400 mb-1">ุฑุตูุฏ ุงููุญูุธุฉ (ููุฎุตู 7% ููุทูุจ)</p>
                        <p class="text-xl font-black text-green-400"><span id="captain-wallet-display">0.00</span> <span class="text-sm">JOD</span></p>
                    </div>
                    <div class="text-center">
                        <p class="text-[10px] text-gray-400 mb-1">ุงูุชูููู</p>
                        <p class="text-sm font-bold text-yellow-400"><i class="fa-solid fa-star"></i> <span id="captain-rating-display">5.0</span></p>
                    </div>
                </div>
            </div>
            
            <div class="p-4 flex-1 overflow-y-auto hide-scrollbar relative">
                <div id="captain-wallet-overlay" class="hidden absolute inset-0 bg-gray-50/95 z-20 flex flex-col items-center justify-center p-6 text-center backdrop-blur-sm">
                    <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center text-4xl mb-4 text-red-500"><i class="fa-solid fa-wallet"></i></div>
                    <h3 class="font-black text-2xl text-gray-800 mb-2">ุฑุตูุฏู ุบูุฑ ูุงูู</h3>
                    <p class="text-sm text-gray-500 font-medium">ุงูุฑุฌุงุก ุดุญู ุงููุญูุธุฉ ูู ุฎูุงู ุงูุฅุฏุงุฑุฉ ูุชุชููู ูู ุงุณุชูุจุงู ุงูุทูุจุงุช ูููุงุตูุฉ ุงูุนูู.</p>
                </div>
                <div class="flex justify-between items-center mb-4 px-1"><h3 class="font-bold text-gray-800">ุงูุทูุจุงุช ุงูุฌุงูุฒุฉ / ุงููุฎุตุตุฉ</h3></div>
                <div id="captain-orders-list" class="space-y-4"></div>
            </div>
        </div>

        <!-- ==================== ููุญุฉ ุงูุฅุฏุงุฑุฉ (Admin) ==================== -->
        <div id="view-admin" class="hidden flex-col h-full bg-gray-50">
            <div class="bg-indigo-900 text-white p-6 rounded-b-[2rem] shadow-xl z-10 shrink-0">
                <div class="flex justify-between items-center mb-4">
                    <div><p class="text-xs text-indigo-300 mb-1">ูุฑูุฒ ุงูููุงุฏุฉ (Admin)</p><h2 class="text-2xl font-black">ุงููุฏูุฑ <span id="admin-name-display">ูุนุงุฐ</span> ๐ก๏ธ</h2></div>
                    <button onclick="window.logout()" class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center hover:bg-red-500 transition-colors"><i class="fa-solid fa-power-off"></i></button>
                </div>
            </div>
            
            <div class="p-4 flex-1 overflow-y-auto hide-scrollbar">
                <!-- Admin Tabs -->
                <div class="flex flex-wrap w-full bg-indigo-100 rounded-xl p-1 mb-5 gap-y-1">
                    <button id="tab-admin-dash" onclick="window.switchAdminTab('dash')" class="flex-1 min-w-[20%] py-2 text-[10px] font-bold bg-white shadow rounded-lg text-indigo-900 transition-all">ุงูุฑุฆูุณูุฉ</button>
                    <button id="tab-admin-staff" onclick="window.switchAdminTab('staff')" class="flex-1 min-w-[20%] py-2 text-[10px] font-bold text-indigo-600 rounded-lg transition-all">ุงููุณุชุฎุฏููู ูุงูุชุนุฏูู</button>
                    <button id="tab-admin-finance" onclick="window.switchAdminTab('finance')" class="flex-1 min-w-[20%] py-2 text-[10px] font-bold text-indigo-600 rounded-lg transition-all relative">ุงููุงููุฉ <span id="finance-badge" class="hidden absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span></button>
                    <button id="tab-admin-settings" onclick="window.switchAdminTab('settings')" class="flex-1 min-w-[20%] py-2 text-[10px] font-bold text-indigo-600 rounded-lg transition-all">ุฅุนุฏุงุฏุงุช / ุฅุดุนุงุฑุงุช</button>
                </div>

                <div id="admin-dash-content" class="block space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100"><h4 class="text-xs font-bold text-gray-500 mb-1">ูุจูุนุงุช ุงูููุตุฉ</h4><p class="text-xl font-black text-gray-800"><span id="admin-total-sales">0.00</span></p></div>
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100"><h4 class="text-xs font-bold text-gray-500 mb-1">ุฃุฑุจุงุญ ุงูุฅุฏุงุฑุฉ</h4><p class="text-xl font-black text-green-600"><span id="admin-profits">0.00</span></p></div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="window.exportCSV()" class="flex-1 bg-green-600 text-white font-bold py-2 rounded-xl text-xs shadow-sm"><i class="fa-solid fa-file-csv mr-1"></i> ุชุตุฏูุฑ ุงูุทูุจุงุช CSV</button>
                    </div>
                    
                    <!-- ุฎุฑูุทุฉ ุงููุจุงุชู ุงูููููุฉ -->
                    <div class="bg-indigo-50 rounded-2xl p-4 border border-indigo-100 mt-4 relative overflow-hidden h-40 flex items-center justify-center">
                        <i class="fa-solid fa-map-location-dot text-indigo-200 text-6xl absolute z-0"></i>
                        <div class="relative z-10 text-center">
                            <p class="font-bold text-indigo-800 text-sm mb-2"><i class="fa-solid fa-satellite-dish"></i> ุฎุฑูุทุฉ ุงููุจุงุชู ุงูุญูุฉ</p>
                            <p class="text-xs text-indigo-600">ูุชููุฑ <span id="live-captains-count" class="font-black">0</span> ูุงุจุชู ูู ุงูุฎุฏูุฉ ุงูุขู.</p>
                        </div>
                        <div class="absolute w-2 h-2 bg-green-500 rounded-full animate-ping top-10 left-10"></div>
                        <div class="absolute w-2 h-2 bg-green-500 rounded-full animate-ping bottom-10 right-20"></div>
                    </div>
                    
                    <h3 class="font-bold text-gray-800 border-b pb-2 mt-4"><i class="fa-solid fa-satellite-dish text-indigo-500"></i> ุงูุฑุงุฏุงุฑ ุงููุจุงุดุฑ</h3>
                    <div id="admin-orders-list" class="space-y-3"></div>
                </div>

                <!-- ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู -->
                <div id="admin-staff-content" class="hidden space-y-5">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 space-y-3">
                        <h3 class="font-bold text-gray-800 text-sm border-b pb-3"><i class="fa-solid fa-user-plus text-indigo-500"></i> ุฅุถุงูุฉ ุนุถู ูููุธุงู</h3>
                        <select id="new-staff-role" onchange="window.toggleMerchantCategory()" class="w-full px-3 py-2 text-sm rounded-xl border border-gray-200 outline-none">
                            <option value="merchant">ูุชุฌุฑ ๐ช</option>
                            <option value="captain">ูุงุจุชู ุชูุตูู ๐ต</option>
                            <option value="admin">ูุฏูุฑ ูุธุงู ๐ก๏ธ</option>
                            <option value="support">ุฏุนู ููู (ุจุฏูู ูุงููุฉ) ๐ง</option>
                        </select>
                        <div id="new-staff-category-container">
                            <select id="new-staff-category" class="w-full px-3 py-2 text-sm rounded-xl border border-gray-200 outline-none bg-gray-50">
                                <option value="restaurant">ูุทุนู ๐</option>
                                <option value="market">ูุงุฑูุช ๐</option>
                                <option value="pharmacy">ุตูุฏููุฉ ๐</option>
                                <option value="school">ูุฏุงุฑุณ ูุฌุงูุนุงุช ๐</option>
                                <option value="productive">ุฃุณุฑ ููุชุฌุฉ ๐ก</option>
                                <option value="gas">ุบุงุฒ ๐ฅ</option>
                            </select>
                        </div>
                        <input type="text" id="new-staff-name" class="w-full px-3 py-2 text-sm rounded-xl border border-gray-200 outline-none" placeholder="ุงูุงุณู ุงููุงูู / ุงููุชุฌุฑ">
                        <input type="text" id="new-staff-worknum" class="hidden w-full px-3 py-2 text-sm rounded-xl border border-indigo-200 outline-none bg-indigo-50" placeholder="ุงููุนุฑู ุงููุฎุตุต (ุงุฎุชูุงุฑู ููุฅุฏุงุฑุฉ)">
                        <input type="tel" id="new-staff-phone" class="w-full px-3 py-2 text-sm rounded-xl border border-gray-200 outline-none" placeholder="ุฑูู ุงููุงุชู">
                        <input type="password" id="new-staff-password" class="w-full px-3 py-2 text-sm rounded-xl border border-gray-200 outline-none" placeholder="ูููุฉ ุงููุฑูุฑ">
                        <button onclick="window.registerStaff()" class="w-full bg-indigo-600 text-white font-bold py-2.5 rounded-xl mt-2 text-sm">ุฅุถุงูุฉ ูุงุนุชูุงุฏ</button>
                        <button onclick="window.seedDummyData()" class="w-full bg-gray-100 text-gray-600 font-bold py-2 rounded-xl mt-1 text-xs"><i class="fa-solid fa-flask"></i> ุฅูุดุงุก ุจูุงูุงุช ุชุฌุฑูุจูุฉ</button>
                    </div>
                    
                    <h3 class="font-bold text-gray-800 text-sm">ุฅุฏุงุฑุฉ ูุณุชุฎุฏูู ุงููุธุงู</h3>
                    <div id="admin-staff-list" class="space-y-4"></div>
                </div>

                <div id="admin-finance-content" class="hidden space-y-4">
                    <h3 class="font-bold text-gray-800 border-b pb-2 text-sm"><i class="fa-solid fa-money-bill-transfer text-indigo-500"></i> ุทูุจุงุช ุชุญููู ุงูููุงุท (ุงูุฒุจุงุฆู)</h3>
                    <div id="admin-points-requests" class="space-y-3 mb-6"></div>
                </div>

                <div id="admin-settings-content" class="hidden space-y-5">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 space-y-3">
                        <h3 class="font-bold text-gray-800 text-sm border-b pb-3"><i class="fa-solid fa-sliders text-indigo-500"></i> ูููุฉ ุงูุชุทุจูู (ุชุบููุฑ ุงูููุฌู)</h3>
                        <input type="text" id="setting-app-name" class="w-full px-3 py-2.5 text-sm rounded-xl border border-gray-200 outline-none" placeholder="ุงุณู ุงูุชุทุจูู">
                        <div class="flex items-center gap-2">
                            <div class="file-upload-btn w-12 h-12 bg-gray-100 text-gray-500 rounded-xl flex items-center justify-center border border-dashed border-gray-300 hover:bg-gray-200 shrink-0">
                                <i class="fa-solid fa-image"></i>
                                <input type="file" id="setting-app-logo-file" accept="image/*" onchange="window.previewLogoName(this)">
                            </div>
                            <div class="text-xs text-gray-500" id="logo-preview-text">ุงุฎุชุฑ ุดุนุงุฑ ุงูุชุทุจูู (ุตูุฑุฉ)</div>
                        </div>
                        <button onclick="window.saveAppSettings()" class="w-full bg-gray-900 text-white font-bold py-2.5 rounded-xl shadow-md text-sm mt-2">ุญูุธ ุงููููุฉ ุงูุฌุฏูุฏุฉ</button>
                    </div>

                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 space-y-3">
                        <h3 class="font-bold text-gray-800 text-sm border-b pb-3"><i class="fa-solid fa-paper-plane text-indigo-500"></i> ูุฑูุฒ ุจุซ ุงูุฅุดุนุงุฑุงุช ูุงูุตูุฑ</h3>
                        <div>
                            <select id="admin-notif-target" class="w-full px-3 py-2 text-sm rounded-xl border border-gray-200 outline-none">
                                <option value="all">ุงูุฌููุน (ูุจุงุชูุ ูุชุงุฌุฑุ ุฒุจุงุฆู)</option>
                                <option value="captains">ุฌููุน ุงููุจุงุชู</option>
                                <option value="merchants">ุฌููุน ุงููุชุงุฌุฑ</option>
                                <option value="customers">ุฌููุน ุงูุฒุจุงุฆู</option>
                            </select>
                        </div>
                        <input type="text" id="admin-notif-img" class="w-full px-3 py-2 text-sm rounded-xl border border-gray-200 outline-none" placeholder="ุฑุงุจุท ุตูุฑุฉ ุจุงูุฑ ุฅุนูุงูู (ุงุฎุชูุงุฑู URL)">
                        <textarea id="admin-notif-msg" rows="3" class="w-full px-3 py-2 text-sm rounded-xl border border-gray-200 outline-none" placeholder="ุงูุชุจ ุฅุดุนุงุฑู (ุนุฑุถ ุฌุฏูุฏุ ุชุญุฐูุฑ...)"></textarea>
                        
                        <div class="border-t pt-3 mt-2">
                            <h4 class="text-[10px] font-bold text-gray-500 mb-2">ุฅุตุฏุงุฑ ููุจูู ุฎุตู ูุฎุตุต</h4>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="text" id="new-promo-code" class="w-full px-3 py-2 text-sm rounded-xl border border-gray-200 outline-none uppercase font-bold" placeholder="ููุฏ ุงูุฎุตู">
                                <input type="number" id="new-promo-discount" class="w-full px-3 py-2 text-sm rounded-xl border border-gray-200 outline-none" placeholder="ุงูุฎุตู JOD">
                            </div>
                            <button onclick="window.addPromo()" class="w-full bg-green-600 text-white font-bold py-2 rounded-xl shadow-md text-xs mt-2">ุฅุตุฏุงุฑ ุงูููุจูู</button>
                        </div>
                        <button onclick="window.sendAdminNotification()" class="w-full bg-blue-600 text-white font-bold py-2.5 rounded-xl shadow-md text-sm mt-4">ุฅุฑุณุงู ุงูุฅุดุนุงุฑ ููุฑุงู <i class="fa-solid fa-bolt ml-1"></i></button>
                    </div>
                </div>

            </div>
        </div>

        <!-- ==================== ููุงูุฐ ููุจุซูุฉ (Modals) ==================== -->
        
        <!-- Custom Order Modal -->
        <div id="custom-order-modal" class="hidden absolute inset-0 bg-gray-900/80 z-[80] flex items-center justify-center backdrop-blur-sm p-4 transition-all">
            <div class="bg-white w-full rounded-3xl p-6 shadow-2xl relative max-h-[90vh] overflow-y-auto hide-scrollbar">
                <button onclick="window.closeCustomOrderModal()" class="absolute top-4 left-4 w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-200"><i class="fa-solid fa-xmark"></i></button>
                <h3 class="font-black text-xl text-indigo-900 mb-4 border-b pb-3"><i class="fa-solid fa-motorcycle ml-1 text-orange-500"></i> ุทูุจ ูุฎุตุต (ุชูุตูู ูู ุฃู ููุงู)</h3>
                <p class="text-xs text-gray-500 mb-4 font-bold">ุงูุชุจ ุงุณู ุงูููุงู ูุงูุทูุจุงุช ุงููู ุจุฏู ุฅูุงูุงุ ูุงููุงุจุชู ุจุฌูุจูุง ูุญุงุณุจ ุนูู ุงููุงุชูุฑุฉ.</p>
                <div class="space-y-3">
                    <input type="text" id="custom-place-name" class="w-full px-4 py-3 rounded-xl border border-gray-200 text-sm focus:border-orange-500 outline-none" placeholder="ุงุณู ุงูููุงู (ูุซุงู: ูุฎุจุฒ ุงูุฃููุ ุณูุจุฑูุงุฑูุช...)">
                    <textarea id="custom-item-name" rows="3" class="w-full px-4 py-3 rounded-xl border border-gray-200 text-sm focus:border-orange-500 outline-none" placeholder="ุดู ุจุฏู ููุตูููุ (ูุซุงู: 2 ูููู ุฎุจุฒุ ุนูุจุฉ ูุจู)"></textarea>
                    <button onclick="window.confirmCustomOrder()" class="w-full bg-gradient-to-r from-orange-500 to-amber-500 text-white font-black py-3.5 rounded-xl shadow-lg text-sm mt-2">ุฅุฑุณุงู ุงูุทูุจ ูููุจุงุชู ๐</button>
                </div>
            </div>
        </div>

        <!-- Notifications Modal -->
        <div id="notifications-modal" class="hidden absolute inset-0 bg-white z-[90] flex flex-col transition-all">
            <div class="bg-indigo-900 text-white p-4 flex justify-between items-center shadow-md pt-6">
                <div class="flex items-center gap-3"><button onclick="window.closeNotificationsModal()" class="w-8 h-8 rounded-full flex items-center justify-center hover:bg-white/20"><i class="fa-solid fa-arrow-right"></i></button><h3 class="font-bold text-sm">ุงูุฅุดุนุงุฑุงุช</h3></div>
            </div>
            <div id="notifications-list" class="flex-1 overflow-y-auto p-4 flex flex-col gap-3 bg-gray-50 hide-scrollbar">
                <p class="text-center text-xs text-gray-400 py-10">ูุง ุชูุฌุฏ ุฅุดุนุงุฑุงุช</p>
            </div>
        </div>

        <!-- ูุงูุฐุฉ ุงูุชุนุฏูู ููุฅุฏุงุฑุฉ -->
        <div id="admin-edit-modal" class="hidden absolute inset-0 bg-gray-900/80 z-[90] flex items-center justify-center backdrop-blur-sm p-4 transition-all">
            <div class="bg-white w-full rounded-3xl p-6 shadow-2xl relative max-h-[90vh] overflow-y-auto hide-scrollbar">
                <button onclick="window.closeAdminEdit()" class="absolute top-4 left-4 w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-200"><i class="fa-solid fa-xmark"></i></button>
                <h3 class="font-black text-xl text-indigo-900 mb-4 border-b pb-3"><i class="fa-solid fa-user-pen ml-1"></i> ุชุนุฏูู ุจูุงูุงุช ุงููุณุชุฎุฏู</h3>
                
                <input type="hidden" id="edit-user-id">
                <input type="hidden" id="edit-user-col">
                
                <div class="space-y-3">
                    <div><label class="block text-xs font-bold text-gray-600 mb-1">ุงูุงุณู</label><input type="text" id="edit-user-name" class="w-full px-4 py-2.5 rounded-xl border border-gray-200 text-sm focus:border-indigo-500 outline-none"></div>
                    <div><label class="block text-xs font-bold text-gray-600 mb-1">ุงููุนุฑู (ุฃุฑูุงู ููุท - ูููุจุงุชู/ุงููุชุงุฌุฑ)</label><input type="text" id="edit-user-worknum" class="w-full px-4 py-2.5 rounded-xl border border-gray-200 text-sm focus:border-indigo-500 outline-none" placeholder="ูุง ููุฌุฏ"></div>
                    <div><label class="block text-xs font-bold text-gray-600 mb-1">ุฑูู ุงููุงุชู</label><input type="tel" id="edit-user-phone" class="w-full px-4 py-2.5 rounded-xl border border-gray-200 text-sm focus:border-indigo-500 outline-none"></div>
                    <div><label class="block text-xs font-bold text-gray-600 mb-1">ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ</label><input type="text" id="edit-user-pass" class="w-full px-4 py-2.5 rounded-xl border border-gray-200 text-sm focus:border-indigo-500 outline-none"></div>
                    
                    <div class="grid grid-cols-2 gap-3 pt-3 border-t">
                        <div><label class="block text-xs font-bold text-green-700 mb-1">ุฑุตูุฏ ุงููุญูุธุฉ (JOD)</label><input type="number" step="0.01" id="edit-user-wallet" class="w-full px-4 py-2.5 rounded-xl border border-green-200 bg-green-50 text-sm focus:border-green-500 outline-none font-bold text-green-700"></div>
                        <div><label class="block text-xs font-bold text-yellow-700 mb-1">ููุงุท ุงูููุงุก</label><input type="number" id="edit-user-points" class="w-full px-4 py-2.5 rounded-xl border border-yellow-200 bg-yellow-50 text-sm focus:border-yellow-500 outline-none font-bold text-yellow-700"></div>
                    </div>
                </div>
                <button onclick="window.saveAdminEdit()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-black py-3.5 rounded-xl shadow-lg text-sm mt-6">ุญูุธ ุงูุชุนุฏููุงุช โ</button>
            </div>
        </div>

        <!-- ูุงูุฐุฉ ุชุฃููุฏ ุงูุญุฐู ุงูููุงุฆู -->
        <div id="delete-confirm-modal" class="hidden absolute inset-0 bg-gray-900/80 z-[100] flex items-center justify-center backdrop-blur-sm p-4 transition-all">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl text-center">
                <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center text-3xl mx-auto mb-4"><i class="fa-solid fa-triangle-exclamation"></i></div>
                <h3 class="font-black text-xl text-gray-800 mb-2">ุชุฃููุฏ ุงูุญุฐู</h3>
                <p class="text-xs text-gray-500 mb-6">ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุญุณุงุจ ููุงุฆูุงูุ ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.</p>
                <div class="flex gap-3">
                    <button onclick="window.executeDeleteUser()" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-xl shadow-lg text-sm">ูุนูุ ุงุญุฐู</button>
                    <button onclick="document.getElementById('delete-confirm-modal').classList.add('hidden')" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 rounded-xl shadow-sm text-sm">ุฅูุบุงุก</button>
                </div>
            </div>
        </div>

        <!-- ูุงูุฐุฉ ุงูุณูุฉ ูุจู ุงูุทูุจ (Checkout Cart) -->
        <div id="checkout-modal" class="hidden absolute inset-0 bg-gray-900/60 z-[60] flex items-end justify-center backdrop-blur-sm transition-all">
            <div class="bg-white w-full rounded-t-[2rem] p-6 shadow-2xl max-h-[90vh] overflow-y-auto hide-scrollbar">
                <div class="flex justify-between items-center mb-4 border-b pb-3">
                    <h3 class="font-black text-xl text-gray-800">ุชุฃููุฏ ุงูุทูุจ</h3>
                    <button onclick="window.closeCheckout()" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500"><i class="fa-solid fa-xmark"></i></button>
                </div>
                
                <div class="mb-4 bg-gray-50 p-4 rounded-xl border border-gray-100 space-y-3">
                    <div id="checkout-items-summary" class="text-sm font-bold text-gray-700 mb-2 border-b pb-2"></div>
                    <div class="flex justify-between text-xs text-gray-500 mb-1"><span>ุณุนุฑ ุงูุทูุจ:</span><span id="checkout-item-price" class="font-bold text-gray-800"></span></div>
                    <div class="flex justify-between text-xs text-gray-500 pb-2 border-b border-gray-200"><span>ุฃุฌุฑุฉ ุงูุชูุตูู ุงูุซุงุจุชุฉ:</span><span id="checkout-delivery-fee" class="font-bold text-gray-800">1.00 JOD</span></div>
                    
                    <!-- ุงูุชูููุช ุงููุฌุฏูู ูุงูููุงุญุธุงุช -->
                    <div>
                        <label class="block text-[10px] font-bold text-gray-600 mb-1">ููุช ุงูุชูุตูู</label>
                        <select id="checkout-time" class="w-full px-3 py-2 rounded-lg border border-gray-200 text-xs font-bold text-indigo-700 outline-none">
                            <option value="now">ุฃุณุฑุน ููุช ูููู (ุงูุขู)</option>
                            <option value="tomorrow_14">ูุฌุฏูู: ุบุฏุงู ุงูุณุงุนุฉ 2:00 ุธูุฑุงู</option>
                        </select>
                    </div>
                    <div><textarea id="checkout-notes" rows="2" class="w-full px-3 py-2 rounded-lg border border-gray-200 text-xs outline-none focus:border-indigo-500" placeholder="ููุงุญุธุงุช ูููุทุนู (ุจุฏูู ุจุตูุ ูุซุฑ ุตูุต...)"></textarea></div>

                    <div class="flex items-center justify-between mt-2 bg-green-50 p-2 rounded border border-green-100 hidden" id="checkout-wallet-section">
                        <span class="text-xs font-bold text-green-800">ุงุณุชุฎุฏุงู ุฑุตูุฏ ูุญูุธุชู (<span id="checkout-wallet-bal">0</span> JOD)</span>
                        <input type="checkbox" id="checkout-use-wallet" onchange="window.toggleWalletDiscount()" class="w-4 h-4 text-green-500 rounded focus:ring-green-500">
                    </div>
                </div>
                <div class="flex justify-between items-center mb-6"><span class="font-bold text-gray-600 text-sm">ุงููุทููุจ ุฏูุนู ููุฏุงู:</span><span class="font-black text-2xl text-blue-600" id="checkout-total-price"></span></div>
                <button id="checkout-confirm-btn" onclick="window.confirmOrderPlacement()" class="w-full bg-blue-600 text-white font-black py-4 rounded-xl shadow-lg text-lg">ุฅุฑุณุงู ุงูุทูุจ</button>
            </div>
        </div>

        <!-- Rating Modal (Detailed) -->
        <div id="rating-modal" class="hidden absolute inset-0 bg-gray-900/70 z-[70] flex items-center justify-center backdrop-blur-sm p-4 transition-all">
            <div class="bg-white w-full rounded-3xl p-6 shadow-2xl text-center max-h-[90vh] overflow-y-auto hide-scrollbar">
                <div class="w-16 h-16 bg-yellow-100 text-yellow-500 rounded-full flex items-center justify-center text-3xl mx-auto mb-4"><i class="fa-solid fa-star"></i></div>
                <h3 class="font-black text-xl text-gray-800 mb-1">ุชู ุงูุชูุตูู ุจูุฌุงุญ!</h3>
                <p class="text-xs text-gray-500 mb-4">ุชููููู ูููุฏูุง ุฌุฏุงู ูู ุชุญุณูู ุงูุฌูุฏุฉ.</p>
                
                <div class="space-y-4 mb-6 text-right">
                    <div>
                        <p class="text-xs font-bold text-gray-700 mb-1 text-center">ุชูููู ุงููุงุจุชู (ุงูุณุฑุนุฉ ูุงูุชุนุงูู)</p>
                        <div class="flex gap-2 star-rating text-2xl justify-center" id="rating-captain-stars">
                            <i class="fa-solid fa-star active" data-val="1" onclick="window.selectRating('cap', 1)"></i>
                            <i class="fa-solid fa-star active" data-val="2" onclick="window.selectRating('cap', 2)"></i>
                            <i class="fa-solid fa-star active" data-val="3" onclick="window.selectRating('cap', 3)"></i>
                            <i class="fa-solid fa-star active" data-val="4" onclick="window.selectRating('cap', 4)"></i>
                            <i class="fa-solid fa-star active" data-val="5" onclick="window.selectRating('cap', 5)"></i>
                        </div>
                    </div>
                    <div class="border-t pt-3">
                        <p class="text-xs font-bold text-gray-700 mb-1 text-center">ุชูููู ุงููุชุฌุฑ (ุงูุทุนู ูุงูุชุบููู)</p>
                        <div class="flex gap-2 star-rating text-2xl justify-center" id="rating-merchant-stars">
                            <i class="fa-solid fa-star active" data-val="1" onclick="window.selectRating('merch', 1)"></i>
                            <i class="fa-solid fa-star active" data-val="2" onclick="window.selectRating('merch', 2)"></i>
                            <i class="fa-solid fa-star active" data-val="3" onclick="window.selectRating('merch', 3)"></i>
                            <i class="fa-solid fa-star active" data-val="4" onclick="window.selectRating('merch', 4)"></i>
                            <i class="fa-solid fa-star active" data-val="5" onclick="window.selectRating('merch', 5)"></i>
                        </div>
                    </div>
                </div>
                <button onclick="window.submitRating()" class="w-full bg-gray-900 text-white font-bold py-3.5 rounded-xl shadow-lg text-sm mb-2">ุฅุฑุณุงู ุงูุชูููู</button>
                <button onclick="window.closeRatingModal()" class="w-full bg-transparent text-gray-500 font-bold py-2 text-sm">ุชุฎุทู</button>
            </div>
        </div>

        <!-- ูุงูุฐุฉ ุดุญู ูุฎุตู ูุญูุธุฉ ุงููุงุจุชู -->
        <div id="topup-modal" class="hidden absolute inset-0 bg-gray-900/70 z-[80] flex items-center justify-center backdrop-blur-sm p-4 transition-all">
            <div class="bg-white w-full rounded-3xl p-6 shadow-2xl relative">
                <button onclick="window.closeTopUpModal()" class="absolute top-4 left-4 w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-200"><i class="fa-solid fa-xmark"></i></button>
                <h3 class="font-black text-xl text-gray-800 mb-2"><i class="fa-solid fa-wallet text-green-500 ml-1"></i> ุฅุฏุงุฑุฉ ูุญูุธุฉ ุงููุงุจุชู</h3>
                <div class="space-y-4 mb-6 mt-4">
                    <div class="relative">
                        <input type="number" id="topup-amount" class="w-full px-4 py-3 rounded-xl border border-gray-200 text-sm focus:border-green-500 outline-none text-center font-bold text-xl" placeholder="0.00">
                        <span class="absolute left-4 top-3 text-gray-400 font-bold">JOD</span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="window.confirmTopUp(true)" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-black py-3 rounded-xl shadow-lg text-sm">ุดุญู ุฅูุฌุงุจู โ</button>
                    <button onclick="window.confirmTopUp(false)" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-black py-3 rounded-xl shadow-lg text-sm">ุฎุตู ุนููุจุฉ ๐ซ</button>
                </div>
            </div>
        </div>

        <!-- Chat Modal -->
        <div id="chat-modal" class="hidden absolute inset-0 bg-white z-[60] flex flex-col transition-all">
            <div class="bg-blue-600 text-white p-4 flex justify-between items-center shadow-md pt-6">
                <div class="flex items-center gap-3"><button onclick="window.closeChat()" class="w-8 h-8 rounded-full flex items-center justify-center hover:bg-white/20"><i class="fa-solid fa-arrow-right"></i></button><div><h3 class="font-bold text-sm" id="chat-title">ูุญุงุฏุซุฉ</h3></div></div>
                <a href="#" id="chat-call-btn" class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center shadow"><i class="fa-solid fa-phone text-xs"></i></a>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 flex flex-col gap-3 bg-gray-50 hide-scrollbar"></div>
            <div class="p-3 bg-white border-t flex gap-2 items-center">
                <input type="text" id="chat-input-text" class="flex-1 bg-gray-100 px-4 py-3 rounded-full text-sm outline-none" placeholder="ุงูุชุจ ุฑุณุงูุชู...">
                <button onclick="window.sendChatMessage()" class="w-12 h-12 bg-blue-600 text-white rounded-full flex items-center justify-center"><i class="fa-solid fa-paper-plane text-sm -ml-1"></i></button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs & System Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, getDocs, query, where, serverTimestamp, arrayUnion, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==================== CONFIGURATION ====================
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyC8_o7E8xN6ba-_guVf0izSBNwlgdHcXL4",
            authDomain: "qutaiba-express.firebaseapp.com",
            projectId: "qutaiba-express",
            storageBucket: "qutaiba-express.firebasestorage.app",
            messagingSenderId: "657701995034",
            appId: "1:657701995034:web:e5348dbb914a34b5e287a3"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'fazaa-app';

        // Helper wrappers for strict paths mandate
        const getCollection = (colName) => collection(db, 'artifacts', appId, 'public', 'data', colName);
        const getDocRef = (colName, docId) => doc(db, 'artifacts', appId, 'public', 'data', colName, docId);

        // ==================== GLOBAL STATE VARIABLES ====================
        let currentUser = null; let currentUserData = null; let currentUserRole = '';
        let allOrders = [], allStaff = [], allUsers = [], allMenu = [], allPromos = [], allNotifications = [], allPointRequests = [];
        let unsubs = [];
        let customerCart = []; 
        let currentStoreViewId = null; 
        let appSettings = { name: 'ูุฒุนููุฉ', logo: '' };
        let currentCustCategory = 'all'; 
        let checkoutItem = null, checkoutBasePrice = 0, checkoutDelivery = 1.00;
        let walletDiscountActive = false, appliedWalletDiscount = 0;
        let currentChatOrderId = null, ratingTargetOrderId = null, ratingTargetCaptainId = null, ratingTargetMerchantId = null;
        let captStarVal = 5, merchStarVal = 5, topUpTargetId = null, topUpCurrentBal = 0;
        let targetDeleteId = null, targetDeleteCol = null;
        
        const DEDUCTION_RATE = 0.07, MIN_WALLET_BALANCE = 0.07; 
        let adminCommissionRate = 0.10; 
        
        const statusMap = {
            'pending': { text: 'ุจุงูุชุธุงุฑ ุงููุชุฌุฑ', color: 'bg-yellow-100 text-yellow-700' },
            'preparing': { text: 'ุฌุงุฑู ุงูุชุฌููุฒ', color: 'bg-orange-100 text-orange-700' },
            'ready': { text: 'ุฌุงูุฒ ููุงุณุชูุงู', color: 'bg-blue-100 text-blue-700' },
            'on_the_way': { text: 'ูู ุงูุทุฑูู', color: 'bg-purple-100 text-purple-700' },
            'delivered': { text: 'ุชู ุงูุชุณููู', color: 'bg-green-100 text-green-700' }
        };

        const categoryIcons = {
            'restaurant': '<i class="fa-solid fa-burger text-3xl text-orange-400 drop-shadow-sm"></i>',
            'market': '<i class="fa-solid fa-basket-shopping text-3xl text-blue-400 drop-shadow-sm"></i>',
            'pharmacy': '<i class="fa-solid fa-pills text-3xl text-green-400 drop-shadow-sm"></i>',
            'school': '<i class="fa-solid fa-graduation-cap text-3xl text-indigo-400 drop-shadow-sm"></i>',
            'productive': '<i class="fa-solid fa-house-chimney-window text-3xl text-pink-400 drop-shadow-sm"></i>',
            'gas': '<i class="fa-solid fa-fire-flame-simple text-3xl text-red-500 drop-shadow-sm"></i>'
        };

        // ==================== BINDING ALL FUNCTIONS TO WINDOW ====================
        
        window.showToast = function(msg, type = 'info', img = null) { 
            const toast = document.getElementById('toast'); const tMsg = document.getElementById('toast-msg'); const tImg = document.getElementById('toast-img');
            if(!toast || !tMsg) return; 
            tMsg.innerText = msg; 
            if(img && tImg) { tImg.src = img; tImg.classList.remove('hidden'); } else if (tImg) { tImg.classList.add('hidden'); }
            const style = {'success':{bg:'bg-green-600', ic:'fa-check-circle'},'error':{bg:'bg-red-600', ic:'fa-triangle-exclamation'},'info':{bg:'bg-gray-900', ic:'fa-bell'}}; 
            toast.className = `absolute top-6 left-1/2 transform -translate-x-1/2 ${style[type].bg} text-white px-5 py-3 rounded-2xl shadow-2xl transition-all duration-300 opacity-0 z-[100] flex flex-col items-center gap-2 text-sm font-bold min-w-[250px] text-center`; 
            document.getElementById('toast-icon').innerHTML = `<i class="fa-solid ${style[type].ic}"></i>`; 
            toast.classList.remove('opacity-0', '-translate-y-4'); toast.classList.add('translate-y-0'); 
            setTimeout(() => { toast.classList.add('opacity-0', '-translate-y-4'); toast.classList.remove('translate-y-0'); }, 4500); 
        };

        window.showView = function(v) { document.querySelectorAll('div[id^="view-"]').forEach(el => { el.classList.add('hidden'); el.classList.remove('flex'); }); const e = document.getElementById(`view-${v}`); if(e) { e.classList.remove('hidden'); e.classList.add('flex'); } if(currentUserRole) window.updateUI(); };
        window.switchLoginTab = function(t) { const isCust = t === 'customer'; const fc = document.getElementById('form-customer'); if(fc) fc.classList.toggle('hidden', !isCust); const fs = document.getElementById('form-staff'); if(fs) fs.classList.toggle('hidden', isCust); const tc = document.getElementById('tab-customer'); if(tc) tc.className = `flex-1 py-2 text-sm font-bold rounded-lg transition-all ${isCust ? 'bg-white shadow text-indigo-700' : 'text-gray-500'}`; const ts = document.getElementById('tab-staff'); if(ts) ts.className = `flex-1 py-2 text-sm font-bold rounded-lg transition-all ${!isCust ? 'bg-white shadow text-indigo-700' : 'text-gray-500'}`; };
        window.switchCustTab = function(tab) { ['home', 'cart', 'profile'].forEach(t => { const e = document.getElementById(`cust-tab-${t}`); if(e) { e.classList.toggle('hidden', t !== tab); e.classList.toggle('block', t === tab); } const btn = document.getElementById(`nav-btn-${t}`); if(btn) { if(t === tab) { btn.classList.add('nav-active'); btn.classList.remove('text-gray-400'); } else { btn.classList.remove('nav-active'); btn.classList.add('text-gray-400'); } } }); const cb = document.getElementById('cart-badge'); if(tab === 'cart' && cb) cb.classList.add('hidden'); };
        window.switchAdminTab = function(tab) { ['dash', 'staff', 'finance', 'settings'].forEach(t => { const content = document.getElementById(`admin-${t}-content`); if(content) { content.classList.toggle('hidden', t !== tab); content.classList.toggle('block', t === tab); } const btn = document.getElementById(`tab-admin-${t}`); if(btn) { btn.className = `flex-1 min-w-[20%] py-2 text-[11px] font-bold rounded-lg transition-all ${t === tab ? 'bg-white shadow text-indigo-900' : 'text-indigo-600'}`; } }); const fb = document.getElementById('finance-badge'); if(tab === 'finance' && fb) fb.classList.add('hidden'); };
        window.switchMerchantTab = function(tab) { ['orders', 'menu', 'dash'].forEach(t => { const e = document.getElementById(`merchant-${t}-content`); if(e) { e.classList.toggle('hidden', t !== tab); e.classList.toggle('block', t === tab); } const b = document.getElementById(`tab-merchant-${t}`); if(b) b.className = `flex-1 py-2 text-sm font-bold rounded-lg transition-all ${t === tab ? 'bg-white shadow text-pink-600' : 'text-gray-500'}`; }); };
        
        window.setCustCategory = function(cat) { 
            currentCustCategory = cat; 
            document.querySelectorAll('.cat-btn').forEach(btn => { btn.classList.remove('bg-indigo-600', 'text-white', 'shadow-md'); btn.classList.add('bg-white', 'text-gray-600'); }); 
            const b = document.getElementById(`btn-cat-${cat}`); 
            if(b) { b.classList.remove('bg-white', 'text-gray-600'); b.classList.add('bg-indigo-600', 'text-white', 'shadow-md'); } 
            window.renderCustomer(); 
        };

        window.toggleMerchantCategory = function() {
            const role = document.getElementById('new-staff-role').value;
            const categoryContainer = document.getElementById('new-staff-category-container'); const workNumInput = document.getElementById('new-staff-worknum');
            if (categoryContainer) { categoryContainer.classList.toggle('hidden', role !== 'merchant'); }
            if (workNumInput) { workNumInput.classList.toggle('hidden', role !== 'admin'); }
        };

        window.openNotificationsModal = function() { const m = document.getElementById('notifications-modal'); if(m) m.classList.remove('hidden'); };
        window.closeNotificationsModal = function() { const m = document.getElementById('notifications-modal'); if(m) m.classList.add('hidden'); if(currentUserRole === 'customer') { const b = document.getElementById('cust-notif-badge'); if(b) b.classList.add('hidden'); } if(currentUserRole === 'merchant') { const b = document.getElementById('merch-notif-badge'); if(b) b.classList.add('hidden'); } if(currentUserRole === 'captain') { const b = document.getElementById('capt-notif-badge'); if(b) b.classList.add('hidden'); } };
        window.openCustomOrderModal = function() { const m = document.getElementById('custom-order-modal'); if(m) m.classList.remove('hidden'); };
        window.closeCustomOrderModal = function() { const m = document.getElementById('custom-order-modal'); if(m) m.classList.add('hidden'); };
        window.closeCheckout = function() { const cm = document.getElementById('checkout-modal'); if(cm) cm.classList.add('hidden'); };
        
        window.openChat = function(orderId, otherPhone) { 
            currentChatOrderId = orderId; 
            const order = allOrders.find(o => o.id === orderId); 
            const ct = document.getElementById('chat-title'); if(ct) ct.innerText = `ูุญุงุฏุซุฉ #${order.id.substring(0,5)}`; 
            const cc = document.getElementById('chat-call-btn'); if(cc) cc.href = `tel:${otherPhone}`; 
            const cm = document.getElementById('chat-modal'); if(cm) cm.classList.remove('hidden'); 
            window.renderChatMessages(order.chat || []); 
        };
        window.closeChat = function() { const cm = document.getElementById('chat-modal'); if(cm) cm.classList.add('hidden'); currentChatOrderId = null; };
        
        window.renderChatMessages = function(chatArray) {
            const chatBox = document.getElementById('chat-messages');
            if(!chatBox) return;
            chatBox.innerHTML = chatArray.map(c => `
                <div class="max-w-[80%] p-3 text-sm shadow-sm ${c.sender === currentUserRole ? 'chat-me' : 'chat-other'}">
                    <p class="whitespace-pre-wrap">${c.text}</p>
                    <span class="text-[9px] opacity-70 mt-1 block">${c.time}</span>
                </div>
            `).join('');
            chatBox.scrollTop = chatBox.scrollHeight;
        };

        window.openRatingModal = function(orderId, captainId, merchantId) { ratingTargetOrderId = orderId; ratingTargetCaptainId = captainId; ratingTargetMerchantId = merchantId; captStarVal = 5; merchStarVal = 5; document.querySelectorAll('#rating-captain-stars i').forEach(el => { el.classList.add('active'); el.style.color = '#fbbf24'; }); document.querySelectorAll('#rating-merchant-stars i').forEach(el => { el.classList.add('active'); el.style.color = '#fbbf24'; }); const rm = document.getElementById('rating-modal'); if(rm) rm.classList.remove('hidden'); };
        window.closeRatingModal = function() { const rm = document.getElementById('rating-modal'); if(rm) rm.classList.add('hidden'); };
        window.selectRating = function(type, val) {
            if (type === 'cap') {
                captStarVal = val;
                document.querySelectorAll('#rating-captain-stars i').forEach(el => {
                    el.classList.toggle('active', parseInt(el.dataset.val) <= val);
                    el.style.color = parseInt(el.dataset.val) <= val ? '#fbbf24' : '#d1d5db';
                });
            } else {
                merchStarVal = val;
                document.querySelectorAll('#rating-merchant-stars i').forEach(el => {
                    el.classList.toggle('active', parseInt(el.dataset.val) <= val);
                    el.style.color = parseInt(el.dataset.val) <= val ? '#fbbf24' : '#d1d5db';
                });
            }
        };

        window.openAdminEdit = function(colName, docId) { const modal = document.getElementById('admin-edit-modal'); if(!modal) return; const target = colName === 'users' ? allUsers.find(u => u.id === docId) : allStaff.find(s => s.id === docId); if(!target) return; document.getElementById('edit-user-id').value = target.id; document.getElementById('edit-user-col').value = colName; document.getElementById('edit-user-name').value = target.name; document.getElementById('edit-user-phone').value = target.phone || ''; document.getElementById('edit-user-pass').value = target.password || ''; const wNumInput = document.getElementById('edit-user-worknum'); if(colName === 'staff') { wNumInput.value = target.workNumber || ''; wNumInput.disabled = false; } else { wNumInput.value = ''; wNumInput.disabled = true; } document.getElementById('edit-user-wallet').value = target.walletBalance || 0; document.getElementById('edit-user-points').value = target.loyaltyPoints || 0; modal.classList.remove('hidden'); };
        window.closeAdminEdit = function() { const m = document.getElementById('admin-edit-modal'); if(m) m.classList.add('hidden'); };
        window.openTopUpModal = function(id, bal) { topUpTargetId = id; topUpCurrentBal = bal; document.getElementById('topup-amount').value = ''; document.getElementById('topup-modal').classList.remove('hidden'); };
        window.closeTopUpModal = function() { document.getElementById('topup-modal').classList.add('hidden'); topUpTargetId = null; };
        
        window.confirmDeleteUser = function(docId, colName) { targetDeleteId = docId; targetDeleteCol = colName; document.getElementById('delete-confirm-modal').classList.remove('hidden'); };
        window.executeDeleteUser = async function() {
            if(!targetDeleteId || !targetDeleteCol) return;
            try {
                await deleteDoc(getDocRef(targetDeleteCol, targetDeleteId));
                window.showToast('ุชู ุงูุญุฐู ุจูุฌุงุญ', 'success');
            } catch(e) { window.showToast('ูุดู ุงูุญุฐู', 'error'); }
            document.getElementById('delete-confirm-modal').classList.add('hidden');
        };

        window.sendAppNotification = async function(recipientId, message, image = null) {
            try {
                await addDoc(getCollection('notifications'), { recipientId, message, image, read: false, timestamp: serverTimestamp() });
            } catch(e) { console.error("Error sending notif", e); }
        };

        window.updateAdminNotifDropdown = function() {
            // Function exists to avoid errors, predefined statically in HTML options.
        };

        window.updateUI = function() {
            if (currentUserRole === 'customer') window.renderCustomer();
            if (currentUserRole === 'merchant') window.renderMerchant();
            if (currentUserRole === 'captain') window.renderCaptain();
            if (currentUserRole === 'admin' || currentUserRole === 'support') window.renderAdmin();
        };

        window.renderCustomer = function() {
            let searchTerm = document.getElementById('cust-search')?.value.toLowerCase() || '';
            let sortOrder = document.getElementById('cust-sort')?.value || 'none';

            const flashContainer = document.getElementById('flash-sales-container');
            const flashList = document.getElementById('flash-sales-list');
            const flashItems = allMenu.filter(m => m.isFlashSale && !m.isSoldOut);
            if(flashItems.length > 0 && flashList) {
                if(flashContainer) flashContainer.classList.remove('hidden');
                flashList.innerHTML = flashItems.map(m => `<div class="bg-red-500 text-white p-2 rounded-xl min-w-[120px] shadow border border-red-400"> <p class="text-[10px] font-bold truncate">${m.name}</p><p class="text-xs font-black">${m.price} JOD ๐ฅ</p><button onclick="window.addToCart('${m.name}', ${m.price}, '${m.merchantName}', '${m.merchantId}')" class="w-full mt-1 bg-white text-red-600 text-[10px] font-bold py-1 rounded">ุฅุถุงูุฉ ููุณูุฉ</button></div>`).join('');
            } else if(flashContainer) flashContainer.classList.add('hidden');

            if(currentStoreViewId === null) {
                const storesView = document.getElementById('cust-stores-view');
                const menuView = document.getElementById('cust-menu-view');
                if(storesView) storesView.classList.remove('hidden');
                if(menuView) menuView.classList.add('hidden');
                
                const storesList = document.getElementById('customer-stores-list');
                let merchants = allStaff.filter(s => s.role === 'merchant');
                if(currentCustCategory !== 'all') merchants = merchants.filter(m => m.businessType === currentCustCategory);
                if(searchTerm) merchants = merchants.filter(m => m.name.toLowerCase().includes(searchTerm));
                
                if(storesList) {
                    if(merchants.length > 0) {
                        storesList.innerHTML = merchants.map(m => {
                            const isOffline = !m.isOnline;
                            return `<div onclick="${isOffline ? '' : `window.openStore('${m.id}', '${m.name}')`}" class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center relative transition-transform ${isOffline ? 'opacity-60 grayscale' : 'cursor-pointer hover:shadow-md hover:-translate-y-1'}"> ${isOffline ? '<span class="absolute top-2 left-2 bg-red-500 text-white text-[9px] px-2 rounded font-bold z-10">ูุบูู</span>' : ''} <div class="w-16 h-16 bg-gray-50 rounded-full mb-3 flex items-center justify-center">${categoryIcons[m.businessType] || categoryIcons['restaurant']}</div> <h4 class="font-black text-gray-800 text-sm text-center leading-snug">${m.name}</h4> </div>`;
                        }).join('');
                    } else { storesList.innerHTML = '<p class="col-span-2 text-center text-xs text-gray-400 py-4">ูุง ููุฌุฏ ูุชุงุฌุฑ ุญุงููุงู</p>'; }
                }
            } else {
                const storesView = document.getElementById('cust-stores-view');
                const menuView = document.getElementById('cust-menu-view');
                if(storesView) storesView.classList.add('hidden');
                if(menuView) menuView.classList.remove('hidden');
                
                const menuItemsList = document.getElementById('customer-menu-items-list');
                let storeMenu = allMenu.filter(m => m.merchantId === currentStoreViewId);
                if(searchTerm) storeMenu = storeMenu.filter(m => m.name.toLowerCase().includes(searchTerm));
                if(sortOrder === 'asc') storeMenu.sort((a,b) => a.price - b.price);
                if(sortOrder === 'desc') storeMenu.sort((a,b) => b.price - a.price);

                if(menuItemsList) {
                    if(storeMenu.length > 0) {
                        const grouped = storeMenu.reduce((acc, item) => { const cat = item.category || 'ุฃุตูุงู ุนุงูุฉ'; if(!acc[cat]) acc[cat] = []; acc[cat].push(item); return acc; }, {});
                        let html = '';
                        for(const [catName, items] of Object.entries(grouped)) {
                            html += `<div class="mb-6"><h4 class="font-black text-indigo-900 text-sm mb-3 border-r-4 border-orange-500 pr-2">${catName}</h4><div class="grid grid-cols-2 gap-3">`;
                            html += items.map(item => `<div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between relative"> ${item.isSoldOut ? '<span class="absolute top-2 left-2 bg-red-500 text-white text-[9px] px-2 rounded font-bold z-10">ููุฏ</span>' : ''} <div> ${item.image ? `<img src="${item.image}" class="w-full h-16 object-cover rounded-xl mb-2 ${item.isSoldOut ? 'grayscale opacity-50' : ''}">` : ''} <h4 class="font-bold text-gray-800 text-[13px] leading-snug">${item.name}</h4> <p class="text-[9px] text-gray-400 truncate">${item.addons || ''}</p> <p class="text-blue-600 font-black text-sm my-1">${item.price.toFixed(2)} JOD</p> </div> ${item.isSoldOut ? `<button disabled class="w-full bg-gray-200 text-gray-500 text-[11px] font-bold py-2 mt-2 rounded-lg">ููุฏุช ุงููููุฉ</button>` : `<button onclick="window.addToCart('${item.name}', ${item.price}, '${item.merchantName}', '${item.merchantId}')" class="w-full bg-indigo-600 text-white text-[11px] font-bold py-2 mt-2 rounded-lg shadow-sm hover:bg-indigo-700">ุฅุถุงูุฉ ููุณูุฉ <i class="fa-solid fa-plus"></i></button>`} </div>`).join('');
                            html += `</div></div>`;
                        }
                        menuItemsList.innerHTML = html;
                    } else { menuItemsList.innerHTML = '<p class="text-center text-xs text-gray-400 py-4">ูุง ููุฌุฏ ุฃุตูุงู ูู ูุฐุง ุงููุชุฌุฑ</p>'; }
                }
            }
            window.renderCartView();
        };

        window.openStore = function(storeId, storeName) { currentStoreViewId = storeId; const title = document.getElementById('store-menu-title'); if(title) title.innerText = storeName; window.renderCustomer(); };
        window.closeStoreMenu = function() { currentStoreViewId = null; window.renderCustomer(); };
        
        window.addToCart = function(name, price, mName, mId) {
            if(customerCart.length > 0 && customerCart[0].mId !== mId) return window.showToast('ูุง ูููู ุฅุถุงูุฉ ููุชุฌุงุช ูู ูุชุงุฌุฑ ูุฎุชููุฉ ูู ููุณ ุงูุณูุฉ.', 'error');
            customerCart.push({ name, price, mName, mId }); window.showToast('ุชูุช ุงูุฅุถุงูุฉ ููุณูุฉ ๐', 'success');
            const b = document.getElementById('cart-badge'); if(b) b.classList.remove('hidden'); window.renderCartView();
        };

        window.renderCartView = function() {
            const cartList = document.getElementById('real-cart-list'); const btnGoCheckout = document.getElementById('btn-go-checkout');
            if(cartList) {
                if(customerCart.length === 0) {
                    cartList.innerHTML = `<p class="text-xs text-gray-400 text-center py-4">ุณูุชู ูุงุฑุบุฉ ุญุงููุงู.</p>`; if(btnGoCheckout) btnGoCheckout.classList.add('hidden');
                } else {
                    let total = 0;
                    let html = customerCart.map((c, index) => { total += c.price; return `<div class="bg-white p-3 rounded-xl border border-gray-200 flex justify-between items-center shadow-sm"> <div><p class="text-sm font-bold text-gray-800">${c.name}</p><p class="text-[10px] text-gray-500">${c.mName}</p></div> <div class="flex items-center gap-3"><span class="text-sm font-black text-indigo-600">${c.price.toFixed(2)}</span> <button onclick="window.removeFromCart(${index})" class="text-red-500 hover:text-red-700 bg-red-50 p-1.5 rounded"><i class="fa-solid fa-trash text-xs"></i></button></div> </div>`; }).join('');
                    html += `<div class="text-left mt-2"><span class="text-xs font-bold text-gray-600">ุงููุฌููุน ุงููุฑุนู: </span><span class="font-black text-lg text-gray-900">${total.toFixed(2)} JOD</span></div>`;
                    cartList.innerHTML = html; if(btnGoCheckout) btnGoCheckout.classList.remove('hidden');
                }
            }

            const list = document.getElementById('customer-orders-list'); const myOrders = allOrders.filter(o => o.customerId === (currentUserData?.uid || 'demo_cust'));
            if(list) {
                if (myOrders.length === 0) { list.innerHTML = `<div class="text-center py-10 opacity-50"><i class="fa-solid fa-clock-rotate-left text-4xl mb-3 text-gray-300"></i><p class="text-sm font-bold text-gray-400">ูุง ููุฌุฏ ุทูุจุงุช ุณุงุจูุฉ</p></div>`; }
                else {
                    list.innerHTML = myOrders.map(order => `
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 relative">
                            <div class="flex justify-between items-center mb-3"><span class="font-bold text-gray-800 text-sm">#${order.id.substring(0,5)}</span><span class="text-[10px] px-2 py-1 rounded-md font-bold ${statusMap[order.status]?.color || 'bg-gray-100 text-gray-700'}">${statusMap[order.status]?.text || 'ุบูุฑ ูุนุฑูู'}</span></div>
                            <p class="text-xs font-bold text-gray-600 mb-2 bg-gray-50 p-2 rounded-lg leading-relaxed">${(order.item || '').replace(/\n/g, '<br>')}</p>
                            ${order.notes ? `<p class="text-[10px] text-orange-600 font-bold mb-2"><i class="fa-solid fa-note-sticky"></i> ${order.notes}</p>` : ''}
                            ${order.scheduledTime && order.scheduledTime !== 'now' ? `<p class="text-[10px] text-blue-600 font-bold mb-2"><i class="fa-solid fa-clock"></i> ุทูุจ ูุฌุฏูู</p>` : ''}
                            <div class="flex justify-between items-center border-t border-gray-100 pt-3 mt-2">
                                <span class="font-black text-blue-600 text-sm">${order.type === 'custom' ? 'ุงูุฏูุน ุนุงููุงุชูุฑุฉ' : (order.cashToPay !== undefined ? order.cashToPay.toFixed(2) : (order.price + order.deliveryFee).toFixed(2)) + ' JOD'}</span>
                                <div class="flex gap-1 flex-wrap justify-end max-w-[60%]">
                                    ${order.status === 'on_the_way' ? `<button onclick="window.openChat('${order.id}', '${order.captainPhone||'0000'}')" class="bg-blue-100 text-blue-700 px-2 py-1.5 rounded-lg text-[10px] font-bold shadow-sm hover:bg-blue-200"><i class="fa-solid fa-comments"></i> ุดุงุช/ุงุชุตุงู</button>` : ''}
                                    ${order.status === 'delivered' ? `<button onclick="window.reorderItems('${(order.item||'').replace(/'/g, "\\'")}', ${order.price}, '${order.merchantName}', '${order.merchantId}')" class="bg-indigo-100 text-indigo-700 px-2 py-1.5 rounded-lg text-[10px] font-bold shadow-sm hover:bg-indigo-200"><i class="fa-solid fa-rotate-right"></i> ุฅุนุงุฏุฉ ุทูุจ</button>` : ''}
                                    ${order.status === 'delivered' && !order.rated && order.captainId ? `<button onclick="window.openRatingModal('${order.id}', '${order.captainId}', '${order.merchantId}')" class="bg-yellow-400 text-yellow-900 px-2 py-1.5 rounded-lg text-[10px] font-bold shadow-sm"><i class="fa-solid fa-star"></i> ุชูููู</button>` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            }

            const histList = document.getElementById('profile-order-history');
            if(histList) {
                const delOrders = myOrders.filter(o => o.status === 'delivered');
                if(delOrders.length === 0) {
                    histList.innerHTML = '<p class="text-xs text-gray-400 text-center py-2">ูุง ููุฌุฏ ุทูุจุงุช ุณุงุจูุฉ</p>';
                } else {
                    histList.innerHTML = delOrders.map(o => `
                        <div class="bg-gray-50 p-2 rounded-xl border border-gray-100 flex justify-between items-center">
                            <div>
                                <p class="text-xs font-bold text-gray-800">#${o.id.substring(0,5)} - ${o.merchantName || 'ูุฒุนุฉ'}</p>
                                <p class="text-[9px] text-gray-500">${(o.timestamp?.toDate() || new Date()).toLocaleDateString('ar-JO')}</p>
                            </div>
                            <span class="text-xs font-black text-indigo-600">${(o.price + o.deliveryFee).toFixed(2)} JOD</span>
                        </div>
                    `).join('');
                }
            }
        };

        window.removeFromCart = function(index) { customerCart.splice(index, 1); window.renderCartView(); if(customerCart.length === 0) { const b = document.getElementById('cart-badge'); if(b) b.classList.add('hidden'); } };
        window.reorderItems = function(itemsStr, price, mName, mId) { customerCart = []; window.addToCart(itemsStr.split('\n')[0].replace('<br>', ''), price, mName, mId); window.openCheckout(); };

        window.openCheckout = function() {
            if(customerCart.length === 0) return;
            const mId = customerCart[0].mId; const mName = customerCart[0].mName; const merchant = allStaff.find(s => s.id === mId);
            if(merchant && !merchant.isOnline) return window.showToast('ุนุฐุฑุงูุ ุงููุชุฌุฑ ูุบูู ุญุงููุงู ๐ซ', 'error');

            let totalP = 0; let combinedItems = customerCart.map(c => { totalP += c.price; return c.name; }).join(' + \n');
            checkoutItem = { name: combinedItems, basePrice: totalP, mName: mName, mId: mId }; checkoutBasePrice = totalP; walletDiscountActive = false; appliedWalletDiscount = 0;
            
            const summ = document.getElementById('checkout-items-summary'); if(summ) summ.innerHTML = combinedItems.replace(/\n/g, '<br>');
            const cip = document.getElementById('checkout-item-price'); if(cip) cip.innerText = `${totalP.toFixed(2)} JOD`;
            const cdf = document.getElementById('checkout-delivery-fee'); if(cdf) cdf.innerText = `${checkoutDelivery.toFixed(2)} JOD`;
            
            const wallSec = document.getElementById('checkout-wallet-section'); const cb = document.getElementById('checkout-use-wallet'); const myBal = currentUserData?.walletBalance || 0;
            if(myBal > 0 && wallSec) { wallSec.classList.remove('hidden'); document.getElementById('checkout-wallet-bal').innerText = myBal.toFixed(2); if(cb) cb.checked = false; } else if(wallSec) { wallSec.classList.add('hidden'); }
            
            window.updateCheckoutTotal(); document.getElementById('checkout-modal').classList.remove('hidden');
        };

        window.toggleWalletDiscount = function() {
            walletDiscountActive = document.getElementById('checkout-use-wallet')?.checked || false;
            window.updateCheckoutTotal();
        };

        window.renderMerchant = function() {
            const list = document.getElementById('merchant-orders-list'); const activeOrders = allOrders.filter(o => (o.status === 'pending' || o.status === 'preparing') && o.merchantId === currentUserData?.id);
            if(list) {
                if (activeOrders.length === 0) list.innerHTML = '<p class="text-center py-12 text-gray-400 text-sm">ูุง ููุฌุฏ ุทูุจุงุช ุฌุฏูุฏุฉ</p>';
                else {
                    list.innerHTML = activeOrders.map(order => `
                        <div class="bg-white p-4 rounded-2xl shadow-sm border-r-4 ${order.status === 'pending' ? 'border-pink-500' : 'border-orange-500'}">
                            <div class="flex justify-between items-start mb-3"><div><span class="font-bold text-gray-800 text-sm block">${order.customerName}</span><span class="text-xs text-gray-500">${order.customerPhone}</span></div> <div class="flex gap-2"><button onclick="window.openChat('${order.id}', '${order.customerPhone}')" class="bg-blue-50 text-blue-600 px-2 py-1 rounded text-xs"><i class="fa-solid fa-phone"></i> ุชูุงุตู</button><button onclick="window.printReceipt('${order.id}')" class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs"><i class="fa-solid fa-print"></i></button></div></div>
                            <p class="text-sm font-black bg-pink-50 text-pink-900 p-3 rounded-xl mb-2 text-center leading-relaxed">${(order.item || '').replace(/\n/g, '<br>')}</p>
                            ${order.notes ? `<p class="text-[11px] font-bold text-red-600 mb-3 bg-red-50 p-2 rounded text-center">ููุงุญุธุฉ ุงูุฒุจูู: ${order.notes}</p>` : ''}
                            ${order.scheduledTime && order.scheduledTime !== 'now' ? `<p class="text-xs font-bold text-blue-600 mb-3 bg-blue-50 p-2 rounded text-center"><i class="fa-solid fa-clock"></i> ุทูุจ ูุฌุฏูู!</p>` : ''}
                            ${order.status === 'pending' ? `<button onclick="window.updateOrderStatus('${order.id}', 'preparing')" class="w-full bg-orange-500 text-white py-3 rounded-xl text-sm font-bold shadow-md">ุจุฏุก ุงูุชุฌููุฒ</button>` : `<button onclick="window.updateOrderStatus('${order.id}', 'ready')" class="w-full bg-green-500 text-white py-3 rounded-xl text-sm font-bold shadow-md">ุฌุงูุฒุ ุงุณุชุฏุนุงุก ุงููุงุจุชู</button>`}
                        </div>
                    `).join('');
                }
            }
            const menuList = document.getElementById('merchant-menu-list'); const myMenu = allMenu.filter(m => m.merchantId === currentUserData?.id);
            if(menuList) {
                if(myMenu.length === 0) menuList.innerHTML = '<p class="text-xs text-gray-400">ุงููุงุฆูุฉ ูุงุฑุบุฉ</p>';
                else {
                    const grouped = myMenu.reduce((acc, i) => { const c = i.category||'ุนุงู'; if(!acc[c]) acc[c]=[]; acc[c].push(i); return acc; }, {});
                    let html = '';
                    for(const [cat, items] of Object.entries(grouped)) {
                        html += `<h4 class="font-bold text-xs text-indigo-500 mt-4 mb-2">${cat}</h4>` + items.map(item => `<div class="bg-white p-3 rounded-xl border border-gray-100 flex justify-between items-center shadow-sm mb-2"><div><p class="font-bold text-sm text-gray-800 ${item.isSoldOut?'line-through text-red-500':''}">${item.name}</p><p class="text-xs text-green-600 font-black">${item.price.toFixed(2)} JOD</p></div> <div class="flex items-center gap-2"><button onclick="window.toggleMenuSoldOut('${item.id}', ${item.isSoldOut})" class="text-[10px] ${item.isSoldOut?'bg-green-100 text-green-700':'bg-red-100 text-red-700'} px-2 py-1 rounded font-bold">${item.isSoldOut?'ุฅุฑุฌุงุน ููุจูุน':'ููุฏุช'}</button> <button onclick="window.deleteMenuItem('${item.id}')" class="text-gray-400 hover:text-red-500 p-2 rounded-lg"><i class="fa-solid fa-trash"></i></button></div></div>`).join('');
                    }
                    menuList.innerHTML = html;
                }
            }
            let todaySales = 0; let totalOrders = 0; let monthSales = 0;
            allOrders.filter(o => o.merchantId === currentUserData?.id && o.status === 'delivered').forEach(o => { todaySales += o.price; monthSales += o.price; totalOrders++; });
            const sToday = document.getElementById('merch-sales-today'); if(sToday) sToday.innerText = `${todaySales.toFixed(2)} JOD`; 
            const sMonth = document.getElementById('merch-sales-month'); if(sMonth) sMonth.innerText = `${monthSales.toFixed(2)} JOD`; 
            const oCount = document.getElementById('merch-orders-count'); if(oCount) oCount.innerText = totalOrders;
        };

        window.toggleMerchantStatus = async function(el) {
            if(currentUserRole !== 'merchant' || !currentUserData) return;
            try {
                await updateDoc(getDocRef('staff', currentUserData.id), { isOnline: el.checked });
                window.showToast(el.checked ? 'ุงููุชุฌุฑ ูุชุงุญ ูุงุณุชูุจุงู ุงูุทูุจุงุช' : 'ุชู ุฅุบูุงู ุงููุชุฌุฑ ูุคูุชุงู', 'info');
            } catch(e) { window.showToast('ุญุฏุซ ุฎุทุฃ', 'error'); }
        };

        window.toggleMenuSoldOut = async function(id, currentState) {
            try {
                await updateDoc(getDocRef('menu', id), { isSoldOut: !currentState });
            } catch(e) { window.showToast('ุญุฏุซ ุฎุทุฃ', 'error'); }
        };

        window.addMenuItem = async function() {
            if(currentUserRole !== 'merchant') return;
            const name = document.getElementById('new-item-name').value.trim();
            const cat = document.getElementById('new-item-category').value.trim();
            const price = parseFloat(document.getElementById('new-item-price').value);
            const addons = document.getElementById('new-item-addons').value.trim();
            const isFlash = document.getElementById('new-item-flash').checked;

            if(!name || !cat || isNaN(price)) return window.showToast('ุฃููู ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ ูุงูุณุนุฑ', 'error');

            try {
                await addDoc(getCollection('menu'), {
                    merchantId: currentUserData.id,
                    merchantName: currentUserData.name,
                    name: name,
                    category: cat,
                    price: price,
                    addons: addons,
                    isFlashSale: isFlash,
                    isSoldOut: false,
                    image: '', 
                    timestamp: serverTimestamp()
                });
                window.showToast('ุชูุช ุฅุถุงูุฉ ุงูุตูู ุจูุฌุงุญ', 'success');
                document.getElementById('new-item-name').value = '';
                document.getElementById('new-item-price').value = '';
            } catch(e) { window.showToast('ุฎุทุฃ ุฃุซูุงุก ุงูุฅุถุงูุฉ', 'error'); }
        };

        window.askAIFood = function() {
            const res = document.getElementById('ai-food-result');
            if (res) {
                res.classList.remove('hidden');
                res.innerHTML = "โจ ุงููุณุงุนุฏ ุงูุฐูู ููุชุฑุญ ุนููู: 'ุดุงูุฑูุง ุฏุจู' ูู ุฃูุฑุจ ูุทุนู ูู! ๐ (ููุฒุฉ ุชุฌุฑูุจูุฉ)";
            }
        };

        window.generateAIItemName = function() {
            const input = document.getElementById('new-item-name');
            if(input && input.value.trim()) input.value = "โจ " + input.value + " ุงููููุฒ";
        };

        window.previewImageName = function(input) {
            const preview = document.getElementById('image-preview-name');
            if(input.files && input.files[0] && preview) {
                preview.innerText = "ุตูุฑุฉ ุงููุฑููุฉ: " + input.files[0].name;
                preview.classList.remove('hidden');
            } else if (preview) {
                preview.classList.add('hidden');
            }
        };

        window.renderCaptain = function() {
            const list = document.getElementById('captain-orders-list'); const activeOrders = allOrders.filter(o => o.status === 'ready' || (o.status === 'on_the_way' && o.captainId === currentUserData?.id));
            const bal = currentUserData?.walletBalance || 0;
            if(list) {
                if (activeOrders.length === 0) list.innerHTML = '<p class="text-center py-12 text-gray-400 text-sm">ูุง ููุฌุฏ ุทูุจุงุช ุฌุงูุฒุฉ ุญุงููุงู</p>';
                else {
                    list.innerHTML = activeOrders.map(order => {
                        const disableAccept = bal < MIN_WALLET_BALANCE && order.status === 'ready';
                        return `
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-200">
                            <div class="flex justify-between items-center mb-4"><span class="font-black text-gray-800 text-sm truncate">${(order.item || '').substring(0,30)}..</span><span class="text-[10px] bg-orange-100 text-orange-700 px-2 py-1 rounded-lg font-bold">ุฃุฌุฑุชู: ${order.deliveryFee.toFixed(2)} JOD</span></div>
                            <div class="bg-gray-50 p-3 rounded-xl mb-4 space-y-2">
                                <div class="flex justify-between items-center"><span class="text-xs font-bold text-gray-700"><i class="fa-solid fa-location-dot text-red-500"></i> ${order.customerLocation}</span>${order.status === 'on_the_way' ? `<button onclick="window.openChat('${order.id}', '${order.customerPhone}')" class="bg-blue-100 text-blue-700 px-2 py-1.5 rounded text-xs font-bold"><i class="fa-solid fa-comments"></i> ุดุงุช</button>` : ''}</div>
                                ${order.type === 'custom' ? `<span class="text-[10px] text-red-500 font-bold bg-red-50 px-2 py-1 rounded w-fit">ุทูุจ ุฎุงุฑุฌู (ุญุงุณุจ ุนุงููุงุชูุฑุฉ)</span>` : ''}
                            </div>
                            ${order.status === 'ready' ? `<button ${disableAccept ? 'disabled' : ''} onclick="window.updateOrderStatus('${order.id}', 'on_the_way')" class="w-full ${disableAccept ? 'bg-gray-300' : 'bg-blue-600 hover:bg-blue-700'} text-white py-3.5 rounded-xl text-sm font-bold shadow-md">ุงุณุชูุงู ุงูุทูุจ ๐จ</button>` : `<button onclick="window.finishDelivery('${order.id}', ${order.deliveryFee})" class="w-full bg-green-500 text-white py-3.5 rounded-xl text-sm font-bold shadow-md">ุชู ุงูุชุณููู โ</button>`}
                        </div>
                    `}).join('');
                }
            }
        };

        window.renderAdmin = function() {
            if(currentUserRole === 'support') {
                const ft = document.getElementById('tab-admin-finance'); if(ft) ft.classList.add('hidden');
                const dt = document.getElementById('admin-dash-content'); if(dt) dt.classList.add('hidden');
            }
            let totalSales = 0; allOrders.forEach(o => { if(o.status === 'delivered' && o.type !== 'custom') totalSales += (o.price + o.deliveryFee); });
            const sTotal = document.getElementById('admin-total-sales'); if(sTotal) sTotal.innerText = totalSales.toFixed(2); 
            const sProf = document.getElementById('admin-profits'); if(sProf) sProf.innerText = (totalSales * adminCommissionRate).toFixed(2);
            
            // ุชุญุฏูุซ ุงููุจุงุชู ุงูุญูุฉ
            const capCount = document.getElementById('live-captains-count');
            if (capCount) capCount.innerText = allStaff.filter(s => s.role === 'captain' && s.isOnline).length;

            const list = document.getElementById('admin-orders-list');
            if(list) {
                if (allOrders.length === 0) list.innerHTML = '<p class="text-center text-gray-400 py-8 text-sm">ูุง ูุดุงุท</p>';
                else list.innerHTML = allOrders.slice(0,20).map(order => `<div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center mb-2"><div><p class="font-bold text-sm text-gray-800">${(order.item || '').substring(0,25)}..</p><p class="text-[10px] ${statusMap[order.status]?.color || 'bg-gray-100 text-gray-700'} px-2 py-0.5 rounded-full mt-1 font-bold inline-block">${statusMap[order.status]?.text || 'ุบูุฑ ูุนุฑูู'}</p></div><div class="text-left"><p class="font-black text-sm text-indigo-600">${order.type==='custom'?'ูุงุชูุฑุฉ':(order.price+order.deliveryFee).toFixed(2)} JOD</p></div></div>`).join('');
            }
        };

        window.renderAdminStaffList = function() {
            const list = document.getElementById('admin-staff-list'); if(!list) return;
            let html = '';
            const roles = [ { id: 'admin', title: '๐ก๏ธ ุงูุฅุฏุงุฑุฉ' }, { id: 'support', title: '๐ง ุงูุฏุนู ุงูููู' }, { id: 'merchant', title: '๐ช ุงููุชุงุฌุฑ ุงูุดุฑููุฉ' }, { id: 'captain', title: '๐ต ุงููุจุงุชู' } ];
            roles.forEach(r => {
                const group = allStaff.filter(s => s.role === r.id);
                if(group.length > 0) {
                    html += `<h4 class="font-black text-indigo-900 text-xs mt-4 mb-2 bg-indigo-50 p-2 rounded">${r.title} (${group.length})</h4>`;
                    html += group.map(member => `
                        <div class="bg-white p-3 rounded-xl shadow-sm border ${member.banned ? 'border-red-300 bg-red-50' : 'border-gray-100'} flex justify-between items-center mb-2"> 
                            <div> 
                                <p class="font-bold text-sm ${member.banned ? 'text-red-700 line-through' : 'text-gray-800'}">${member.name}</p> 
                                <p class="text-[10px] text-gray-500 font-bold">ID: <span class="text-indigo-600">${member.workNumber}</span> ${member.role==='captain'? `| ูุญูุธุฉ: <span class="text-green-600">${(member.walletBalance||0).toFixed(2)}</span>` : ''}</p> 
                            </div> 
                            <div class="flex gap-1 flex-col items-end"> 
                                ${member.role === 'captain' ? `<button onclick="window.openTopUpModal('${member.id}', ${member.walletBalance || 0})" class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold w-full"><i class="fa-solid fa-plus"></i> ุฑุตูุฏ</button>` : ''} 
                                <div class="flex gap-1 mt-1">
                                    <button onclick="window.openAdminEdit('staff', '${member.id}')" class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-[9px] font-bold"><i class="fa-solid fa-pen"></i></button> 
                                    <button onclick="window.toggleBan('staff', '${member.id}', ${member.banned})" class="${member.banned ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'} px-2 py-1 rounded text-[9px] font-bold"><i class="fa-solid ${member.banned ? 'fa-unlock' : 'fa-ban'}"></i></button>
                                    <button onclick="window.confirmDeleteUser('${member.id}', 'staff')" class="bg-red-100 text-red-700 px-2 py-1 rounded text-[9px] font-bold"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </div> 
                        </div>`).join('');
                }
            });
            if(allUsers.length > 0) {
                html += `<h4 class="font-black text-indigo-900 text-xs mt-4 mb-2 bg-indigo-50 p-2 rounded">๐ฑ ุงูุฒุจุงุฆู (${allUsers.length})</h4>`;
                html += allUsers.map(u => `
                    <div class="bg-white p-3 rounded-xl shadow-sm border ${u.banned ? 'border-red-300 bg-red-50' : 'border-gray-100'} flex justify-between items-center mb-2"> 
                        <div> 
                            <p class="font-bold text-sm ${u.banned ? 'text-red-700 line-through' : 'text-gray-800'}">${u.name}</p> 
                            <p class="text-[10px] text-gray-500 font-bold">ูุงุชู: ${u.phone} | ููุงุท: <span class="text-yellow-600">${u.loyaltyPoints||0}</span></p> 
                        </div> 
                        <div class="flex gap-1 flex-col items-end"> 
                            <div class="flex gap-1 mt-1">
                                <button onclick="window.openAdminEdit('users', '${u.id}')" class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-[10px] font-bold"><i class="fa-solid fa-pen"></i></button> 
                                <button onclick="window.toggleBan('users', '${u.id}', ${u.banned})" class="${u.banned ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'} px-2 py-1 rounded text-[9px] font-bold"><i class="fa-solid ${u.banned ? 'fa-unlock' : 'fa-ban'}"></i></button>
                                <button onclick="window.confirmDeleteUser('${u.id}', 'users')" class="bg-red-100 text-red-700 px-2 py-1 rounded text-[9px] font-bold"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div> 
                    </div>`).join('');
            }
            if(!html) html = '<p class="text-center text-gray-400 py-6 text-sm">ูุง ููุฌุฏ ูุณุชุฎุฏููู</p>';
            list.innerHTML = html;
        };

        window.renderAdminFinance = function() {
            const list = document.getElementById('admin-points-requests'); if(!list) return;
            const pending = allPointRequests.filter(r => r.status === 'pending');
            if(pending.length === 0) { list.innerHTML = '<p class="text-xs text-gray-400 text-center py-4">ูุง ุชูุฌุฏ ุทูุจุงุช ุชุญููู ุฌุฏูุฏุฉ</p>'; return; }
            list.innerHTML = pending.map(r => `<div class="bg-white p-3 rounded-xl border border-yellow-200 shadow-sm flex justify-between items-center mb-2"> <div><p class="font-bold text-sm text-gray-800">${r.customerName}</p><p class="text-xs text-gray-500">ูุทูุจ ุชุญููู ${r.points} ููุทุฉ ูู ${r.money} ุฏููุงุฑ</p></div> <div class="flex gap-1"><button onclick="window.approvePointRequest('${r.id}', '${r.customerId}')" class="bg-green-100 text-green-700 px-3 py-1.5 rounded text-xs font-bold">ููุงููุฉ</button><button onclick="window.rejectPointRequest('${r.id}')" class="bg-red-100 text-red-700 px-2 py-1.5 rounded text-xs font-bold"><i class="fa-solid fa-xmark"></i></button></div> </div>`).join('');
        };

        window.updateNotificationsUI = function() {
            if(!currentUserData) return;
            const myId = currentUserRole === 'customer' ? currentUserData.uid : currentUserData.id;
            const myNotifs = allNotifications.filter(n => n.recipientId === myId || n.recipientId === 'all' || n.recipientId === `${currentUserRole}s`);
            const unreadCount = myNotifs.filter(n => !n.read).length;
            if(currentUserRole === 'customer') { const b = document.getElementById('cust-notif-badge'); if(b) b.classList.toggle('hidden', unreadCount === 0); }
            if(currentUserRole === 'merchant') { const b = document.getElementById('merch-notif-badge'); if(b) b.classList.toggle('hidden', unreadCount === 0); }
            if(currentUserRole === 'captain') { const b = document.getElementById('capt-notif-badge'); if(b) b.classList.toggle('hidden', unreadCount === 0); }
            const list = document.getElementById('notifications-list'); if(!list) return;
            if(myNotifs.length === 0) { list.innerHTML = '<p class="text-center text-xs text-gray-400 py-10">ูุง ุชูุฌุฏ ุฅุดุนุงุฑุงุช</p>'; return; }
            list.innerHTML = myNotifs.map(n => `<div class="p-3 bg-white rounded-xl shadow-sm border ${n.read ? 'border-gray-100 opacity-70' : 'border-indigo-200 bg-indigo-50/30'}"> ${n.image ? `<img src="${n.image}" class="w-full h-24 object-cover rounded-lg mb-2">` : ''} <p class="text-sm font-bold text-gray-800">${n.message}</p></div>`).join('');
        };

        window.updateCaptainWalletUI = function() {
            if(currentUserRole !== 'captain' || !currentUserData) return;
            const bal = currentUserData.walletBalance || 0; const disp = document.getElementById('captain-wallet-display'); if(disp) disp.innerText = bal.toFixed(2);
            const overlay = document.getElementById('captain-wallet-overlay'); const badge = document.getElementById('captain-status-badge');
            if(bal < MIN_WALLET_BALANCE) { if(overlay) overlay.classList.remove('hidden'); if(badge) { badge.className = "bg-red-500/20 text-red-500 border border-red-500/50 px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1"; badge.innerHTML = `<i class="fa-solid fa-lock"></i> ููููู`; }
            } else { if(overlay) overlay.classList.add('hidden'); if(badge) { badge.className = "bg-green-500/20 text-green-400 border border-green-500/50 px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1"; badge.innerHTML = `<div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div> ูุชุงุญ`; } }
            window.renderCaptain();
        };

        window.updateCheckoutTotal = function() {
            const totalCost = checkoutBasePrice + checkoutDelivery; const myBal = currentUserData?.walletBalance || 0;
            if(walletDiscountActive) appliedWalletDiscount = Math.min(totalCost, myBal); else appliedWalletDiscount = 0;
            const finalCash = totalCost - appliedWalletDiscount; const tEl = document.getElementById('checkout-total-price'); if(tEl) tEl.innerText = `${finalCash.toFixed(2)} JOD`;
        };

        window.applyAppSettings = function() {
            const n1 = document.getElementById('app-name-display-1'); if(n1) n1.innerText = appSettings.name || 'ูุฒุนููุฉ'; 
            const n2 = document.getElementById('app-name-display-2'); if(n2) n2.innerText = appSettings.name || 'ูุฒุนููุฉ';
            const logoContainer = document.getElementById('app-logo-container');
            if(logoContainer) { 
                if(appSettings.logo) { 
                    logoContainer.innerHTML = `<img src="${appSettings.logo}" class="w-full h-full object-cover">`; 
                    logoContainer.classList.remove('p-4'); 
                } else { 
                    logoContainer.innerHTML = `<i class="fa-solid fa-rocket text-orange-500"></i>`; 
                } 
            }
        };

        window.setupCustomerProfile = function() {
            const n = document.getElementById('cust-name-display'); if(n) n.innerText = currentUserData.name; 
            const l = document.getElementById('cust-loc-display'); if(l) l.innerText = currentUserData.location; 
            const pn = document.getElementById('prof-name'); if(pn) pn.innerText = currentUserData.name;
            const pp = document.getElementById('prof-phone'); if(pp) pp.innerText = currentUserData.phone;
            const pl = document.getElementById('prof-loc'); if(pl) pl.innerText = currentUserData.location;
            const pts = document.getElementById('prof-points'); if(pts) pts.innerText = currentUserData.loyaltyPoints || 0;
            const cpts = document.getElementById('cust-points-display'); if(cpts) cpts.innerText = currentUserData.loyaltyPoints || 0;
            const pw = document.getElementById('prof-wallet'); if(pw) pw.innerText = (currentUserData.walletBalance || 0).toFixed(2);
            const convertBtn = document.getElementById('convert-points-section'); if(convertBtn) { if((currentUserData.loyaltyPoints || 0) >= 1000) convertBtn.classList.remove('hidden'); else convertBtn.classList.add('hidden'); }
            window.switchCustTab('home'); window.updateNotificationsUI();
        };

        window.loginCustomer = async function() { const phone = document.getElementById('login-phone').value.trim(); const pass = document.getElementById('login-password').value; if(!phone || !pass) return window.showToast('ุฃุฏุฎู ุงูุจูุงูุงุช', 'error'); const foundUser = allUsers.find(u => u.phone === phone && u.password === pass); if (foundUser) { if(foundUser.banned) return window.showToast('ุญุณุงุจ ูุญุธูุฑ ๐ซ', 'error'); currentUserData = foundUser; currentUserRole = 'customer'; window.setupCustomerProfile(); window.showView('customer'); } else window.showToast('ุงูุจูุงูุงุช ุบูุฑ ุตุญูุญุฉ', 'error'); };
        window.loginStaff = async function() { const role = document.getElementById('login-staff-role').value; const workNum = document.getElementById('login-staff-worknum').value.trim().toUpperCase(); const pass = document.getElementById('login-staff-password').value; if (role === 'admin' && workNum === '2150502071' && pass === 'Moath1234') { currentUserRole = 'admin'; currentUserData = { name: 'ูุนุงุฐ ุงูุฎูุงูุฏุฉ', role: 'admin' }; const an = document.getElementById('admin-name-display'); if(an) an.innerText = 'ูุนุงุฐ'; window.showView('admin'); return; } const foundStaff = allStaff.find(s => s.role === role && s.workNumber === workNum && s.password === pass); if (foundStaff) { if(foundStaff.banned) return window.showToast('ุงูุญุณุงุจ ูุญุธูุฑ ๐ซ', 'error'); currentUserData = foundStaff; currentUserRole = role; if (role === 'admin' || role === 'support') { const an = document.getElementById('admin-name-display'); if(an) an.innerText = currentUserData.name.split(' ')[0]; window.showView('admin'); } else if (role === 'merchant') { const mn = document.getElementById('merchant-name-display'); if(mn) mn.innerText = currentUserData.name; window.showView('merchant'); } else if (role === 'captain') { const cn = document.getElementById('captain-name-display'); if(cn) cn.innerText = currentUserData.name; const cr = document.getElementById('captain-rating-display'); if(cr) cr.innerText = currentUserData.ratingCount ? (currentUserData.ratingSum / currentUserData.ratingCount).toFixed(1) : '5.0'; window.updateCaptainWalletUI(); window.showView('captain'); } window.updateNotificationsUI(); } else { window.showToast('ุงูุจูุงูุงุช ุบูุฑ ุตุญูุญุฉ', 'error'); } };
        window.registerCustomer = async function() { const name = document.getElementById('reg-name').value.trim(); const phone = document.getElementById('reg-phone').value.trim(); const loc = document.getElementById('reg-location').value.trim(); const pass = document.getElementById('reg-password').value; if(!name || !phone || !loc || !pass) return window.showToast('ุฃููู ุงูุญููู', 'error'); const uid = "cust_" + Math.random().toString(36).substr(2, 9); currentUserData = { uid: uid, name: name, phone: phone, location: loc, password: pass, role: 'customer', loyaltyPoints: 0, walletBalance: 0, banned: false }; await addDoc(getCollection('users'), currentUserData); currentUserRole = 'customer'; window.setupCustomerProfile(); window.showView('customer'); window.showToast('ุชู ุงูุชุณุฌูู ุจูุฌุงุญ', 'success'); window.sendAppNotification(uid, 'ุฃููุงู ุจู ูู ูุฒุนุฉ!'); };
        
        window.seedDummyData = async function() {
            if(currentUserRole !== 'admin') return;
            window.showToast('ุฌุงุฑู ุฅุถุงูุฉ ุจูุงูุงุช ุชุฌุฑูุจูุฉ...', 'info');
            try {
                await addDoc(getCollection('staff'), { role: 'merchant', businessType: 'restaurant', name: 'ูุทุนู ูุฒุนุฉ', workNumber: 'QE-1111', phone: '0790000000', password: '123', walletBalance: 0, isOnline: true, banned: false, createdAt: serverTimestamp() });
                await addDoc(getCollection('staff'), { role: 'captain', name: 'ูุงุจุชู ุฃุญูุฏ', workNumber: 'QE-2222', phone: '0780000000', password: '123', walletBalance: 15, isOnline: true, banned: false, ratingCount: 0, ratingSum: 0, createdAt: serverTimestamp() });
                window.showToast('ุชูุช ุฅุถุงูุฉ ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ!', 'success');
            } catch(e) { window.showToast('ูุดู ุฅุถุงูุฉ ุงูุจูุงูุงุช', 'error'); }
        };

        window.addPromo = async function() {
            if(currentUserRole !== 'admin') return;
            const code = document.getElementById('new-promo-code').value.trim().toUpperCase();
            const discount = parseFloat(document.getElementById('new-promo-discount').value);
            if(!code || isNaN(discount)) return window.showToast('ุฃุฏุฎู ุงูููุฏ ููููุฉ ุงูุฎุตู', 'error');
            try {
                await addDoc(getCollection('promos'), { code, discount, active: true });
                window.showToast('ุชู ุฅุตุฏุงุฑ ุงูููุจูู ุจูุฌุงุญ', 'success');
                document.getElementById('new-promo-code').value = '';
                document.getElementById('new-promo-discount').value = '';
            } catch(e) { window.showToast('ุฎุทุฃ ุฃุซูุงุก ุงูุฅุตุฏุงุฑ', 'error'); }
        };

        window.registerStaff = async function() { if (currentUserRole !== 'admin') return; const role = document.getElementById('new-staff-role').value; const cat = role === 'merchant' ? document.getElementById('new-staff-category').value : null; const name = document.getElementById('new-staff-name').value.trim(); const phone = document.getElementById('new-staff-phone').value.trim(); const pass = document.getElementById('new-staff-password').value; const cWorkNum = document.getElementById('new-staff-worknum').value.trim(); const workNum = (role === 'admin' && cWorkNum) ? cWorkNum : `QE-${Math.floor(1000 + Math.random() * 9000)}`; if(!name || !phone || !pass || (role === 'admin' && !cWorkNum)) return window.showToast('ุฃููู ุงูุจูุงูุงุช ุจุงููุงูู', 'error'); await addDoc(getCollection('staff'), { role, businessType: cat, name, workNumber: workNum, phone, password: pass, walletBalance: 0, isOnline: true, banned: false, createdAt: serverTimestamp() }); window.showToast(`ุชู ุฅุถุงูุฉ ${name}. ุฑููู: ${workNum}`, 'success'); document.getElementById('new-staff-name').value = ''; document.getElementById('new-staff-phone').value = ''; document.getElementById('new-staff-password').value = ''; document.getElementById('new-staff-worknum').value = ''; };
        window.logout = function() { currentUserRole = ''; currentUserData = null; customerCart = []; window.showView('login'); };
        window.getLocation = function() { const locInput = document.getElementById('reg-location'); locInput.value = "ุฌุงุฑู ุงูุจุญุซ..."; if (navigator.geolocation) { navigator.geolocation.getCurrentPosition((pos) => { locInput.value = `${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`; window.showToast('ุชู ุงูุชูุงุท ุงููููุน', 'success'); }, (e) => { window.showToast('ุงุณูุญ ุจุงููุตูู', 'error'); }, { enableHighAccuracy: true }); } else { window.showToast('ูุง ูุฏุนู', 'error'); } };
        
        window.confirmOrderPlacement = async function() { const finalCash = (checkoutBasePrice + checkoutDelivery) - appliedWalletDiscount; const timePref = document.getElementById('checkout-time')?.value || 'now'; const notes = document.getElementById('checkout-notes')?.value.trim() || ''; await addDoc(getCollection('orders'), { type: 'standard', merchantId: checkoutItem.mId, customerId: currentUserData.uid || 'demo_cust', customerName: currentUserData.name, customerPhone: currentUserData.phone || '0000', customerLocation: currentUserData.location || 'ุงูููุฑู', item: checkoutItem.name, price: checkoutBasePrice, deliveryFee: checkoutDelivery, walletPaid: appliedWalletDiscount, cashToPay: finalCash, status: 'pending', chat: [], scheduledTime: timePref, notes: notes, rated: false, timestamp: serverTimestamp() }); if(appliedWalletDiscount > 0 && currentUserData.uid !== 'demo_cust') { const userQ = await getDocs(query(getCollection('users'), where('uid','==',currentUserData.uid))); if(!userQ.empty) updateDoc(getDocRef('users', userQ.docs[0].id), { walletBalance: (currentUserData.walletBalance || 0) - appliedWalletDiscount }); } customerCart = []; window.renderCartView(); window.closeCheckout(); window.showToast('ุชู ุฅุฑุณุงู ุงูุทูุจ ุจูุฌุงุญ! ๐', 'success'); window.switchCustTab('cart'); window.sendAppNotification(checkoutItem.mId, `ุทูุจ ุฌุฏูุฏ!`); };
        window.confirmCustomOrder = async function() { const place = document.getElementById('custom-place-name').value.trim(); const details = document.getElementById('custom-item-name').value.trim(); if(!place || !details) return window.showToast('ุฃุฏุฎู ุชูุงุตูู ุงูุทูุจ ูุงูููุงู', 'error'); await addDoc(getCollection('orders'), { type: 'custom', customerId: currentUserData.uid || 'demo_cust', customerName: currentUserData.name, customerPhone: currentUserData.phone || '0000', customerLocation: currentUserData.location || 'ุงูููุฑู', item: `${details} (ูู: ${place})`, price: 0, deliveryFee: 1.50, status: 'ready', chat: [], timestamp: serverTimestamp() }); window.closeCustomOrderModal(); window.showToast('ุชู ุจุซ ุงูุทูุจ ูููุจุงุชู ๐', 'success'); window.switchCustTab('cart'); window.sendAppNotification('captains', 'ุทูุจ ุชูุตูู ูุฎุตุต ุฌุฏูุฏ ุจุงูุชุธุงุฑ ุจุทู!'); };
        window.updateOrderStatus = async function(orderId, newStatus) { const payload = { status: newStatus }; const order = allOrders.find(o => o.id === orderId); if(newStatus === 'preparing' && order) window.sendAppNotification(order.customerId, 'ุงููุชุฌุฑ ุจุฏุฃ ุจุชุฌููุฒ ุทูุจู ๐จโ๐ณ'); if(newStatus === 'ready') window.sendAppNotification('captains', `ุทูุจ ุฌุงูุฒ ููุชูุตูู!`); if(newStatus === 'on_the_way' && currentUserRole === 'captain') { payload.captainPhone = currentUserData.phone || '0000'; payload.captainId = currentUserData.id; if(order) { window.sendAppNotification(order.customerId, `ุงููุงุจุชู ${currentUserData.name} ุงุณุชูู ุงูุทูุจ ููู ุจุงูุทุฑูู! ๐ต`); if(order.merchantId) window.sendAppNotification(order.merchantId, `ุชู ุงุณุชูุงู ุงูุทูุจ ูู ุงููุงุจุชู.`); } } await updateDoc(getDocRef('orders', orderId), payload); };
        window.finishDelivery = async function(orderId, fee) { const deduction = fee * DEDUCTION_RATE; const bal = currentUserData.walletBalance || 0; if(bal < deduction) return window.showToast('ุฑุตูุฏ ุงููุญูุธุฉ ูุง ูููู', 'error'); await window.updateOrderStatus(orderId, 'delivered'); await updateDoc(getDocRef('staff', currentUserData.id), { walletBalance: bal - deduction }); window.showToast(`ุชู ุงูุชุณููู (ุฎูุตู ${deduction.toFixed(2)} JOD)`, 'success'); const order = allOrders.find(o => o.id === orderId); if(order && order.customerId !== 'demo_cust') { const points = 10; const userQ = await getDocs(query(getCollection('users'), where('uid','==',order.customerId))); if(!userQ.empty) { const uDoc = userQ.docs[0]; updateDoc(getDocRef('users', uDoc.id), { loyaltyPoints: (uDoc.data().loyaltyPoints || 0) + points }); window.sendAppNotification(order.customerId, `ุชู ุงูุชูุตูู ุจูุฌุงุญ โ ูุณุจุช ${points} ููุงุท ููุงุก!`); } } };
        window.sendChatMessage = async function() { const input = document.getElementById('chat-input-text'); const text = input.value.trim(); if(!text || !currentChatOrderId) return; input.value = ''; await updateDoc(getDocRef('orders', currentChatOrderId), { chat: arrayUnion({ sender: currentUserRole, text: text, time: new Date().toLocaleTimeString('ar-JO', {hour:'2-digit', minute:'2-digit'}) }) }); };
        window.submitRating = async function() { try { if(ratingTargetCaptainId) { const cRef = getDocRef('staff', ratingTargetCaptainId); const cDoc = allStaff.find(s => s.id === ratingTargetCaptainId); if(cDoc) await updateDoc(cRef, { ratingSum: (cDoc.ratingSum || 0) + captStarVal, ratingCount: (cDoc.ratingCount || 0) + 1 }); } if(ratingTargetMerchantId) { const mRef = getDocRef('staff', ratingTargetMerchantId); const mDoc = allStaff.find(s => s.id === ratingTargetMerchantId); if(mDoc) await updateDoc(mRef, { ratingSum: (mDoc.ratingSum || 0) + merchStarVal, ratingCount: (mDoc.ratingCount || 0) + 1 }); } await updateDoc(getDocRef('orders', ratingTargetOrderId), { rated: true }); window.showToast('ุดูุฑุงู ูุชููููู! โญ', 'success'); } catch(e) {} window.closeRatingModal(); window.renderCustomer(); };
        window.deleteMenuItem = async function(id) { try { await deleteDoc(getDocRef('menu', id)); } catch(e) {} };
        window.sendAdminNotification = async function() { if(currentUserRole !== 'admin') return; const target = document.getElementById('admin-notif-target').value; const msg = document.getElementById('admin-notif-msg').value.trim(); const img = document.getElementById('admin-notif-img')?.value.trim(); if(!msg) return window.showToast('ุงูุชุจ ุงูุฑุณุงูุฉ', 'error'); await window.sendAppNotification(target, `ุฅุนูุงู ุงูุฅุฏุงุฑุฉ: ${msg}`, img || null); window.showToast('ุชู ุจุซ ุงูุฅุดุนุงุฑ ุจูุฌุงุญ', 'success'); document.getElementById('admin-notif-msg').value = ''; if(document.getElementById('admin-notif-img')) document.getElementById('admin-notif-img').value = ''; };
        window.toggleBan = async function(collectionName, docId, currentStatus) { if(currentUserRole !== 'admin') return; try { await updateDoc(getDocRef(collectionName, docId), { banned: !currentStatus }); window.showToast(!currentStatus ? 'ุชู ุญุธุฑ ุงููุณุชุฎุฏู ๐ซ' : 'ุชู ูู ุงูุญุธุฑ โ', 'success'); } catch(e) { window.showToast('ุฎุทุฃ ูู ุงูุชุนุฏูู', 'error'); } };
        window.requestPointsConversion = async function() { if((currentUserData.loyaltyPoints || 0) < 1000) return window.showToast('ุชุญุชุงุฌ 1000 ููุทุฉ ูุญุฏ ุฃุฏูู', 'error'); try { await addDoc(getCollection('point_requests'), { customerId: currentUserData.uid, customerName: currentUserData.name, points: 1000, money: 1.00, status: 'pending', timestamp: serverTimestamp() }); window.showToast('ุชู ุฅุฑุณุงู ุทูุจ ุงูุชุญููู ููุฅุฏุงุฑุฉ', 'success'); } catch(e) { window.showToast('ุฎุทุฃ ูู ุงูุฅุฑุณุงู', 'error'); } };
        window.approvePointRequest = async function(reqId, custUid) { try { const userQ = await getDocs(query(getCollection('users'), where('uid','==',custUid))); if(!userQ.empty) { const uDoc = userQ.docs[0]; const ud = uDoc.data(); if(ud.loyaltyPoints >= 1000) { await updateDoc(getDocRef('users', uDoc.id), { loyaltyPoints: ud.loyaltyPoints - 1000, walletBalance: (ud.walletBalance || 0) + 1.00 }); await updateDoc(getDocRef('point_requests', reqId), { status: 'approved' }); window.sendAppNotification(custUid, 'ุชู ุชุญููู 1000 ููุทุฉ ุฅูู 1 ุฏููุงุฑ ูู ูุญูุธุชู ๐ฐ'); window.showToast('ุชูุช ุงูููุงููุฉ ูุชู ุงูุชุญููู', 'success'); } else window.showToast('ููุงุท ุงูุฒุจูู ุบูุฑ ูุงููุฉ', 'error'); } } catch(e) {} };
        window.rejectPointRequest = async function(reqId) { await updateDoc(getDocRef('point_requests', reqId), { status: 'rejected' }); window.showToast('ุชู ุฑูุถ ุงูุทูุจ', 'info'); };
        window.confirmTopUp = async function(isPositive) { if(currentUserRole !== 'admin' || !topUpTargetId) return; const amount = parseFloat(document.getElementById('topup-amount').value); if(!amount || isNaN(amount) || amount <= 0) return window.showToast('ุฃุฏุฎู ูุจูุบุงู ุตุญูุญุงู', 'error'); try { const finalAmount = isPositive ? (topUpCurrentBal + amount) : (topUpCurrentBal - amount); await updateDoc(getDocRef('staff', topUpTargetId), { walletBalance: finalAmount }); window.showToast(isPositive ? 'ุชู ุดุญู ุงููุญูุธุฉ ๐ฐ' : 'ุชู ุฎุตู ุงูุนููุจุฉ ๐ซ', 'success'); window.closeTopUpModal(); } catch(e) { window.showToast('ุญุฏุซ ุฎุทุฃ', 'error'); } };
        window.exportCSV = function() { 
            let csv = 'Order ID,Customer,Merchant,Item,Price,Delivery Fee,Status,Type\n'; 
            allOrders.forEach(o => { 
                const safeItem = (o.item || 'ููุชุฌ ุบูุฑ ูุนุฑูู').replace(/,/g, '-').replace(/\n/g, ' ');
                csv += `${o.id},${o.customerName},${o.merchantId || 'N/A'},${safeItem},${o.price},${o.deliveryFee},${o.status},${o.type}\n`; 
            }); 
            const blob = new Blob(["\ufeff", csv], { type: 'text/csv;charset=utf-8;' }); 
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = "orders_report.csv"; link.click(); 
        };
        window.printReceipt = function(orderId) { 
            const o = allOrders.find(x => x.id === orderId); if(!o) return; 
            const safeItem = (o.item || 'ููุชุฌ ุบูุฑ ูุนุฑูู').replace(/\n/g, '<br>');
            const pw = window.open('', '_blank'); 
            pw.document.write(`<html><head><title>ูุงุชูุฑุฉ ${o.id}</title><style>body{font-family:sans-serif; direction:rtl; text-align:center; margin:20px;} hr{border-top:1px dashed #000;} .t{font-size:12px;}</style></head><body><h2>ูุฒุนููุฉ</h2><hr><p>ุงูุทูุจ: #${o.id.substring(0,6)}</p><p>ุงูุฒุจูู: ${o.customerName}</p><p>ุงููุงุชู: ${o.customerPhone}</p><hr><h3>${safeItem}</h3><p class="t">ููุงุญุธุงุช: ${o.notes || 'ูุง ููุฌุฏ'}</p><hr><p>ุงูุฅุฌูุงูู: ${(o.price).toFixed(2)} JOD</p></body></html>`); 
            pw.document.close(); pw.print(); 
        };
        window.saveAdminEdit = async function() { if(currentUserRole !== 'admin') return; const id = document.getElementById('edit-user-id').value; const col = document.getElementById('edit-user-col').value; const name = document.getElementById('edit-user-name').value.trim(); const phone = document.getElementById('edit-user-phone').value.trim(); const pass = document.getElementById('edit-user-pass').value.trim(); const wNum = document.getElementById('edit-user-worknum').value.trim(); const wall = parseFloat(document.getElementById('edit-user-wallet').value) || 0; const pts = parseInt(document.getElementById('edit-user-points').value) || 0; if(!name || !pass) return window.showToast('ุงูุงุณู ููููุฉ ุงููุฑูุฑ ูุทููุจุฉ', 'error'); const payload = { name: name, phone: phone, password: pass, walletBalance: wall, loyaltyPoints: pts }; if(col === 'staff') { if(!/^\d+$/.test(wNum) && wNum.trim() !== '') return window.showToast('ุงููุนุฑู ูุฌุจ ุฃู ูููู ุฃุฑูุงูุงู ููุท!', 'error'); payload.workNumber = wNum; } try { await updateDoc(getDocRef(col, id), payload); window.showToast('ุชู ุชุญุฏูุซ ุงูุจูุงูุงุช ุจูุฌุงุญ โ', 'success'); window.closeAdminEdit(); } catch(e) { window.showToast('ุฎุทุฃ ูู ุงูุชุญุฏูุซ', 'error'); } };
        window.previewLogoName = function(input) { const text = document.getElementById('logo-preview-text'); if (input.files && input.files[0]) { text.innerText = 'ุชู ุงุฎุชูุงุฑ: ' + input.files[0].name; text.classList.add('text-green-600', 'font-bold'); } else { text.innerText = 'ุงุฎุชุฑ ุดุนุงุฑ ุงูุชุทุจูู (ุตูุฑุฉ)'; text.classList.remove('text-green-600', 'font-bold'); } };
        window.saveAppSettings = async function() { if(currentUserRole !== 'admin') return; const name = document.getElementById('setting-app-name').value.trim(); const fileInput = document.getElementById('setting-app-logo-file'); let logoBase64 = appSettings.logo; if (fileInput.files && fileInput.files.length > 0) { const file = fileInput.files[0]; const reader = new FileReader(); reader.onload = async (e) => { logoBase64 = e.target.result; await setDoc(getDocRef('settings', 'app_config'), { name: name || 'ูุฒุนููุฉ', logo: logoBase64 }); window.showToast('ุชู ุชุญุฏูุซ ุฅุนุฏุงุฏุงุช ุงูุชุทุจูู', 'success'); }; reader.readAsDataURL(file); } else { await setDoc(getDocRef('settings', 'app_config'), { name: name || 'ูุฒุนููุฉ', logo: logoBase64 }); window.showToast('ุชู ุชุญุฏูุซ ุฅุนุฏุงุฏุงุช ุงูุชุทุจูู', 'success'); } };

        window.startFirestoreListeners = function() {
            unsubs.forEach(unsub => unsub()); unsubs = [];
            if(!currentUser) return;
            unsubs.push(onSnapshot(getDocRef('settings', 'app_config'), (docSnap) => { if(docSnap.exists()) { appSettings = docSnap.data(); window.applyAppSettings(); }}));
            unsubs.push(onSnapshot(getCollection('orders'), (snapshot) => {
                const newOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                newOrders.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                if(currentUserRole === 'customer') { const myActive = newOrders.filter(o => o.customerId === (currentUserData?.uid || 'demo_cust') && o.status !== 'delivered'); const b = document.getElementById('cart-badge'); if(b) b.classList.toggle('hidden', myActive.length === 0); }
                if(currentChatOrderId) { const activeO = newOrders.find(o => o.id === currentChatOrderId); if(activeO) window.renderChatMessages(activeO.chat || []); }
                allOrders = newOrders; window.updateUI();
            }));
            unsubs.push(onSnapshot(getCollection('staff'), (snapshot) => {
                allStaff = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (currentUserRole === 'captain' && currentUserData) { const me = allStaff.find(s => s.id === currentUserData.id); if(me) { currentUserData.walletBalance = me.walletBalance; window.updateCaptainWalletUI(); } }
                if (currentUserRole === 'admin') { window.renderAdminStaffList(); window.updateAdminNotifDropdown(); }
                window.updateUI();
            }));
            unsubs.push(onSnapshot(getCollection('users'), (snap) => { 
                allUsers = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
                if(currentUserRole === 'customer' && currentUserData) {
                    const me = allUsers.find(u => u.uid === currentUserData.uid);
                    if(me) { 
                        currentUserData.loyaltyPoints = me.loyaltyPoints || 0; currentUserData.walletBalance = me.walletBalance || 0;
                        const pEl = document.getElementById('prof-points'); if(pEl) pEl.innerText = currentUserData.loyaltyPoints; 
                        const cEl = document.getElementById('cust-points-display'); if(cEl) cEl.innerText = currentUserData.loyaltyPoints; 
                        const wEl = document.getElementById('prof-wallet'); if(wEl) wEl.innerText = currentUserData.walletBalance.toFixed(2);
                        const convertBtn = document.getElementById('convert-points-section'); if(convertBtn) { if(currentUserData.loyaltyPoints >= 1000) convertBtn.classList.remove('hidden'); else convertBtn.classList.add('hidden'); }
                    }
                }
                if(currentUserRole === 'admin') window.updateAdminNotifDropdown();
            }));
            unsubs.push(onSnapshot(getCollection('point_requests'), (snap) => {
                allPointRequests = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if(currentUserRole === 'admin') { const pending = allPointRequests.filter(r => r.status === 'pending'); const fb = document.getElementById('finance-badge'); if(fb) fb.classList.toggle('hidden', pending.length === 0); window.renderAdminFinance(); }
            }));
            unsubs.push(onSnapshot(getCollection('notifications'), (snap) => { allNotifications = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0)); window.updateNotificationsUI(); }));
            unsubs.push(onSnapshot(getCollection('menu'), (snap) => { allMenu = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); window.updateUI(); }));
        };

        // --- Execute Firestore Init ---
        const initSystem = async () => {
            try {
                // Ensure authentication meets standard rules
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch(e) { console.error("Auth initialization error"); }
            
            onAuthStateChanged(auth, (user) => { 
                if (user) { currentUser = user; window.startFirestoreListeners(); } 
                setTimeout(() => { 
                    const loader = document.getElementById('initial-loader'); 
                    if(loader) { 
                        loader.classList.add('opacity-0'); 
                        setTimeout(() => {
                            loader.classList.add('hidden');
                            // ุฅุตูุงุญ: ุฅุธูุงุฑ ุดุงุดุฉ ุงูุฏุฎูู ุฅุฐุง ูู ููู ุงููุณุชุฎุฏู ูุณุฌูุงู ุจุนุฏ
                            if (!currentUserRole) {
                                window.showView('login');
                            }
                        }, 500); 
                    } 
                }, 500);
            });
        };
        initSystem();

    </script>
</body>
</html>