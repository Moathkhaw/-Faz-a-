<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุชุทุจูู ูุฒุนุฉ - ููุชูุตูู ุงูุณุฑูุน</title>
    <!-- Tailwind CSS ููุชุตููู -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome ููุฃููููุงุช -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ุฅุนุฏุงุฏุงุช ุงูุฎุทูุท ูุงูุฃููููุดู ุงูุฃุณุงุณูุฉ */
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap');
        body { font-family: 'Tajawal', sans-serif; background-color: #f3f4f6; }
        
        /* ุฅุฎูุงุก ุดุฑูุท ุงูุชูุฑูุฑ ูุฌูุงููุฉ ุงูุชุทุจูู */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* ุชุฃุซูุฑุงุช ุงููุจุถ ูุงูุชุญููู */
        @keyframes pulse-red { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239,68,68,0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(239,68,68,0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239,68,68,0); } }
        .blinking-alert { animation: pulse-red 2s infinite; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #f97316; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* ุฃุฒุฑุงุฑ ุงูุชุจุฏูู ูุงููุญุงุฏุซุฉ */
        .toggle-checkbox:checked { right: 0; border-color: #10B981; }
        .toggle-checkbox:checked + .toggle-label { background-color: #10B981; }
        .chat-me { background-color: #e0e7ff; color: #1e40af; border-radius: 1rem 1rem 0 1rem; align-self: flex-end; }
        .chat-other { background-color: #f3f4f6; color: #374151; border-radius: 1rem 1rem 1rem 0; align-self: flex-start; }
        
        /* ุชุฎุตูุต ุงูุดุฑูุท ุงูุณููู ูุงูุชูููู */
        .nav-active { color: #4f46e5 !important; font-weight: 900; }
        .nav-active i { transform: translateY(-3px) scale(1.1); transition: all 0.2s; color: #4f46e5; }
        .star-rating i { cursor: pointer; color: #d1d5db; transition: color 0.2s; }
        .star-rating i.active { color: #fbbf24; }
        
        /* ุฒุฑ ุฑูุน ุงูุตูุฑุฉ */
        .file-upload-btn { position: relative; overflow: hidden; display: inline-block; }
        .file-upload-btn input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; }
    </style>
</head>
<body class="text-gray-800 antialiased flex justify-center h-screen overflow-hidden">

    <!-- ุญุงููุฉ ุงูุชุทุจูู ุงูุฑุฆูุณูุฉ (ูุญุงูุงุฉ ุงูููุจุงูู) -->
    <div class="w-full max-w-md h-full bg-gray-50 flex flex-col relative shadow-2xl overflow-hidden border-x border-gray-200">
        
        <!-- ุงูุชูุจููุงุช (Toast Notifications) -->
        <div id="toast" class="absolute top-4 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-5 py-3 rounded-2xl shadow-2xl transition-all duration-300 opacity-0 z-[100] pointer-events-none flex items-center gap-3 text-sm font-bold min-w-[250px]">
            <span id="toast-icon" class="text-xl"></span>
            <span id="toast-msg"></span>
        </div>

        <!-- ==================== ุดุงุดุฉ ุชุณุฌูู ุงูุฏุฎูู ==================== -->
        <div id="view-login" class="flex flex-col h-full bg-white relative overflow-y-auto hide-scrollbar">
            <!-- ุฎูููุฉ ุนูููุฉ -->
            <div class="absolute top-0 w-full h-1/2 bg-gradient-to-br from-indigo-900 to-blue-800 rounded-b-[4rem] shadow-inner"></div>
            
            <div class="flex-1 flex flex-col items-center pt-16 px-8 relative z-10">
                <div id="app-logo-container" class="w-28 h-28 bg-white text-indigo-900 rounded-full flex items-center justify-center text-5xl mb-4 shadow-2xl border-4 border-indigo-100 overflow-hidden">
                    <i class="fa-solid fa-rocket text-orange-500"></i>
                </div>
                <h1 id="app-name-display-1" class="text-3xl font-black text-white mb-1 tracking-wide">ูุฒุนููุฉ</h1>
                <p class="text-indigo-200 mb-10 text-center text-sm font-medium">ุงูุฃุณุฑุน ูู ุงูููุฑู ูุจูุนูุง</p>
                
                <!-- ุตูุฏูู ุชุณุฌูู ุงูุฏุฎูู -->
                <div class="w-full bg-white rounded-3xl shadow-xl p-6 border border-gray-100">
                    <div class="flex w-full bg-gray-100 rounded-xl p-1 mb-6">
                        <button id="tab-customer" onclick="switchLoginTab('customer')" class="flex-1 py-2 text-sm font-bold bg-white shadow rounded-lg text-indigo-700 transition-all">ุงูุฒุจุงุฆู</button>
                        <button id="tab-staff" onclick="switchLoginTab('staff')" class="flex-1 py-2 text-sm font-bold text-gray-500 rounded-lg transition-all">ูุฑูู ุงูุนูู</button>
                    </div>

                    <!-- ูููุฐุฌ ุงูุฒุจูู -->
                    <div id="form-customer" class="w-full space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">ุฑูู ุงููุงุชู</label>
                            <div class="relative"><i class="fa-solid fa-phone absolute right-4 top-3.5 text-gray-400"></i><input type="tel" id="login-phone" class="w-full pr-10 pl-4 py-3 rounded-xl border border-gray-200 focus:border-indigo-500 outline-none" placeholder="07XXXXXXXX"></div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">ูููุฉ ุงููุฑูุฑ</label>
                            <div class="relative"><i class="fa-solid fa-lock absolute right-4 top-3.5 text-gray-400"></i><input type="password" id="login-password" class="w-full pr-10 pl-4 py-3 rounded-xl border border-gray-200 focus:border-indigo-500 outline-none" placeholder="โขโขโขโขโขโขโขโข"></div>
                        </div>
                        <button onclick="loginCustomer()" class="w-full bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 text-white font-bold py-3.5 rounded-xl shadow-lg mt-2 flex justify-center"><span id="login-btn-text">ุฏุฎูู</span></button>
                        <p class="text-center text-sm mt-4 text-gray-500 font-medium">ุฌุฏูุฏ ูุนูุงุ <button onclick="showView('signup')" class="text-indigo-600 font-bold hover:underline">ุฅูุดุงุก ุญุณุงุจ</button></p>
                    </div>

                    <!-- ูููุฐุฌ ุงููุฑูู (ุฅุฏุงุฑุฉุ ูุงุจุชูุ ูุทุนู) -->
                    <div id="form-staff" class="w-full space-y-4 hidden">
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">ููุน ุงูุญุณุงุจ</label>
                            <select id="login-staff-role" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-indigo-500 outline-none text-sm">
                                <option value="admin">ุฅุฏุงุฑุฉ ุงูุชุทุจูู ๐ก๏ธ</option>
                                <option value="merchant">ูุชุฌุฑ / ูุทุนู ๐ช</option>
                                <option value="captain">ูุงุจุชู ุชูุตูู ๐ต</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">ุฑูู ุงูุนูู ุฃู ุงููุนุฑู (ID)</label>
                            <input type="text" id="login-staff-worknum" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-indigo-500 outline-none text-sm" placeholder="ูุซุงู: QE-1234">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">ูููุฉ ุงููุฑูุฑ</label>
                            <input type="password" id="login-staff-password" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-indigo-500 outline-none text-sm" placeholder="โขโขโขโขโขโขโขโข">
                        </div>
                        <button onclick="loginStaff()" class="w-full bg-gray-900 hover:bg-black text-white font-bold py-3.5 rounded-xl shadow-lg mt-2 flex justify-center"><span id="login-staff-btn-text">ุฏุฎูู ูููุธุงู</span></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== ุดุงุดุฉ ุฅูุดุงุก ุญุณุงุจ ุงูุฒุจูู ==================== -->
        <div id="view-signup" class="hidden flex-col h-full bg-white relative overflow-y-auto hide-scrollbar">
            <div class="p-6 pb-2 flex items-center"><button onclick="showView('login')" class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-gray-600 hover:bg-gray-200 transition-colors"><i class="fa-solid fa-arrow-right"></i></button></div>
            <div class="px-8 pb-8 flex-1">
                <h2 class="text-3xl font-black text-indigo-900 mb-1">ูุฑุญุจุงู ุจู!</h2>
                <p class="text-gray-500 mb-8 text-sm font-medium">ุณุฌู ุจูุงูุงุชู ููุจุฏุก ุจุงูุทูุจ ููุณุจ ุงูููุงุท</p>
                <div class="space-y-4">
                    <input type="text" id="reg-name" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-orange-500 outline-none text-sm" placeholder="ุงูุงุณู ุงููุงูู">
                    <input type="tel" id="reg-phone" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-orange-500 outline-none text-sm" placeholder="ุฑูู ุงููุงุชู (07XXXXXXXX)">
                    <div class="flex gap-2">
                        <input type="text" id="reg-location" class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-gray-50 outline-none text-xs text-gray-500" placeholder="ุงููููุน (GPS)..." readonly>
                        <button onclick="getLocation()" class="bg-indigo-600 text-white px-5 rounded-xl shadow-md hover:bg-indigo-700 transition-colors"><i class="fa-solid fa-location-crosshairs"></i></button>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="password" id="reg-password" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-orange-500 outline-none text-sm" placeholder="ูููุฉ ุงููุฑูุฑ">
                        <input type="password" id="reg-confirm" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-orange-500 outline-none text-sm" placeholder="ุชุฃููุฏ ุงููููุฉ">
                    </div>
                    <button onclick="registerCustomer()" class="w-full bg-gradient-to-r from-orange-500 to-orange-600 text-white font-bold py-3.5 rounded-xl shadow-lg mt-6 flex justify-center"><span id="reg-btn-text">ุฅูุดุงุก ุงูุญุณุงุจ</span></button>
                </div>
            </div>
        </div>

        <!-- ==================== ูุงุฌูุฉ ุงูุฒุจูู (Customer) ==================== -->
        <div id="view-customer" class="hidden flex-col h-full bg-gray-50 pb-[70px] relative">
            <div class="bg-indigo-900 text-white p-6 rounded-b-[2rem] shadow-lg z-10 relative overflow-hidden shrink-0">
                <div class="absolute -right-10 -top-10 w-32 h-32 bg-white/5 rounded-full blur-2xl"></div>
                <div class="flex justify-between items-center mb-4 relative z-10">
                    <div>
                        <p class="text-xs text-indigo-300 mb-1">ูุฑุญุจุงู ุจู ูู <span id="app-name-display-2">ูุฒุนููุฉ</span>ุ</p>
                        <h2 id="cust-name-display" class="text-xl font-black tracking-wide">ุงูุฒุจูู</h2>
                    </div>
                    <button onclick="openNotificationsModal()" class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center relative hover:bg-white/20 transition-colors">
                        <i class="fa-solid fa-bell text-sm"></i>
                        <span id="cust-notif-badge" class="hidden absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full"></span>
                    </button>
                </div>
                <div class="bg-indigo-800/50 p-2.5 rounded-xl text-xs font-medium flex items-center justify-between border border-indigo-700/50 relative z-10">
                    <div class="flex items-center gap-2 truncate"><i class="fa-solid fa-location-dot text-orange-400"></i><span id="cust-loc-display" class="truncate">ุฌุงุฑู ุงูุชุญุฏูุฏ...</span></div>
                    <div class="bg-yellow-400 text-yellow-900 px-2 py-1 rounded font-bold whitespace-nowrap"><i class="fa-solid fa-star text-[10px]"></i> <span id="cust-points-display">0</span> ููุทุฉ</div>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-5 hide-scrollbar">
                <div id="cust-tab-home" class="space-y-6 block">
                    <div onclick="openCustomOrderModal()" class="bg-gradient-to-r from-orange-500 to-amber-500 rounded-2xl p-4 text-white shadow-lg relative overflow-hidden cursor-pointer hover:shadow-xl transition-shadow">
                        <div class="absolute -right-4 -bottom-4 text-white/20 text-6xl"><i class="fa-solid fa-motorcycle"></i></div>
                        <h3 class="font-black text-lg mb-1 relative z-10">ุชูุตูู ูู ุฃู ููุงู!</h3>
                        <p class="text-xs font-medium text-orange-100 relative z-10">ุฃุฏุฎู ุงุณู ุงููุชุฌุฑ ูุงูุทูุจุ ููุงุจุชู ูุฒุนุฉ ุจูุฌูุจูู ุฅูุงู.</p>
                        <button class="mt-3 bg-white text-orange-600 px-4 py-1.5 rounded-lg text-xs font-bold shadow relative z-10">ุงุทูุจ ุงูุขู <i class="fa-solid fa-arrow-left ml-1"></i></button>
                    </div>

                    <div id="customer-promos-section" class="hidden">
                        <div class="flex items-center gap-2 mb-3"><i class="fa-solid fa-ticket text-orange-500"></i><h3 class="font-bold text-gray-800 text-sm">ููุจููุงุช ุฎุตู ูุนุงูุฉ</h3></div>
                        <div id="customer-promos-list" class="flex gap-3 overflow-x-auto hide-scrollbar pb-2"></div>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-3"><h3 class="font-bold text-gray-800 text-lg">ูุงุฐุง ุชูุฏ ุฃู ุชุทูุจุ</h3></div>
                        <div class="flex gap-2 overflow-x-auto hide-scrollbar mb-4 pb-1">
                            <button onclick="setCustCategory('all')" id="btn-cat-all" class="cat-btn px-4 py-2 rounded-xl text-xs font-bold bg-indigo-600 text-white shadow-md whitespace-nowrap transition-colors">ุงููู</button>
                            <button onclick="setCustCategory('restaurant')" id="btn-cat-restaurant" class="cat-btn px-4 py-2 rounded-xl text-xs font-bold bg-white text-gray-600 border border-gray-200 shadow-sm whitespace-nowrap transition-colors"><i class="fa-solid fa-burger mr-1 text-orange-400"></i> ูุทุงุนู</button>
                            <button onclick="setCustCategory('market')" id="btn-cat-market" class="cat-btn px-4 py-2 rounded-xl text-xs font-bold bg-white text-gray-600 border border-gray-200 shadow-sm whitespace-nowrap transition-colors"><i class="fa-solid fa-basket-shopping mr-1 text-blue-400"></i> ูุงุฑูุช</button>
                            <button onclick="setCustCategory('pharmacy')" id="btn-cat-pharmacy" class="cat-btn px-4 py-2 rounded-xl text-xs font-bold bg-white text-gray-600 border border-gray-200 shadow-sm whitespace-nowrap transition-colors"><i class="fa-solid fa-pills mr-1 text-green-400"></i> ุตูุฏููุงุช</button>
                        </div>
                        <div id="customer-menu-list" class="grid grid-cols-2 gap-4"></div>
                    </div>
                </div>

                <div id="cust-tab-cart" class="hidden space-y-4">
                    <h3 class="font-bold text-gray-800 mb-3 text-lg border-b border-gray-200 pb-2 flex items-center gap-2"><i class="fa-solid fa-bag-shopping text-indigo-500"></i> ุงูุณูุฉ ูุชุชุจุน ุงูุทูุจุงุช</h3>
                    <div id="customer-orders-list" class="space-y-4"></div>
                </div>

                <div id="cust-tab-profile" class="hidden space-y-4">
                    <h3 class="font-bold text-gray-800 mb-3 text-lg border-b border-gray-200 pb-2">ุญุณุงุจู</h3>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 space-y-3 relative overflow-hidden">
                        <div class="absolute -left-6 -top-6 w-24 h-24 bg-indigo-50 rounded-full z-0"></div>
                        <div class="flex items-center gap-3 relative z-10"><div class="w-12 h-12 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center text-xl"><i class="fa-solid fa-user"></i></div><div><p class="font-bold text-gray-800" id="prof-name">ุงูุงุณู</p><p class="text-xs text-gray-500" id="prof-phone">ุงููุงุชู</p></div></div>
                        <div class="bg-gray-50 p-3 rounded-xl flex items-center gap-2 text-sm text-gray-600 border border-gray-100 relative z-10"><i class="fa-solid fa-location-dot text-red-500"></i> <span id="prof-loc" class="truncate">ุงููููุน</span></div>
                        
                        <div class="grid grid-cols-2 gap-2 relative z-10">
                            <div class="bg-green-50 p-3 rounded-xl border border-green-100 flex flex-col justify-center">
                                <p class="text-[10px] font-bold text-green-800 mb-1">ุฑุตูุฏ ุงููุญูุธุฉ</p>
                                <span class="font-black text-green-600 text-lg"><span id="prof-wallet">0.00</span> <span class="text-[10px]">JOD</span></span>
                            </div>
                            <div class="bg-yellow-50 p-3 rounded-xl border border-yellow-100 flex flex-col justify-center">
                                <p class="text-[10px] font-bold text-yellow-800 mb-1">ููุงุท ุงูููุงุก</p>
                                <span class="font-black text-yellow-600 text-lg" id="prof-points">0</span>
                            </div>
                        </div>
                        
                        <div id="convert-points-section" class="hidden relative z-10">
                            <button onclick="requestPointsConversion()" class="w-full bg-gradient-to-r from-yellow-400 to-yellow-500 text-yellow-900 font-bold py-2.5 rounded-xl shadow-sm text-xs hover:from-yellow-500 hover:to-yellow-600 transition-colors">
                                <i class="fa-solid fa-money-bill-transfer"></i> ุชุญููู 1000 ููุทุฉ ุฅูู 1 ุฏููุงุฑ
                            </button>
                        </div>
                        <button onclick="logout()" class="w-full bg-red-50 text-red-600 font-bold py-3 rounded-xl mt-2 hover:bg-red-100 transition-colors relative z-10">ุชุณุฌูู ุงูุฎุฑูุฌ</button>
                    </div>
                </div>
            </div>

            <div class="absolute bottom-0 w-full bg-white border-t border-gray-200 flex justify-around items-center pt-3 pb-4 px-2 z-50 rounded-t-2xl shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
                <button onclick="switchCustTab('home')" id="nav-btn-home" class="flex flex-col items-center gap-1 text-gray-400 nav-active w-1/3"><i class="fa-solid fa-house text-xl mb-0.5"></i><span class="text-[10px] font-bold">ุงูุฑุฆูุณูุฉ</span></button>
                <button onclick="switchCustTab('cart')" id="nav-btn-cart" class="flex flex-col items-center gap-1 text-gray-400 w-1/3 relative"><i class="fa-solid fa-bag-shopping text-xl mb-0.5"></i><span class="text-[10px] font-bold">ุงูุณูุฉ</span><span id="cart-badge" class="hidden absolute top-0 right-6 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white"></span></button>
                <button onclick="switchCustTab('profile')" id="nav-btn-profile" class="flex flex-col items-center gap-1 text-gray-400 w-1/3"><i class="fa-solid fa-user text-xl mb-0.5"></i><span class="text-[10px] font-bold">ุญุณุงุจู</span></button>
            </div>
        </div>

        <!-- ==================== ูุงุฌูุฉ ุงูุชุงุฌุฑ / ุงููุทุนู ==================== -->
        <div id="view-merchant" class="hidden flex-col h-full bg-gray-50">
            <div class="bg-gradient-to-r from-pink-600 to-rose-600 text-white p-6 rounded-b-[2rem] shadow-lg z-10 shrink-0">
                <div class="flex justify-between items-center mb-4">
                    <div><p class="text-xs text-pink-200 mb-1">ุจูุงุจุฉ ุงูุดุฑูุงุก</p><h2 class="text-2xl font-black"><i class="fa-solid fa-store ml-1 text-pink-300"></i> <span id="merchant-name-display">ุงููุชุฌุฑ</span></h2></div>
                    <div class="flex gap-2">
                        <button onclick="openNotificationsModal()" class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center relative"><i class="fa-solid fa-bell"></i><span id="merch-notif-badge" class="hidden absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full"></span></button>
                        <button onclick="logout()" class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center hover:bg-red-500"><i class="fa-solid fa-power-off"></i></button>
                    </div>
                </div>
            </div>
            
            <div class="p-4 flex-1 overflow-y-auto hide-scrollbar flex flex-col">
                <div class="flex w-full bg-gray-200/70 rounded-xl p-1 mb-5">
                    <button id="tab-merchant-orders" onclick="switchMerchantTab('orders')" class="flex-1 py-2 text-sm font-bold bg-white shadow rounded-lg text-pink-600 transition-all">ุงูุทูุจุงุช ุงูุญูุฉ</button>
                    <button id="tab-merchant-menu" onclick="switchMerchantTab('menu')" class="flex-1 py-2 text-sm font-bold text-gray-500 rounded-lg transition-all">ุฅุฏุงุฑุฉ ุงููููู</button>
                </div>

                <div id="merchant-orders-content" class="block space-y-4"><div id="merchant-orders-list" class="space-y-4"></div></div>

                <div id="merchant-menu-content" class="hidden space-y-5">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-gray-800 mb-4 text-sm">ุฅุถุงูุฉ ุตูู ุฌุฏูุฏ</h3>
                        <div class="space-y-3">
                            <div class="flex gap-2">
                                <div class="file-upload-btn w-12 h-12 bg-gray-100 text-gray-500 rounded-xl flex items-center justify-center border border-dashed border-gray-300 hover:bg-gray-200 shrink-0">
                                    <i class="fa-solid fa-camera"></i><input type="file" id="new-item-image" accept="image/*" onchange="previewImageName(this)">
                                </div>
                                <input type="text" id="new-item-name" class="flex-1 px-4 py-3 rounded-xl border border-gray-200 text-sm focus:border-pink-500 outline-none" placeholder="ุงุณู ุงูุตูู">
                            </div>
                            <p id="image-preview-name" class="text-[9px] text-green-600 hidden font-bold ml-1"></p>
                            <input type="number" id="new-item-price" class="w-full px-4 py-3 rounded-xl border border-gray-200 text-sm focus:border-pink-500 outline-none" placeholder="ุงูุณุนุฑ (JOD)">
                            <button onclick="addMenuItem()" class="w-full bg-pink-600 text-white font-bold py-3 rounded-xl text-sm" id="btn-add-menu">ุฅุถุงูุฉ</button>
                        </div>
                    </div>
                    <div id="merchant-menu-list" class="space-y-3"></div>
                </div>
            </div>
        </div>

        <!-- ==================== ูุงุฌูุฉ ุงููุงุจุชู (Captain) ==================== -->
        <div id="view-captain" class="hidden flex-col h-full bg-gray-50">
            <div class="bg-gray-900 text-white p-6 rounded-b-[2rem] shadow-xl z-10 relative overflow-hidden shrink-0">
                <div class="absolute -right-10 -top-10 w-32 h-32 bg-orange-500/20 rounded-full blur-2xl"></div>
                <div class="flex justify-between items-center mb-5 relative z-10">
                    <div>
                        <p class="text-xs text-gray-400 mb-1">ุงููุงุจุชู ุงูุจุทูุ</p>
                        <h2 class="text-xl font-black text-white"><span id="captain-name-display">ุงูุงุณู</span> <i class="fa-solid fa-motorcycle text-orange-500 ml-1"></i></h2>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openNotificationsModal()" class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center relative"><i class="fa-solid fa-bell"></i><span id="capt-notif-badge" class="hidden absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full"></span></button>
                        <button onclick="logout()" class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center hover:bg-red-500 transition-colors"><i class="fa-solid fa-power-off"></i></button>
                    </div>
                </div>
                
                <div class="bg-gray-800 rounded-xl p-4 flex justify-between items-center border border-gray-700 relative z-10">
                    <div>
                        <p class="text-[10px] text-gray-400 mb-1">ุฑุตูุฏ ุงููุญูุธุฉ (ููุฎุตู 7% ููุทูุจ)</p>
                        <p class="text-xl font-black text-green-400"><span id="captain-wallet-display">0.00</span> <span class="text-sm">JOD</span></p>
                    </div>
                    <div class="text-center">
                        <p class="text-[10px] text-gray-400 mb-1">ุชููููู</p>
                        <p class="text-sm font-bold text-yellow-400"><i class="fa-solid fa-star"></i> <span id="captain-rating-display">5.0</span></p>
                    </div>
                </div>
            </div>
            
            <div class="p-4 flex-1 overflow-y-auto hide-scrollbar relative">
                <div id="captain-wallet-overlay" class="hidden absolute inset-0 bg-gray-50/95 z-20 flex flex-col items-center justify-center p-6 text-center backdrop-blur-sm">
                    <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center text-4xl mb-4 text-red-500"><i class="fa-solid fa-wallet"></i></div>
                    <h3 class="font-black text-2xl text-gray-800 mb-2">ุฑุตูุฏู ุบูุฑ ูุงูู</h3>
                    <p class="text-sm text-gray-500 font-medium">ุงูุฑุฌุงุก ุดุญู ุงููุญูุธุฉ ูู ุฎูุงู ุงูุฅุฏุงุฑุฉ ูุชุชููู ูู ุงุณุชูุจุงู ุงูุทูุจุงุช ูููุงุตูุฉ ุงูุนูู.</p>
                </div>
                <div class="flex justify-between items-center mb-4 px-1"><h3 class="font-bold text-gray-800">ุงูุทูุจุงุช ุงูุฌุงูุฒุฉ / ุงููุฎุตุตุฉ</h3></div>
                <div id="captain-orders-list" class="space-y-4"></div>
            </div>
        </div>

        <!-- ==================== ููุญุฉ ุงูุฅุฏุงุฑุฉ (Admin) ==================== -->
        <div id="view-admin" class="hidden flex-col h-full bg-gray-50">
            <div class="bg-indigo-900 text-white p-6 rounded-b-[2rem] shadow-xl z-10 shrink-0">
                <div class="flex justify-between items-center mb-4">
                    <div><p class="text-xs text-indigo-300 mb-1">ูุฑูุฒ ุงูููุงุฏุฉ (Admin)</p><h2 class="text-2xl font-black">ุงููุฏูุฑ <span id="admin-name-display">ูุนุงุฐ</span> ๐ก๏ธ</h2></div>
                    <button onclick="logout()" class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center hover:bg-red-500 transition-colors"><i class="fa-solid fa-power-off"></i></button>
                </div>
            </div>
            
            <div class="p-4 flex-1 overflow-y-auto hide-scrollbar">
                <!-- Admin Tabs -->
                <div class="flex flex-wrap w-full bg-indigo-100 rounded-xl p-1 mb-5 gap-y-1">
                    <button id="tab-admin-dash" onclick="switchAdminTab('dash')" class="flex-1 min-w-[20%] py-2 text-[11px] font-bold bg-white shadow rounded-lg text-indigo-900 transition-all">ุงูุฑุฆูุณูุฉ</button>
                    <button id="tab-admin-staff" onclick="switchAdminTab('staff')" class="flex-1 min-w-[20%] py-2 text-[11px] font-bold text-indigo-600 rounded-lg transition-all">ุงููุฑูู ูุงููุชุงุฌุฑ</button>
                    <button id="tab-admin-finance" onclick="switchAdminTab('finance')" class="flex-1 min-w-[20%] py-2 text-[11px] font-bold text-indigo-600 rounded-lg transition-all relative">ุงููุงููุฉ <span id="finance-badge" class="hidden absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span></button>
                    <button id="tab-admin-notifs" onclick="switchAdminTab('notifs')" class="flex-1 min-w-[20%] py-2 text-[11px] font-bold text-indigo-600 rounded-lg transition-all">ุงูุฅุดุนุงุฑุงุช</button>
                </div>

                <div id="admin-dash-content" class="block space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100"><h4 class="text-xs font-bold text-gray-500 mb-1">ูุจูุนุงุช ุงูููุตุฉ</h4><p class="text-xl font-black text-gray-800"><span id="admin-total-sales">0.00</span></p></div>
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100"><h4 class="text-xs font-bold text-gray-500 mb-1">ุฃุฑุจุงุญ ุงูุฅุฏุงุฑุฉ</h4><p class="text-xl font-black text-green-600"><span id="admin-profits">0.00</span></p></div>
                    </div>
                    <h3 class="font-bold text-gray-800 border-b pb-2"><i class="fa-solid fa-satellite-dish text-indigo-500"></i> ุงูุฑุงุฏุงุฑ ุงููุจุงุดุฑ</h3>
                    <div id="admin-orders-list" class="space-y-3"></div>
                </div>

                <!-- ุฅุฏุงุฑุฉ ุงููุฑููุ ุงููุชุงุฌุฑุ ูุฅุถุงูุฉ ูุฏุฑุงุก ุฌุฏุฏ -->
                <div id="admin-staff-content" class="hidden space-y-5">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 space-y-3">
                        <h3 class="font-bold text-gray-800 text-sm border-b pb-3"><i class="fa-solid fa-user-plus text-indigo-500"></i> ุฅุถุงูุฉ ููุธู / ูุชุฌุฑ / ูุฏูุฑ</h3>
                        <select id="new-staff-role" onchange="toggleMerchantCategory()" class="w-full px-3 py-2 text-sm rounded-xl border border-gray-200 outline-none">
                            <option value="merchant">ูุชุฌุฑ ๐ช</option>
                            <option value="captain">ูุงุจุชู ุชูุตูู ๐ต</option>
                            <option value="admin">ูุฏูุฑ ูุธุงู ๐ก๏ธ</option>
                        </select>
                        <div id="new-staff-category-container">
                            <select id="new-staff-category" class="w-full px-3 py-2 text-sm rounded-xl border border-gray-200 outline-none bg-gray-50">
                                <option value="restaurant">ูุทุนู ๐</option>
                                <option value="market">ูุงุฑูุช ๐</option>
                                <option value="pharmacy">ุตูุฏููุฉ ๐</option>
                            </select>
                        </div>
                        <input type="text" id="new-staff-name" class="w-full px-3 py-2 text-sm rounded-xl border border-gray-200 outline-none" placeholder="ุงูุงุณู (ูููุฏูุฑ ุฃู ุงููุชุฌุฑ)">
                        <!-- ุฎุงูุฉ ุงููุนุฑู ุชุธูุฑ ูููุฏูุฑ ููุท ูุชุนููู ID ูุฎุตุต -->
                        <input type="text" id="new-staff-worknum" class="hidden w-full px-3 py-2 text-sm rounded-xl border border-indigo-200 outline-none bg-indigo-50" placeholder="ูุนุฑู ุงูุฅุฏุงุฑุฉ (ูุซุงู: admin_1)">
                        <input type="tel" id="new-staff-phone" class="w-full px-3 py-2 text-sm rounded-xl border border-gray-200 outline-none" placeholder="ุฑูู ุงููุงุชู">
                        <input type="password" id="new-staff-password" class="w-full px-3 py-2 text-sm rounded-xl border border-gray-200 outline-none" placeholder="ูููุฉ ุงููุฑูุฑ">
                        <button onclick="registerStaff()" class="w-full bg-indigo-600 text-white font-bold py-2.5 rounded-xl mt-2 text-sm">ุฅุถุงูุฉ ูุงุนุชูุงุฏ</button>
                    </div>
                    <h3 class="font-bold text-gray-800 text-sm">ุงููุฑูู ูุงููุชุงุฌุฑ (ุดุญู/ุญุธุฑ)</h3>
                    <div id="admin-staff-list" class="space-y-3"></div>
                </div>

                <div id="admin-finance-content" class="hidden space-y-4">
                    <h3 class="font-bold text-gray-800 border-b pb-2 text-sm"><i class="fa-solid fa-money-bill-transfer text-indigo-500"></i> ุทูุจุงุช ุชุญููู ุงูููุงุท (ุงูุฒุจุงุฆู)</h3>
                    <div id="admin-points-requests" class="space-y-3"></div>
                </div>

                <div id="admin-notifs-content" class="hidden space-y-5">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 space-y-3">
                        <h3 class="font-bold text-gray-800 text-sm border-b pb-3"><i class="fa-solid fa-paper-plane text-indigo-500"></i> ูุฑูุฒ ุจุซ ุงูุฅุดุนุงุฑุงุช</h3>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 mb-1">ุงูููุณุชูู</label>
                            <select id="admin-notif-target" class="w-full px-3 py-2 text-sm rounded-xl border border-gray-200 outline-none">
                                <option value="all">ุงูุฌููุน (ูุจุงุชูุ ูุชุงุฌุฑุ ุฒุจุงุฆู)</option>
                                <option value="captains">ุฌููุน ุงููุจุงุชู</option>
                                <option value="merchants">ุฌููุน ุงููุชุงุฌุฑ</option>
                                <option value="customers">ุฌููุน ุงูุฒุจุงุฆู</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 mb-1">ูุต ุงูุฑุณุงูุฉ</label>
                            <textarea id="admin-notif-msg" rows="3" class="w-full px-3 py-2 text-sm rounded-xl border border-gray-200 outline-none" placeholder="ุงูุชุจ ุฅุดุนุงุฑู ููุง..."></textarea>
                        </div>
                        <button onclick="sendAdminNotification()" class="w-full bg-blue-600 text-white font-bold py-2.5 rounded-xl shadow-md text-sm mt-2">ุฅุฑุณุงู ุงูุฅุดุนุงุฑ ููุฑุงู <i class="fa-solid fa-bolt ml-1"></i></button>
                    </div>
                </div>

            </div>
        </div>

        <!-- ==================== ููุงูุฐ ููุจุซูุฉ (Modals) ==================== -->
        
        <!-- Custom Order -->
        <div id="custom-order-modal" class="hidden absolute inset-0 bg-gray-900/70 z-[60] flex items-center justify-center backdrop-blur-sm p-4 transition-all">
            <div class="bg-white w-full rounded-3xl p-6 shadow-2xl relative">
                <button onclick="closeCustomOrderModal()" class="absolute top-4 left-4 w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-200"><i class="fa-solid fa-xmark"></i></button>
                <h3 class="font-black text-xl text-gray-800 mb-2"><i class="fa-solid fa-motorcycle text-orange-500 ml-1"></i> ุชูุตูู ูุฎุตุต</h3>
                <p class="text-xs text-gray-500 mb-5">ุงุทูุจ ุฃู ุดูุก ูู ุฃู ููุงูุ ูุงููุงุจุชู ุจูุญุงุณุจ ูุจูุฌูุจูู ุฅูุงู (ุงูุฏูุน ุนูุฏ ุงูุงุณุชูุงู ุจูุงุกู ุนูู ุงููุงุชูุฑุฉ).</p>
                <div class="space-y-4 mb-6">
                    <div><label class="block text-xs font-bold text-gray-700 mb-1">ุงุณู ุงููุชุฌุฑ / ุงูุตูุฏููุฉ / ุงูููุงู</label><input type="text" id="custom-place-name" class="w-full px-4 py-3 rounded-xl border border-gray-200 text-sm focus:border-orange-500 outline-none" placeholder="ูุซุงู: ูุฎุจุฒ ุงูุฃูู"></div>
                    <div><label class="block text-xs font-bold text-gray-700 mb-1">ูุงุฐุง ุชุฑูุฏ ุฃู ูุดุชุฑู ูู ุจุงูุชูุตููุ</label><textarea id="custom-item-name" rows="3" class="w-full px-4 py-3 rounded-xl border border-gray-200 text-sm focus:border-orange-500 outline-none" placeholder="ูุซุงู: ุฑุจุทุชูู ุฎุจุฒุ ููููู ุญููุจ..."></textarea></div>
                    <div class="bg-orange-50 p-3 rounded-xl border border-orange-100 flex items-start gap-2"><i class="fa-solid fa-circle-info text-orange-500 mt-0.5"></i><p class="text-[10px] text-orange-800 font-bold leading-tight">ุณุนุฑ ุงูุชูุตูู ุงูุซุงุจุช ููุทูุจุงุช ุงููุฎุตุตุฉ ูู 1.50 JOD. ูููุฉ ุงูุฃุบุฑุงุถ ุณุชุฏูุนูุง ูููุงุจุชู ุนูุฏ ุงุณุชูุงู ุงููุงุชูุฑุฉ.</p></div>
                </div>
                <button onclick="confirmCustomOrder()" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-black py-3.5 rounded-xl shadow-lg text-sm">ุฅุฑุณุงู ุงูุทูุจ ูููุจุงุชู ๐</button>
            </div>
        </div>

        <!-- Checkout -->
        <div id="checkout-modal" class="hidden absolute inset-0 bg-gray-900/60 z-[60] flex items-end justify-center backdrop-blur-sm transition-all">
            <div class="bg-white w-full rounded-t-[2rem] p-6 shadow-2xl">
                <div class="flex justify-between items-center mb-4 border-b pb-3">
                    <h3 class="font-black text-xl text-gray-800">ุชุฃููุฏ ุงูุทูุจ</h3>
                    <button onclick="closeCheckout()" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="mb-4 bg-gray-50 p-4 rounded-xl border border-gray-100">
                    <p class="font-bold text-gray-800 text-sm mb-1" id="checkout-item-name"></p>
                    <div class="flex justify-between text-xs text-gray-500 mb-1"><span>ุณุนุฑ ุงูุทูุจ:</span><span id="checkout-item-price" class="font-bold text-gray-800"></span></div>
                    <div class="flex justify-between text-xs text-gray-500 mb-2 border-b border-gray-200 pb-2"><span>ุฃุฌุฑุฉ ุงูุชูุตูู:</span><span class="font-bold text-gray-800">1.00 JOD</span></div>
                    
                    <div class="flex items-center justify-between mt-3 bg-green-50 p-2 rounded border border-green-100" id="checkout-wallet-section">
                        <span class="text-xs font-bold text-green-800">ุงุณุชุฎุฏุงู ุฑุตูุฏ ูุญูุธุชู (<span id="checkout-wallet-bal">0</span> JOD)</span>
                        <input type="checkbox" id="checkout-use-wallet" onchange="toggleWalletDiscount()" class="w-4 h-4 text-green-500 rounded focus:ring-green-500">
                    </div>
                </div>
                <div class="flex justify-between items-center mb-6"><span class="font-bold text-gray-600">ุงููุทููุจ ุฏูุนู ููุฏุงู:</span><span class="font-black text-2xl text-blue-600" id="checkout-total-price"></span></div>
                <button id="checkout-confirm-btn" class="w-full bg-blue-600 text-white font-black py-4 rounded-xl shadow-lg text-lg">ุชุฃููุฏ ูุฅุฑุณุงู ูููุชุฌุฑ</button>
            </div>
        </div>

        <!-- Rating Modal -->
        <div id="rating-modal" class="hidden absolute inset-0 bg-gray-900/70 z-[70] flex items-center justify-center backdrop-blur-sm p-4 transition-all">
            <div class="bg-white w-full rounded-3xl p-6 shadow-2xl text-center">
                <div class="w-16 h-16 bg-yellow-100 text-yellow-500 rounded-full flex items-center justify-center text-3xl mx-auto mb-4"><i class="fa-solid fa-star"></i></div>
                <h3 class="font-black text-xl text-gray-800 mb-1">ุชู ุงูุชูุตูู ุจูุฌุงุญ!</h3>
                <p class="text-xs text-gray-500 mb-5">ููู ูุงูุช ุชุฌุฑุจุชู ูุน ุงููุงุจุชูุ ุชููููู ูุญุณู ุฌูุฏุฉ ุงูุฎุฏูุฉ.</p>
                <div class="flex justify-center gap-2 mb-6 star-rating" id="rating-stars-container">
                    <i class="fa-solid fa-star text-4xl" data-val="1" onclick="selectRating(1)"></i><i class="fa-solid fa-star text-4xl" data-val="2" onclick="selectRating(2)"></i><i class="fa-solid fa-star text-4xl" data-val="3" onclick="selectRating(3)"></i><i class="fa-solid fa-star text-4xl" data-val="4" onclick="selectRating(4)"></i><i class="fa-solid fa-star text-4xl" data-val="5" onclick="selectRating(5)"></i>
                </div>
                <button onclick="submitRating()" class="w-full bg-gray-900 hover:bg-black text-white font-bold py-3.5 rounded-xl shadow-lg text-sm mb-2">ุฅุฑุณุงู ุงูุชูููู</button>
                <button onclick="closeRatingModal()" class="w-full bg-transparent text-gray-500 font-bold py-2 text-sm">ุชุฎุทู</button>
            </div>
        </div>

        <!-- Notifications Modal -->
        <div id="notifications-modal" class="hidden absolute inset-0 bg-gray-900/50 z-[60] flex items-end justify-center transition-all">
            <div class="bg-white w-full h-3/4 rounded-t-[2rem] shadow-2xl flex flex-col">
                <div class="p-5 border-b flex justify-between items-center bg-gray-50 rounded-t-[2rem]">
                    <h3 class="font-black text-lg text-gray-800"><i class="fa-solid fa-bell text-red-500 ml-1"></i> ุงูุฅุดุนุงุฑุงุช</h3>
                    <button onclick="closeNotificationsModal()" class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-gray-600"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div id="notifications-list" class="flex-1 overflow-y-auto p-4 space-y-3 hide-scrollbar"></div>
            </div>
        </div>

        <!-- Chat Modal -->
        <div id="chat-modal" class="hidden absolute inset-0 bg-white z-[60] flex flex-col transition-all">
            <div class="bg-blue-600 text-white p-4 flex justify-between items-center shadow-md pt-6">
                <div class="flex items-center gap-3"><button onclick="closeChat()" class="w-8 h-8 rounded-full flex items-center justify-center hover:bg-white/20"><i class="fa-solid fa-arrow-right"></i></button><div><h3 class="font-bold text-sm" id="chat-title">ูุญุงุฏุซุฉ</h3></div></div>
                <a href="#" id="chat-call-btn" class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center shadow"><i class="fa-solid fa-phone text-xs"></i></a>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 flex flex-col gap-3 bg-gray-50 hide-scrollbar"></div>
            <div class="p-3 bg-white border-t flex gap-2 items-center">
                <input type="text" id="chat-input-text" class="flex-1 bg-gray-100 px-4 py-3 rounded-full text-sm outline-none" placeholder="ุงูุชุจ ุฑุณุงูุชู...">
                <button onclick="sendChatMessage()" class="w-12 h-12 bg-blue-600 text-white rounded-full flex items-center justify-center"><i class="fa-solid fa-paper-plane text-sm -ml-1"></i></button>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, getDocs, setDoc, query, where, serverTimestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyC8_o7E8xN6ba-_guVf0izSBNwlgdHcXL4",
          authDomain: "qutaiba-express.firebaseapp.com",
          projectId: "qutaiba-express",
          storageBucket: "qutaiba-express.firebasestorage.app",
          messagingSenderId: "657701995034",
          appId: "1:657701995034:web:e5348dbb914a34b5e287a3"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'qutaiba-express';
        const getCollection = (colName) => collection(db, colName);
        const getDocRef = (colName, docId) => doc(db, colName, docId);

        let currentUser = null; let currentUserData = null; let currentUserRole = '';
        let allOrders = [], allStaff = [], allUsers = [], allMenu = [], allPromos = [], allNotifications = [], allPointRequests = [];
        let appSettings = { name: 'ูุฒุนููุฉ', logo: '' };
        let currentCustCategory = 'all'; 
        
        let checkoutItem = null, checkoutBasePrice = 0, checkoutDelivery = 1.00;
        let walletDiscountActive = false, appliedWalletDiscount = 0;
        let currentChatOrderId = null, ratingTargetOrderId = null, ratingTargetCaptainId = null, currentStarVal = 5;
        
        const DEDUCTION_RATE = 0.07, MIN_WALLET_BALANCE = 0.07; 
        let captainEarnings = 0, adminCommissionRate = 0.10; 
        let isMerchantOnline = true, isCaptainOnline = true;
        
        const statusMap = {
            'pending': { text: 'ุจุงูุชุธุงุฑ ุงููุชุฌุฑ', color: 'bg-yellow-100 text-yellow-700' },
            'preparing': { text: 'ุฌุงุฑู ุงูุชุฌููุฒ', color: 'bg-orange-100 text-orange-700' },
            'ready': { text: 'ุฌุงูุฒ ููุงุณุชูุงู', color: 'bg-blue-100 text-blue-700' },
            'on_the_way': { text: 'ูู ุงูุทุฑูู', color: 'bg-purple-100 text-purple-700' },
            'delivered': { text: 'ุชู ุงูุชุณููู', color: 'bg-green-100 text-green-700' }
        };

        const categoryIcons = {
            'restaurant': '<i class="fa-solid fa-utensils text-3xl text-orange-400 drop-shadow-sm"></i>',
            'market': '<i class="fa-solid fa-basket-shopping text-3xl text-blue-400 drop-shadow-sm"></i>',
            'pharmacy': '<i class="fa-solid fa-pills text-3xl text-green-400 drop-shadow-sm"></i>'
        };

        const initAuth = async () => { try { await signInAnonymously(auth); } catch(e) { console.error("Auth error:", e); } };
        initAuth();
        onAuthStateChanged(auth, (user) => { if (user) { currentUser = user; startFirestoreListeners(); } });

        let unsubs = [];
        function startFirestoreListeners() {
            unsubs.forEach(unsub => unsub()); unsubs = [];
            if(!currentUser) return;

            unsubs.push(onSnapshot(getDocRef('settings', 'app_config'), (docSnap) => { if(docSnap.exists()) { appSettings = docSnap.data(); applyAppSettings(); }}));
            unsubs.push(onSnapshot(getCollection('orders'), (snapshot) => {
                const newOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                newOrders.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                if(currentUserRole === 'customer') { const myActive = newOrders.filter(o => o.customerId === (currentUserData?.uid || 'demo_cust') && o.status !== 'delivered'); document.getElementById('cart-badge').classList.toggle('hidden', myActive.length === 0); }
                if(currentChatOrderId) { const activeO = newOrders.find(o => o.id === currentChatOrderId); if(activeO) renderChatMessages(activeO.chat || []); }
                allOrders = newOrders; updateUI();
            }));
            unsubs.push(onSnapshot(getCollection('staff'), (snapshot) => {
                allStaff = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (currentUserRole === 'captain' && currentUserData) { const me = allStaff.find(s => s.id === currentUserData.id); if(me) { currentUserData.walletBalance = me.walletBalance; updateCaptainWalletUI(); } }
                if (currentUserRole === 'admin') { renderAdminStaffList(); updateAdminNotifDropdown(); }
            }));
            
            unsubs.push(onSnapshot(getCollection('users'), (snap) => { 
                allUsers = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
                if(currentUserRole === 'customer' && currentUserData) {
                    const me = allUsers.find(u => u.uid === currentUserData.uid);
                    if(me) { 
                        currentUserData.loyaltyPoints = me.loyaltyPoints || 0; 
                        currentUserData.walletBalance = me.walletBalance || 0;
                        document.getElementById('prof-points').innerText = currentUserData.loyaltyPoints; 
                        document.getElementById('cust-points-display').innerText = currentUserData.loyaltyPoints; 
                        document.getElementById('prof-wallet').innerText = currentUserData.walletBalance.toFixed(2);
                        const convertBtn = document.getElementById('convert-points-section');
                        if(currentUserData.loyaltyPoints >= 1000) convertBtn.classList.remove('hidden'); else convertBtn.classList.add('hidden');
                    }
                }
                if(currentUserRole === 'admin') updateAdminNotifDropdown();
            }));

            unsubs.push(onSnapshot(getCollection('point_requests'), (snap) => {
                allPointRequests = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if(currentUserRole === 'admin') {
                    const pending = allPointRequests.filter(r => r.status === 'pending');
                    document.getElementById('finance-badge').classList.toggle('hidden', pending.length === 0);
                    renderAdminFinance();
                }
            }));

            unsubs.push(onSnapshot(getCollection('notifications'), (snap) => { allNotifications = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0)); updateNotificationsUI(); }));
            unsubs.push(onSnapshot(getCollection('menu'), (snap) => { allMenu = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); updateUI(); }));
            unsubs.push(onSnapshot(getCollection('promos'), (snap) => { allPromos = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); updateUI(); }));
        }

        function applyAppSettings() {
            document.getElementById('app-name-display-1').innerText = appSettings.name || 'ูุฒุนููุฉ';
            document.getElementById('app-name-display-2').innerText = appSettings.name || 'ูุฒุนููุฉ';
            const logoContainer = document.getElementById('app-logo-container');
            if(appSettings.logo && appSettings.logo.startsWith('http')) {
                logoContainer.innerHTML = `<img src="${appSettings.logo}" class="w-full h-full object-cover">`; logoContainer.classList.remove('p-4');
            } else { logoContainer.innerHTML = `<i class="fa-solid fa-rocket text-orange-500"></i>`; }
        }

        // --- Notifications ---
        async function sendAppNotification(recipientId, message) { try { await addDoc(getCollection('notifications'), { recipientId, message, read: false, timestamp: serverTimestamp() }); } catch(e) {} }
        function updateNotificationsUI() {
            if(!currentUserData) return;
            const myId = currentUserRole === 'customer' ? currentUserData.uid : currentUserData.id;
            const myNotifs = allNotifications.filter(n => n.recipientId === myId || n.recipientId === 'all' || n.recipientId === `${currentUserRole}s`);
            const unreadCount = myNotifs.filter(n => !n.read).length;
            
            if(currentUserRole === 'customer') document.getElementById('cust-notif-badge').classList.toggle('hidden', unreadCount === 0);
            if(currentUserRole === 'merchant') document.getElementById('merch-notif-badge').classList.toggle('hidden', unreadCount === 0);
            if(currentUserRole === 'captain') document.getElementById('capt-notif-badge').classList.toggle('hidden', unreadCount === 0);
            
            if(unreadCount > 0 && myNotifs[0] && myNotifs[0].timestamp) { const age = Date.now() - myNotifs[0].timestamp.toMillis(); if(age < 10000) showToast(`๐ ุฅุดุนุงุฑ: ${myNotifs[0].message}`, 'info'); }

            const list = document.getElementById('notifications-list');
            if(myNotifs.length === 0) { list.innerHTML = '<p class="text-center text-xs text-gray-400 py-10">ูุง ุชูุฌุฏ ุฅุดุนุงุฑุงุช ุญุงููุงู</p>'; return; }
            list.innerHTML = myNotifs.map(n => `<div class="p-3 bg-white rounded-xl shadow-sm border ${n.read ? 'border-gray-100 opacity-70' : 'border-indigo-200 bg-indigo-50/30'}"><p class="text-sm font-bold text-gray-800">${n.message}</p></div>`).join('');
        }
        window.openNotificationsModal = () => { document.getElementById('notifications-modal').classList.remove('hidden'); };
        window.closeNotificationsModal = () => { 
            document.getElementById('notifications-modal').classList.add('hidden'); 
            if(currentUserRole === 'customer') document.getElementById('cust-notif-badge').classList.add('hidden');
            if(currentUserRole === 'merchant') document.getElementById('merch-notif-badge').classList.add('hidden');
            if(currentUserRole === 'captain') document.getElementById('capt-notif-badge').classList.add('hidden');
        };

        // --- Auth ---
        window.getLocation = () => {
            const locInput = document.getElementById('reg-location'); locInput.value = "ุฌุงุฑู ุงูุจุญุซ...";
            if (navigator.geolocation) { navigator.geolocation.getCurrentPosition((pos) => { locInput.value = `${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`; showToast('ุชู ุงูุชูุงุท ุงููููุน', 'success'); }, (e) => { showToast('ุงุณูุญ ุจุงููุตูู', 'error'); }, { enableHighAccuracy: true });
            } else { showToast('ูุง ูุฏุนู', 'error'); }
        };
        window.registerCustomer = async () => {
            const name = document.getElementById('reg-name').value.trim(); const phone = document.getElementById('reg-phone').value.trim(); const loc = document.getElementById('reg-location').value.trim(); const pass = document.getElementById('reg-password').value;
            if(!name || !phone || !loc || !pass) return showToast('ุฃููู ุงูุญููู', 'error');
            const uid = "cust_" + Math.random().toString(36).substr(2, 9);
            currentUserData = { uid: uid, name: name, phone: phone, location: loc, password: pass, role: 'customer', loyaltyPoints: 0, walletBalance: 0, banned: false };
            await addDoc(getCollection('users'), currentUserData);
            currentUserRole = 'customer'; setupCustomerProfile(); showView('customer'); showToast('ุชู ุงูุชุณุฌูู ุจูุฌุงุญ', 'success'); sendAppNotification(uid, 'ุฃููุงู ุจู ูู ูุฒุนุฉ!');
        };
        window.loginCustomer = async () => {
            const phone = document.getElementById('login-phone').value.trim(); const pass = document.getElementById('login-password').value;
            if(!phone || !pass) return showToast('ุฃุฏุฎู ุงูุจูุงูุงุช', 'error');
            
            const foundUser = allUsers.find(u => u.phone === phone && u.password === pass);
            if (foundUser) {
                if(foundUser.banned) return showToast('ุญุณุงุจ ูุญุธูุฑ ๐ซ', 'error');
                currentUserData = foundUser; currentUserRole = 'customer'; setupCustomerProfile(); showView('customer'); showToast('ูุฑุญุจุงู ุจู!', 'success');
            } else showToast('ุงูุจูุงูุงุช ุบูุฑ ุตุญูุญุฉ', 'error');
        };
        function setupCustomerProfile() {
            document.getElementById('cust-name-display').innerText = currentUserData.name; 
            document.getElementById('cust-loc-display').innerText = currentUserData.location; 
            document.getElementById('prof-name').innerText = currentUserData.name;
            document.getElementById('prof-phone').innerText = currentUserData.phone;
            document.getElementById('prof-loc').innerText = currentUserData.location;
            document.getElementById('prof-points').innerText = currentUserData.loyaltyPoints || 0;
            document.getElementById('cust-points-display').innerText = currentUserData.loyaltyPoints || 0;
            document.getElementById('prof-wallet').innerText = (currentUserData.walletBalance || 0).toFixed(2);
            const convertBtn = document.getElementById('convert-points-section');
            if((currentUserData.loyaltyPoints || 0) >= 1000) convertBtn.classList.remove('hidden'); else convertBtn.classList.add('hidden');
            switchCustTab('home'); updateNotificationsUI();
        }
        window.loginStaff = async () => {
            const role = document.getElementById('login-staff-role').value; const workNum = document.getElementById('login-staff-worknum').value.trim().toUpperCase(); const pass = document.getElementById('login-staff-password').value;
            
            // ูุฏูุฑ ุงููุธุงู ุงูุฑุฆูุณู
            if (role === 'admin' && workNum === '2150502071' && pass === 'Moath1234') {
                currentUserRole = 'admin'; currentUserData = { name: 'ูุนุงุฐ ุงูุฎูุงูุฏุฉ', role: 'admin' };
                document.getElementById('admin-name-display').innerText = 'ูุนุงุฐ'; showView('admin'); return;
            }
            // ูุญุต ุงููุฏุฑุงุก ูุงููุจุงุชู ูุงูุชุฌุงุฑ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
            const foundStaff = allStaff.find(s => s.role === role && s.workNumber === workNum && s.password === pass);
            if (foundStaff) {
                if(foundStaff.banned) return showToast('ุงูุญุณุงุจ ูุญุธูุฑ ๐ซ', 'error');
                currentUserData = foundStaff; currentUserRole = role;
                
                if (role === 'admin') { document.getElementById('admin-name-display').innerText = currentUserData.name.split(' ')[0] || 'ูุฏูุฑ'; showView('admin'); }
                else if (role === 'merchant') { document.getElementById('merchant-name-display').innerText = currentUserData.name; showView('merchant'); } 
                else if (role === 'captain') { 
                    document.getElementById('captain-name-display').innerText = currentUserData.name; 
                    const avg = currentUserData.ratingCount ? (currentUserData.ratingSum / currentUserData.ratingCount).toFixed(1) : '5.0';
                    document.getElementById('captain-rating-display').innerText = avg;
                    updateCaptainWalletUI(); showView('captain'); 
                }
                updateNotificationsUI();
            } else { showToast('ุงูุจูุงูุงุช ุบูุฑ ุตุญูุญุฉ', 'error'); }
        };
        
        window.toggleMerchantCategory = () => {
            const role = document.getElementById('new-staff-role').value;
            const categoryContainer = document.getElementById('new-staff-category-container');
            const workNumInput = document.getElementById('new-staff-worknum');
            
            if (categoryContainer) { categoryContainer.classList.toggle('hidden', role !== 'merchant'); }
            if (workNumInput) { workNumInput.classList.toggle('hidden', role !== 'admin'); }
        };

        window.registerStaff = async () => {
            if (currentUserRole !== 'admin') return;
            const role = document.getElementById('new-staff-role').value; 
            const cat = role === 'merchant' ? document.getElementById('new-staff-category').value : null;
            const name = document.getElementById('new-staff-name').value.trim(); 
            const phone = document.getElementById('new-staff-phone').value.trim(); 
            const pass = document.getElementById('new-staff-password').value;
            
            const customWorkNum = document.getElementById('new-staff-worknum').value.trim();
            const workNum = (role === 'admin' && customWorkNum) ? customWorkNum : `QE-${Math.floor(1000 + Math.random() * 9000)}`;

            if(!name || !phone || !pass || (role === 'admin' && !customWorkNum)) return showToast('ุฃููู ุงูุจูุงูุงุช ุจุงููุงูู', 'error');
            
            await addDoc(getCollection('staff'), { role, businessType: cat, name, workNumber: workNum, phone, password: pass, walletBalance: 0, banned: false, createdAt: serverTimestamp() });
            showToast(`ุชู ุฅุถุงูุฉ ${name}. ุฑููู: ${workNum}`, 'success');
            document.getElementById('new-staff-name').value = ''; document.getElementById('new-staff-phone').value = ''; document.getElementById('new-staff-password').value = ''; document.getElementById('new-staff-worknum').value = '';
        };
        window.logout = () => { currentUserRole = ''; currentUserData = null; showView('login'); };

        // --- Captain Wallet ---
        function updateCaptainWalletUI() {
            if(currentUserRole !== 'captain' || !currentUserData) return;
            const bal = currentUserData.walletBalance || 0; document.getElementById('captain-wallet-display').innerText = bal.toFixed(2);
            const overlay = document.getElementById('captain-wallet-overlay'); const badge = document.getElementById('captain-status-badge');
            if(bal < MIN_WALLET_BALANCE) { overlay.classList.remove('hidden'); badge.className = "bg-red-500/20 text-red-500 border border-red-500/50 px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1"; badge.innerHTML = `<i class="fa-solid fa-lock"></i> ููููู`; } 
            else { overlay.classList.add('hidden'); badge.className = "bg-green-500/20 text-green-400 border border-green-500/50 px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1"; badge.innerHTML = `<div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div> ูุชุงุญ`; }
            renderCaptain();
        }

        // --- Loyalty & Points ---
        window.requestPointsConversion = async () => {
            if((currentUserData.loyaltyPoints || 0) < 1000) return showToast('ุชุญุชุงุฌ 1000 ููุทุฉ ูุญุฏ ุฃุฏูู', 'error');
            try { await addDoc(getCollection('point_requests'), { customerId: currentUserData.uid, customerName: currentUserData.name, points: 1000, money: 1.00, status: 'pending', timestamp: serverTimestamp() }); showToast('ุชู ุฅุฑุณุงู ุทูุจ ุงูุชุญููู ููุฅุฏุงุฑุฉ', 'success'); } catch(e) { showToast('ุฎุทุฃ ูู ุงูุฅุฑุณุงู', 'error'); }
        };
        window.approvePointRequest = async (reqId, custUid) => {
            try {
                const userQ = await getDocs(query(getCollection('users'), where('uid','==',custUid)));
                if(!userQ.empty) {
                    const uDoc = userQ.docs[0]; const ud = uDoc.data();
                    if(ud.loyaltyPoints >= 1000) {
                        await updateDoc(doc(db, 'users', uDoc.id), { loyaltyPoints: ud.loyaltyPoints - 1000, walletBalance: (ud.walletBalance || 0) + 1.00 });
                        await updateDoc(doc(db, 'point_requests', reqId), { status: 'approved' });
                        sendAppNotification(custUid, 'ุชู ุชุญููู 1000 ููุทุฉ ุฅูู 1 ุฏููุงุฑ ูู ูุญูุธุชู ๐ฐ');
                        showToast('ุชูุช ุงูููุงููุฉ ูุชู ุงูุชุญููู', 'success');
                    } else showToast('ููุงุท ุงูุฒุจูู ุบูุฑ ูุงููุฉ', 'error');
                }
            } catch(e) {}
        };
        window.rejectPointRequest = async (reqId) => { await updateDoc(doc(db, 'point_requests', reqId), { status: 'rejected' }); showToast('ุชู ุฑูุถ ุงูุทูุจ', 'info'); };

        // --- Checkout ---
        window.openCustomOrderModal = () => { document.getElementById('custom-order-modal').classList.remove('hidden'); };
        window.closeCustomOrderModal = () => { document.getElementById('custom-order-modal').classList.add('hidden'); };
        window.confirmCustomOrder = async () => {
            const place = document.getElementById('custom-place-name').value.trim(); const details = document.getElementById('custom-item-name').value.trim();
            if(!place || !details) return showToast('ุฃุฏุฎู ุชูุงุตูู ุงูุทูุจ ูุงูููุงู', 'error');
            await addDoc(getCollection('orders'), { type: 'custom', customerId: currentUserData.uid || 'demo_cust', customerName: currentUserData.name, customerPhone: currentUserData.phone || '0000', customerLocation: currentUserData.location || 'ุงูููุฑู', item: `${details} (ูู: ${place})`, price: 0, deliveryFee: 1.50, status: 'ready', chat: [], timestamp: serverTimestamp() });
            closeCustomOrderModal(); showToast('ุชู ุจุซ ุงูุทูุจ ูููุจุงุชู ๐', 'success'); switchCustTab('cart'); sendAppNotification('captains', 'ุทูุจ ุชูุตูู ูุฎุตุต ุฌุฏูุฏ ุจุงูุชุธุงุฑ ุจุทู!');
        };
        window.openCheckout = (itemName, price, mName, mId) => {
            checkoutItem = { name: itemName, basePrice: price, mName: mName, mId: mId }; checkoutBasePrice = price; walletDiscountActive = false; appliedWalletDiscount = 0;
            document.getElementById('checkout-item-name').innerText = `${itemName} (${mName})`; document.getElementById('checkout-item-price').innerText = `${price.toFixed(2)} JOD`;
            const wallSec = document.getElementById('checkout-wallet-section'); const cb = document.getElementById('checkout-use-wallet'); const myBal = currentUserData?.walletBalance || 0;
            if(myBal > 0) { wallSec.classList.remove('hidden'); document.getElementById('checkout-wallet-bal').innerText = myBal.toFixed(2); cb.checked = false; } else { wallSec.classList.add('hidden'); }
            updateCheckoutTotal(); document.getElementById('checkout-modal').classList.remove('hidden');
        };
        window.closeCheckout = () => { document.getElementById('checkout-modal').classList.add('hidden'); };
        window.toggleWalletDiscount = () => { walletDiscountActive = document.getElementById('checkout-use-wallet').checked; updateCheckoutTotal(); };
        function updateCheckoutTotal() {
            const totalCost = checkoutBasePrice + checkoutDelivery; const myBal = currentUserData?.walletBalance || 0;
            if(walletDiscountActive) { appliedWalletDiscount = Math.min(totalCost, myBal); } else { appliedWalletDiscount = 0; }
            const finalCash = totalCost - appliedWalletDiscount; document.getElementById('checkout-total-price').innerText = `${finalCash.toFixed(2)} JOD`;
        }
        window.confirmOrderPlacement = async () => {
            const finalCash = (checkoutBasePrice + checkoutDelivery) - appliedWalletDiscount;
            await addDoc(getCollection('orders'), { type: 'standard', merchantId: checkoutItem.mId, customerId: currentUserData.uid || 'demo_cust', customerName: currentUserData.name, customerPhone: currentUserData.phone || '0000', customerLocation: currentUserData.location || 'ุงูููุฑู', item: `${checkoutItem.name} (${checkoutItem.mName})`, price: checkoutBasePrice, deliveryFee: checkoutDelivery, walletPaid: appliedWalletDiscount, cashToPay: finalCash, status: 'pending', chat: [], timestamp: serverTimestamp() });
            if(appliedWalletDiscount > 0 && currentUserData.uid !== 'demo_cust') { const userQ = await getDocs(query(getCollection('users'), where('uid','==',currentUserData.uid))); if(!userQ.empty) updateDoc(doc(db, 'users', userQ.docs[0].id), { walletBalance: (currentUserData.walletBalance || 0) - appliedWalletDiscount }); }
            closeCheckout(); showToast('ุชู ุฅุฑุณุงู ุงูุทูุจ ุจูุฌุงุญ! ๐', 'success'); switchCustTab('cart'); sendAppNotification(checkoutItem.mId, `ุทูุจ ุฌุฏูุฏ ูู ${currentUserData.name}`);
        };

        // --- Shared Update Status ---
        window.updateOrderStatus = async (orderId, newStatus) => { 
            const payload = { status: newStatus }; const order = allOrders.find(o => o.id === orderId);
            if(newStatus === 'preparing' && order) sendAppNotification(order.customerId, 'ุงููุชุฌุฑ ุจุฏุฃ ุจุชุฌููุฒ ุทูุจู ๐จโ๐ณ');
            if(newStatus === 'ready') sendAppNotification('captains', `ุทูุจ ุฌุงูุฒ ููุชูุตูู!`);
            if(newStatus === 'on_the_way' && currentUserRole === 'captain') { payload.captainPhone = currentUserData.phone || '0000'; payload.captainId = currentUserData.id; if(order) { sendAppNotification(order.customerId, `ุงููุงุจุชู ${currentUserData.name} ุงุณุชูู ุงูุทูุจ ููู ุจุงูุทุฑูู! ๐ต`); if(order.merchantId) sendAppNotification(order.merchantId, `ุชู ุงุณุชูุงู ุงูุทูุจ ูู ุงููุงุจุชู.`); } }
            await updateDoc(doc(db, 'orders', orderId), payload); 
        };
        window.finishDelivery = async (orderId, fee) => {
            const deduction = fee * DEDUCTION_RATE; const bal = currentUserData.walletBalance || 0;
            if(bal < deduction) return showToast('ุฑุตูุฏ ุงููุญูุธุฉ ูุง ูููู', 'error');
            await updateOrderStatus(orderId, 'delivered'); await updateDoc(doc(db, 'staff', currentUserData.id), { walletBalance: bal - deduction });
            showToast(`ุชู ุงูุชุณููู (ุฎูุตู ${deduction.toFixed(2)} JOD)`, 'success');
            const order = allOrders.find(o => o.id === orderId);
            if(order && order.customerId !== 'demo_cust') {
                const points = 10; 
                const userQ = await getDocs(query(getCollection('users'), where('uid','==',order.customerId)));
                if(!userQ.empty) { const uDoc = userQ.docs[0]; updateDoc(doc(db, 'users', uDoc.id), { loyaltyPoints: (uDoc.data().loyaltyPoints || 0) + points }); sendAppNotification(order.customerId, `ุชู ุงูุชูุตูู ุจูุฌุงุญ โ ูุณุจุช ${points} ููุงุท ููุงุก!`); }
            }
        };

        // --- Chat ---
        window.openChat = (orderId, otherPhone) => { currentChatOrderId = orderId; const order = allOrders.find(o => o.id === orderId); document.getElementById('chat-title').innerText = `ูุญุงุฏุซุฉ #${order.id.substring(0,5)}`; document.getElementById('chat-call-btn').href = `tel:${otherPhone}`; document.getElementById('chat-modal').classList.remove('hidden'); renderChatMessages(order.chat || []); };
        window.closeChat = () => { document.getElementById('chat-modal').classList.add('hidden'); currentChatOrderId = null; };
        window.sendChatMessage = async () => { const input = document.getElementById('chat-input-text'); const text = input.value.trim(); if(!text || !currentChatOrderId) return; input.value = ''; await updateDoc(doc(db, 'orders', currentChatOrderId), { chat: arrayUnion({ sender: currentUserRole, text: text, time: new Date().toLocaleTimeString('ar-JO', {hour:'2-digit', minute:'2-digit'}) }) }); };
        function renderChatMessages(msgs) { const container = document.getElementById('chat-messages'); if(msgs.length === 0) container.innerHTML = `<p class="text-center text-xs text-gray-400 mt-10">ุจุฏุงูุฉ ุงููุญุงุฏุซุฉ</p>`; else container.innerHTML = msgs.map(msg => `<div class="px-4 py-2 text-sm shadow-sm max-w-[80%] ${msg.sender === currentUserRole ? 'chat-me' : 'chat-other'} relative">${msg.text}<span class="block text-[8px] opacity-60 mt-1 text-right">${msg.time}</span></div>`).join(''); container.scrollTop = container.scrollHeight; }

        // --- Rating System ---
        window.openRatingModal = (orderId, captainId) => { ratingTargetOrderId = orderId; ratingTargetCaptainId = captainId; currentStarVal = 5; document.querySelectorAll('#rating-stars-container i').forEach(el => { el.classList.add('active'); el.style.color = '#fbbf24'; }); document.getElementById('rating-modal').classList.remove('hidden'); };
        window.closeRatingModal = () => { document.getElementById('rating-modal').classList.add('hidden'); };
        window.selectRating = (val) => { currentStarVal = val; document.querySelectorAll('#rating-stars-container i').forEach(el => { if(parseInt(el.dataset.val) <= val) { el.classList.add('active'); el.style.color = '#fbbf24'; } else { el.classList.remove('active'); el.style.color = '#d1d5db'; } }); };
        window.submitRating = async () => {
            if(!ratingTargetCaptainId) { closeRatingModal(); return; }
            try {
                const cRef = doc(db, 'staff', ratingTargetCaptainId); const cDoc = allStaff.find(s => s.id === ratingTargetCaptainId);
                if(cDoc) { await updateDoc(cRef, { ratingSum: (cDoc.ratingSum || 0) + currentStarVal, ratingCount: (cDoc.ratingCount || 0) + 1 }); }
                await updateDoc(doc(db, 'orders', ratingTargetOrderId), { rated: true });
                showToast('ุดูุฑุงู ูุชููููู! โญ', 'success'); sendAppNotification(ratingTargetCaptainId, `ุญุตูุช ุนูู ุชูููู ${currentStarVal} ูุฌูู ูุทูุจู ุงูุฃุฎูุฑ!`);
            } catch(e) {}
            closeRatingModal(); renderCustomer();
        };

        // --- Merchant ---
        window.previewImageName = (input) => { const p = document.getElementById('image-preview-name'); if(input.files && input.files[0]) { p.innerText = 'ุชู ุฅุฑูุงู: ' + input.files[0].name; p.classList.remove('hidden'); } else p.classList.add('hidden'); };
        window.addMenuItem = async () => {
            if (currentUserRole !== 'merchant') return;
            const name = document.getElementById('new-item-name').value.trim(); const price = parseFloat(document.getElementById('new-item-price').value); const fileInput = document.getElementById('new-item-image');
            if(!name || !price) return showToast('ุฃุฏุฎู ุงูุงุณู ูุงูุณุนุฑ', 'error');
            const btn = document.getElementById('btn-add-menu'); btn.innerHTML = '<div class="loader border-white"></div>';
            let base64Image = null;
            if(fileInput.files.length > 0) { const file = fileInput.files[0]; const reader = new FileReader(); reader.onload = async (e) => { base64Image = e.target.result; saveItemToDB(name, price, base64Image, btn); }; reader.readAsDataURL(file); } else { saveItemToDB(name, price, null, btn); }
        };
        async function saveItemToDB(name, price, imageStr, btn) { try { await addDoc(getCollection('menu'), { merchantId: currentUserData.id, merchantName: currentUserData.name, merchantType: currentUserData.businessType || 'restaurant', name: name, price: price, image: imageStr }); showToast('ุชูุช ุงูุฅุถุงูุฉ', 'success'); document.getElementById('new-item-name').value = ''; document.getElementById('new-item-price').value = ''; document.getElementById('new-item-image').value = ''; document.getElementById('image-preview-name').classList.add('hidden'); } catch(e) { showToast('ุฎุทุฃ', 'error'); } finally { btn.innerText = 'ุฅุถุงูุฉ'; } }
        window.deleteMenuItem = async (id) => { try { await deleteDoc(doc(db, 'menu', id)); } catch(e) {} };

        // --- Admin ---
        function updateAdminNotifDropdown() {
            const select = document.getElementById('admin-notif-target'); if(!select) return;
            let html = `<option value="all">ุงูุฌููุน (ูุจุงุชูุ ูุชุงุฌุฑุ ุฒุจุงุฆู)</option><option value="captains">ุฌููุน ุงููุจุงุชู</option><option value="merchants">ุฌููุน ุงููุชุงุฌุฑ</option><option value="customers">ุฌููุน ุงูุฒุจุงุฆู</option><optgroup label="ุงููุณุชุฎุฏููู">`;
            allUsers.forEach(u => html += `<option value="${u.uid}">ุฒุจูู: ${u.name}</option>`); html += `</optgroup><optgroup label="ุงููุฑูู">`;
            allStaff.forEach(s => html += `<option value="${s.id}">${s.role === 'captain' ? 'ูุงุจุชู': s.role === 'admin' ? 'ูุฏูุฑ' : 'ูุชุฌุฑ'}: ${s.name}</option>`); html += `</optgroup>`;
            select.innerHTML = html;
        }
        window.sendAdminNotification = async () => { if(currentUserRole !== 'admin') return; const target = document.getElementById('admin-notif-target').value; const msg = document.getElementById('admin-notif-msg').value.trim(); if(!msg) return showToast('ุงูุชุจ ุงูุฑุณุงูุฉ', 'error'); await sendAppNotification(target, `ุฅุนูุงู ุงูุฅุฏุงุฑุฉ: ${msg}`); showToast('ุชู ุจุซ ุงูุฅุดุนุงุฑ ุจูุฌุงุญ', 'success'); document.getElementById('admin-notif-msg').value = ''; };
        
        window.toggleBan = async (collectionName, docId, currentStatus) => { if(currentUserRole !== 'admin') return; try { await updateDoc(doc(db, collectionName, docId), { banned: !currentStatus }); showToast(!currentStatus ? 'ุชู ุญุธุฑ ุงููุณุชุฎุฏู ๐ซ' : 'ุชู ูู ุงูุญุธุฑ โ', 'success'); } catch(e) { showToast('ุฎุทุฃ ูู ุงูุชุนุฏูู', 'error'); } };

        // --- Views & UI Logic ---
        window.setCustCategory = (cat) => { currentCustCategory = cat; document.querySelectorAll('.cat-btn').forEach(btn => { btn.classList.remove('bg-indigo-600', 'text-white', 'shadow-md'); btn.classList.add('bg-white', 'text-gray-600'); }); document.getElementById(`btn-cat-${cat}`).classList.remove('bg-white', 'text-gray-600'); document.getElementById(`btn-cat-${cat}`).classList.add('bg-indigo-600', 'text-white', 'shadow-md'); renderCustomer(); };
        window.switchCustTab = (tab) => { ['home', 'cart', 'profile'].forEach(t => { document.getElementById(`cust-tab-${t}`).classList.toggle('hidden', t !== tab); document.getElementById(`cust-tab-${t}`).classList.toggle('block', t === tab); const btn = document.getElementById(`nav-btn-${t}`); if(t === tab) { btn.classList.add('nav-active'); btn.classList.remove('text-gray-400'); } else { btn.classList.remove('nav-active'); btn.classList.add('text-gray-400'); } }); if(tab === 'cart') document.getElementById('cart-badge').classList.add('hidden'); };
        window.switchAdminTab = (tab) => { ['dash', 'staff', 'finance', 'notifs'].forEach(t => { const content = document.getElementById(`admin-${t}-content`); if(content) { content.classList.toggle('hidden', t !== tab); content.classList.toggle('block', t === tab); } const btn = document.getElementById(`tab-admin-${t}`); if(btn) { btn.className = `flex-1 min-w-[20%] py-2 text-[11px] font-bold rounded-lg transition-all ${t === tab ? 'bg-white shadow text-indigo-900' : 'text-indigo-600'}`; } }); if(tab === 'finance') document.getElementById('finance-badge').classList.add('hidden'); };
        window.switchMerchantTab = (tab) => { ['orders', 'menu'].forEach(t => { document.getElementById(`merchant-${t}-content`).classList.toggle('hidden', t !== tab); document.getElementById(`merchant-${t}-content`).classList.toggle('block', t === tab); document.getElementById(`tab-merchant-${t}`).className = `flex-1 py-2 text-sm font-bold rounded-lg transition-all ${t === tab ? 'bg-white shadow text-pink-600' : 'text-gray-500'}`; }); };
        window.showView = (v) => { document.querySelectorAll('div[id^="view-"]').forEach(el => { el.classList.add('hidden'); el.classList.remove('flex'); }); document.getElementById(`view-${v}`).classList.remove('hidden'); document.getElementById(`view-${v}`).classList.add('flex'); if(currentUserRole) updateUI(); };
        window.switchLoginTab = (t) => { const isCust = t === 'customer'; document.getElementById('form-customer').classList.toggle('hidden', !isCust); document.getElementById('form-staff').classList.toggle('hidden', isCust); document.getElementById('tab-customer').className = `flex-1 py-2 text-sm font-bold rounded-lg transition-all ${isCust ? 'bg-white shadow text-indigo-700' : 'text-gray-500'}`; document.getElementById('tab-staff').className = `flex-1 py-2 text-sm font-bold rounded-lg transition-all ${!isCust ? 'bg-white shadow text-indigo-700' : 'text-gray-500'}`; };
        window.showToast = (msg, type = 'info') => { const toast = document.getElementById('toast'); document.getElementById('toast-msg').innerText = msg; const style = {'success':{bg:'bg-green-600', ic:'fa-check-circle'},'error':{bg:'bg-red-600', ic:'fa-triangle-exclamation'},'info':{bg:'bg-gray-900', ic:'fa-bell'}}; toast.className = `absolute top-6 left-1/2 transform -translate-x-1/2 ${style[type].bg} text-white px-5 py-3 rounded-2xl shadow-2xl transition-all duration-300 opacity-0 z-[100] flex items-center gap-3 text-sm font-bold min-w-[250px]`; document.getElementById('toast-icon').innerHTML = `<i class="fa-solid ${style[type].ic}"></i>`; toast.classList.remove('opacity-0', '-translate-y-4'); toast.classList.add('translate-y-0'); setTimeout(() => { toast.classList.add('opacity-0', '-translate-y-4'); toast.classList.remove('translate-y-0'); }, 3500); };

        function updateUI() { if (currentUserRole === 'customer') renderCustomer(); if (currentUserRole === 'merchant') renderMerchant(); if (currentUserRole === 'captain') renderCaptain(); if (currentUserRole === 'admin') renderAdmin(); }

        function renderCustomer() {
            const menuList = document.getElementById('customer-menu-list'); const filteredMenu = currentCustCategory === 'all' ? allMenu : allMenu.filter(m => m.merchantType === currentCustCategory);
            if(filteredMenu.length > 0) { 
                menuList.innerHTML = filteredMenu.map(item => {
                    const imgHTML = item.image ? `<img src="${item.image}" class="w-full h-16 object-cover rounded-xl mb-2">` : `<div class="w-full h-16 bg-gray-50 rounded-xl mb-2 flex items-center justify-center">${categoryIcons[item.merchantType] || categoryIcons['restaurant']}</div>`;
                    return `<div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between"><div>${imgHTML}<span class="text-[9px] text-gray-500 font-bold bg-gray-100 px-2 py-0.5 rounded block mb-1 truncate">${item.merchantName || 'ูุชุฌุฑ'}</span><h4 class="font-bold text-gray-800 text-[13px] leading-snug">${item.name}</h4><p class="text-blue-600 font-black text-sm my-1">${item.price.toFixed(2)} JOD</p></div><button onclick="openCheckout('${item.name}', ${item.price}, '${item.merchantName}', '${item.merchantId}')" class="w-full bg-indigo-600 text-white text-[11px] font-bold py-2 mt-2 rounded-lg shadow-sm">ุฅุถุงูุฉ ููุณูุฉ</button></div>`;
                }).join(''); 
            } else { menuList.innerHTML = '<p class="col-span-2 text-center text-xs text-gray-400 py-4">ูุง ููุฌุฏ ุนูุงุตุฑ ุญุงููุงู</p>'; }

            const list = document.getElementById('customer-orders-list'); const myOrders = allOrders.filter(o => o.customerId === (currentUserData?.uid || 'demo_cust'));
            if (myOrders.length === 0) { list.innerHTML = `<div class="text-center py-10 opacity-50"><i class="fa-solid fa-basket-shopping text-5xl mb-3 text-gray-300"></i><p class="text-sm font-bold text-gray-400">ุณูุชู ูุงุฑุบุฉ</p></div>`; return; }
            list.innerHTML = myOrders.map(order => `
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 relative">
                    <div class="flex justify-between items-center mb-3"><span class="font-bold text-gray-800 text-sm">#${order.id.substring(0,5)}</span><span class="text-[10px] px-2 py-1 rounded-md font-bold ${statusMap[order.status]?.color || 'bg-gray-100 text-gray-700'}">${statusMap[order.status]?.text || 'ุบูุฑ ูุนุฑูู'}</span></div>
                    <p class="text-xs font-bold text-gray-600 mb-3 bg-gray-50 p-2 rounded-lg">${order.item}</p>
                    <div class="flex justify-between items-center border-t border-gray-100 pt-3">
                        <span class="font-black text-blue-600 text-sm">${order.type === 'custom' ? 'ุงูุฏูุน ุนุงููุงุชูุฑุฉ' : (order.cashToPay !== undefined ? order.cashToPay.toFixed(2) : (order.price + order.deliveryFee).toFixed(2)) + ' JOD ููุฏุงู'}</span>
                        ${order.status === 'on_the_way' ? `<button onclick="openChat('${order.id}', '${order.captainPhone||'0000'}')" class="bg-blue-100 text-blue-700 px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm hover:bg-blue-200"><i class="fa-solid fa-comments"></i> ุดุงุช</button>` : ''}
                        ${order.status === 'delivered' && !order.rated && order.captainId ? `<button onclick="openRatingModal('${order.id}', '${order.captainId}')" class="bg-yellow-400 text-yellow-900 px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm"><i class="fa-solid fa-star"></i> ุชูููู ุงููุงุจุชู</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function renderMerchant() {
            const list = document.getElementById('merchant-orders-list'); const activeOrders = allOrders.filter(o => (o.status === 'pending' || o.status === 'preparing') && o.merchantId === currentUserData?.id);
            if (activeOrders.length === 0) list.innerHTML = '<p class="text-center py-12 text-gray-400 text-sm">ูุง ููุฌุฏ ุทูุจุงุช ุฌุฏูุฏุฉ</p>';
            else {
                list.innerHTML = activeOrders.map(order => `
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-r-4 ${order.status === 'pending' ? 'border-pink-500' : 'border-orange-500'}">
                        <div class="flex justify-between items-start mb-3"><div><span class="font-bold text-gray-800 text-sm block">${order.customerName}</span><span class="text-xs text-gray-500">${order.customerPhone}</span></div></div>
                        <p class="text-sm font-black bg-pink-50 text-pink-900 p-3 rounded-xl mb-4 text-center">${order.item}</p>
                        ${order.status === 'pending' ? `<button onclick="updateOrderStatus('${order.id}', 'preparing')" class="w-full bg-orange-500 text-white py-3 rounded-xl text-sm font-bold shadow-md">ุจุฏุก ุงูุชุฌููุฒ</button>` : `<button onclick="updateOrderStatus('${order.id}', 'ready')" class="w-full bg-green-500 text-white py-3 rounded-xl text-sm font-bold shadow-md">ุฌุงูุฒุ ุงุณุชุฏุนุงุก ุงููุงุจุชู</button>`}
                    </div>
                `).join('');
            }
            const menuList = document.getElementById('merchant-menu-list'); const myMenu = allMenu.filter(m => m.merchantId === currentUserData?.id);
            if(myMenu.length === 0) menuList.innerHTML = '<p class="text-xs text-gray-400">ุงููุงุฆูุฉ ูุงุฑุบุฉ</p>';
            else menuList.innerHTML = myMenu.map(item => `<div class="bg-white p-3 rounded-xl border border-gray-100 flex justify-between items-center shadow-sm"><div><p class="font-bold text-sm text-gray-800">${item.name}</p><p class="text-xs text-green-600 font-black">${item.price.toFixed(2)} JOD</p></div><button onclick="deleteMenuItem('${item.id}')" class="text-red-500 p-2 hover:bg-red-50 rounded-lg"><i class="fa-solid fa-trash"></i></button></div>`).join('');
        }

        function renderCaptain() {
            const list = document.getElementById('captain-orders-list'); const activeOrders = allOrders.filter(o => o.status === 'ready' || (o.status === 'on_the_way' && o.captainId === currentUserData?.id));
            const bal = currentUserData?.walletBalance || 0;
            if (activeOrders.length === 0) list.innerHTML = '<p class="text-center py-12 text-gray-400 text-sm">ูุง ููุฌุฏ ุทูุจุงุช ุฌุงูุฒุฉ ุญุงููุงู</p>';
            else {
                list.innerHTML = activeOrders.map(order => {
                    const disableAccept = bal < MIN_WALLET_BALANCE && order.status === 'ready';
                    const mapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(order.customerLocation)}`;
                    return `
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-200">
                        <div class="flex justify-between items-center mb-4"><span class="font-black text-gray-800 text-sm truncate">${order.item.split('(')[0]}</span><span class="text-[10px] bg-orange-100 text-orange-700 px-2 py-1 rounded-lg font-bold">ุฃุฌุฑุชู: ${order.deliveryFee.toFixed(2)} JOD</span></div>
                        <div class="bg-gray-50 p-3 rounded-xl mb-4 space-y-2">
                            <div class="flex justify-between items-center"><span class="text-xs font-bold text-gray-700">${order.customerLocation}</span>${order.status === 'on_the_way' ? `<button onclick="openChat('${order.id}', '${order.customerPhone}')" class="bg-blue-100 text-blue-700 px-2 py-1.5 rounded text-xs font-bold"><i class="fa-solid fa-comments"></i> ุดุงุช</button>` : ''}</div>
                            ${order.type === 'custom' ? `<span class="text-[10px] text-red-500 font-bold bg-red-50 px-2 py-1 rounded w-fit">ุทูุจ ุฎุงุฑุฌู (ุญุงุณุจ ุนุงููุงุชูุฑุฉ)</span>` : ''}
                        </div>
                        ${order.status === 'ready' ? `<button ${disableAccept ? 'disabled' : ''} onclick="updateOrderStatus('${order.id}', 'on_the_way')" class="w-full ${disableAccept ? 'bg-gray-300' : 'bg-blue-600 hover:bg-blue-700'} text-white py-3.5 rounded-xl text-sm font-bold shadow-md">ุงุณุชูุงู ุงูุทูุจ ๐จ</button>` : `<button onclick="finishDelivery('${order.id}', ${order.deliveryFee})" class="w-full bg-green-500 text-white py-3.5 rounded-xl text-sm font-bold shadow-md">ุชู ุงูุชุณููู โ</button>`}
                    </div>
                `}).join('');
            }
        }

        function renderAdmin() {
            let totalSales = 0; allOrders.forEach(o => { if(o.status === 'delivered' && o.type !== 'custom') totalSales += (o.price + o.deliveryFee); });
            document.getElementById('admin-total-sales').innerText = totalSales.toFixed(2); document.getElementById('admin-profits').innerText = (totalSales * adminCommissionRate).toFixed(2);
            const list = document.getElementById('admin-orders-list');
            if (allOrders.length === 0) list.innerHTML = '<p class="text-center text-gray-400 py-8 text-sm">ูุง ูุดุงุท</p>';
            else list.innerHTML = allOrders.map(order => `<div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center"><div><p class="font-bold text-sm text-gray-800">${order.item}</p><p class="text-[10px] ${statusMap[order.status]?.color || 'bg-gray-100 text-gray-700'} px-2 py-0.5 rounded-full mt-1 font-bold inline-block">${statusMap[order.status]?.text || 'ุบูุฑ ูุนุฑูู'}</p></div><div class="text-left"><p class="font-black text-sm text-indigo-600">${order.type==='custom'?'ูุงุชูุฑุฉ':(order.price+order.deliveryFee).toFixed(2)}</p></div></div>`).join('');
        }

        function renderAdminStaffList() {
            const list = document.getElementById('admin-staff-list');
            if (allStaff.length === 0) { list.innerHTML = '<p class="text-center text-gray-400 py-6 text-sm">ูุง ุฃุนุถุงุก</p>'; return; }
            list.innerHTML = allStaff.map(member => {
                const avgRating = member.ratingCount ? (member.ratingSum / member.ratingCount).toFixed(1) : '-';
                return `
                <div class="bg-white p-3 rounded-xl shadow-sm border ${member.banned ? 'border-red-300' : 'border-gray-100'} flex justify-between items-center">
                    <div>
                        <p class="font-bold text-sm ${member.banned ? 'text-red-700 line-through' : 'text-gray-800'}">${member.name} <span class="text-[9px] bg-gray-100 text-gray-500 px-1 rounded">${member.role === 'admin' ? 'ูุฏูุฑ' : member.role === 'captain' ? 'ูุงุจุชู' : 'ูุชุฌุฑ'}</span></p>
                        <p class="text-[10px] text-gray-500">ID: ${member.workNumber} ${member.role==='captain'? `| ูุญูุธุฉ: <span class="text-green-600 font-bold">${(member.walletBalance||0).toFixed(2)}</span> | โญ ${avgRating}` : ''}</p>
                    </div>
                    <div class="flex gap-1 flex-col items-end">
                        ${member.role === 'captain' ? `<button onclick="openTopUpModal('${member.id}', ${member.walletBalance || 0})" class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold"><i class="fa-solid fa-plus"></i> ุดุญู</button>` : ''}
                        <button onclick="toggleBan('staff', '${member.id}', ${member.banned})" class="text-[9px] ${member.banned ? 'text-green-600' : 'text-red-500'} font-bold">${member.banned ? 'ูู ุงูุญุธุฑ' : 'ุญุธุฑ ๐ซ'}</button>
                    </div>
                </div>
            `}).join('');
        }
        
        function renderAdminFinance() {
            const list = document.getElementById('admin-points-requests');
            const pending = allPointRequests.filter(r => r.status === 'pending');
            if(pending.length === 0) { list.innerHTML = '<p class="text-xs text-gray-400 text-center py-4">ูุง ุชูุฌุฏ ุทูุจุงุช ุชุญููู ุฌุฏูุฏุฉ</p>'; return; }
            list.innerHTML = pending.map(r => `
                <div class="bg-white p-3 rounded-xl border border-yellow-200 shadow-sm flex justify-between items-center">
                    <div><p class="font-bold text-sm text-gray-800">${r.customerName}</p><p class="text-xs text-gray-500">ูุทูุจ ุชุญููู ${r.points} ููุทุฉ ูู ${r.money} ุฏููุงุฑ</p></div>
                    <div class="flex gap-1"><button onclick="approvePointRequest('${r.id}', '${r.customerId}')" class="bg-green-100 text-green-700 px-3 py-1.5 rounded text-xs font-bold">ููุงููุฉ</button><button onclick="rejectPointRequest('${r.id}')" class="bg-red-100 text-red-700 px-2 py-1.5 rounded text-xs font-bold"><i class="fa-solid fa-xmark"></i></button></div>
                </div>
            `).join('');
        }

    </script>
</body>
</html>